<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLBB Draft Tracker (Online)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn .2s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: none; } }
    .modal-open { overflow: hidden; } .scroll-thin { scrollbar-width: thin; }
    .inline-preview { width: 22px; height: 22px; border-radius: 6px; object-fit: cover; }
    .combo { position: relative; } .combo-list { position: absolute; z-index: 50; left: 0; right: 0; top: calc(100% + 6px); max-height: 360px; overflow-y: auto; background: white; border-radius: 14px; box-shadow: 0 12px 28px rgba(2,6,23,.18); border: 1px solid rgb(226 232 240); padding: 6px; }
    .combo-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-radius: 10px; font-size: 14px; }
    .combo-item:hover, .combo-item[aria-selected="true"] { background: rgb(248 250 252); } .combo-item img { width: 22px; height: 22px; border-radius: 6px; }
    body.dark { background-color: #0b1220; color: #e5e7eb; } .dark .bg-white { background-color: #111827 !important; }
    .dark .bg-slate-50 { background-color: #0f172a !important; } .dark .bg-slate-100 { background-color: #0b1220 !important; }
    .dark .text-slate-900 { color: #e5e7eb !important; } .dark .text-slate-600 { color: #94a3b8 !important; } .dark .text-slate-500 { color: #94a3b8 !important; } .dark .ring-slate-200 { box-shadow: none; border-color: rgba(148,163,184,.25) !important; }
    .dark .hover\:bg-slate-100:hover { background-color: #0b1220 !important; } .dark .combo-list { background: #0f172a; border-color: rgba(148,163,184,.25); }
    .dark .combo-item:hover, .dark .combo-item[aria-selected="true"] { background: #111827; }
    .dark .bg-slate-200 { background-color: #1f2937 !important; color: #e5e7eb !important; border-color: rgba(148,163,184,.25) !important; }
    .dark .hover\:bg-slate-300:hover { background-color: #374151 !important; }
    .dark .bg-rose-100 { background-color: rgba(159, 18, 57, 0.25) !important; }
    .dark .hover\:bg-slate-50:hover { background-color: #1e293b !important; }
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: rgba(0,0,0,0.05); }
    .dark .sortable:hover { background-color: rgba(255,255,255,0.05); }
    .sort-icon { display: inline-block; width: 1em; height: 1em; opacity: 0.3; margin-left: 4px; }
    .sorted .sort-icon { opacity: 1; color: #0ea5e9; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="auth-container" class="min-h-screen flex items-center justify-center hidden">
    <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg"><h1 class="text-2xl font-bold text-center mb-6">MLBB Draft Tracker</h1><div class="mb-4 flex justify-center border-b"><button id="show-login-btn" class="px-4 py-2 -mb-px border-b-2 border-slate-900 font-semibold">–í—Ö–æ–¥</button><button id="show-signup-btn" class="px-4 py-2 text-slate-500">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div><form id="loginForm"><div class="space-y-4"><input id="loginEmail" type="email" autocomplete="email" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="Email" required /><input id="loginPassword" type="password" autocomplete="current-password" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü–∞—Ä–æ–ª—å" required /><button type="submit" class="w-full px-3 py-3 rounded-xl bg-slate-900 text-white font-semibold">–í–æ–π—Ç–∏</button></div></form><form id="signupForm" class="hidden"><div class="space-y-4"><input id="signupEmail" type="email" autocomplete="email" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="Email" required /><input id="signupPassword" type="password" autocomplete="new-password" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" required /><button type="submit" class="w-full px-3 py-3 rounded-xl bg-slate-900 text-white font-semibold">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div><p class="text-xs text-slate-500 mt-4 text-center">–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å, –ø–æ–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –≤–∞–º –¥–æ—Å—Ç—É–ø.</p></form></div>
  </div>
  <div id="app-container" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <header class="flex items-center justify-between mb-6 flex-wrap gap-4"><h1 class="text-2xl font-bold tracking-tight">MLBB Draft Tracker</h1><div class="flex items-center gap-4 flex-wrap"><div id="admin-tools" class="hidden items-center gap-2"><button id="exportBtn" class="px-3 py-2 text-sm rounded-xl bg-slate-200">–≠–∫—Å–ø–æ—Ä—Ç JSON</button><label class="px-3 py-2 text-sm rounded-xl bg-slate-200 cursor-pointer">–ò–º–ø–æ—Ä—Ç JSON<input id="importInput" type="file" accept="application/json" class="hidden" /></label><button id="deleteAllBtn" class="px-3 py-2 text-sm rounded-xl bg-rose-600 text-white">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button></div><div id="userInfo" class="text-sm flex items-center gap-3"><span id="userEmail" class="text-slate-600"></span><button id="logoutBtn" class="px-3 py-2 rounded-xl bg-slate-200">–í—ã–π—Ç–∏</button></div><input id="imgBaseInput" class="hidden sm:block w-64 px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü–∞–ø–∫–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤: ./portraits/" /><button id="themeToggle" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300" title="–¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">üåô</button></div></header>
    <nav class="inline-flex rounded-2xl bg-white shadow ring-1 ring-slate-200 overflow-hidden mb-4"><button data-tab="stats" class="tab-btn px-4 py-2 text-sm font-medium bg-slate-900 text-white">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button><button data-tab="matches" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100">–ú–∞—Ç—á–∏</button><button id="inputTabBtn" data-tab="input" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 hidden">–í–≤–æ–¥ –º–∞—Ç—á–∞</button></nav>
    <section id="tab-input" class="hidden fade-in"><form id="matchForm" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–õ–∏–≥–∞</label><input name="league" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="MPL / MDL‚Ä¶" required /></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–ü–∞—Ç—á</label><input name="patch" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–Ω–∞–ø—Ä. 1.8.80" required /></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–î–∞—Ç–∞</label><input type="date" name="date" class="w-full px-3 py-2 rounded-xl bg-slate-100" /></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</label><div class="flex items-center gap-4 mt-2"><label class="inline-flex items-center gap-2"><input type="radio" name="winner" value="blue"/> –°–∏–Ω—è—è</label><label class="inline-flex items-center gap-2"><input type="radio" name="winner" value="red"/> –ö—Ä–∞—Å–Ω–∞—è</label></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><h2 class="font-semibold mb-2">–°–∏–Ω—è—è –∫–æ–º–∞–Ω–¥–∞</h2><input name="blueTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-3" placeholder="Blue Team" required /><div class="grid grid-cols-1 lg:grid-cols-2 gap-3"><div><div class="text-sm font-medium mb-1">–ë–∞–Ω—ã (5)</div><div id="blueBans" class="space-y-2"></div></div><div><div class="text-sm font-medium mb-1">–ü–∏–∫–∏ (5)</div><div id="bluePicks" class="space-y-2"></div></div></div></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><h2 class="font-semibold mb-2">–ö—Ä–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</h2><input name="redTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-3" placeholder="Red Team" required /><div class="grid grid-cols-1 lg:grid-cols-2 gap-3"><div><div class="text-sm font-medium mb-1">–ë–∞–Ω—ã (5)</div><div id="redBans" class="space-y-2"></div></div><div><div class="text-sm font-medium mb-1">–ü–∏–∫–∏ (5)</div><div id="redPicks" class="space-y-2"></div></div></div></div></div><div class="flex items-center gap-3"><button id="saveMatchBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á</button><button id="resetForm" class="px-4 py-2 rounded-xl bg-slate-200" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button><button id="cancelEditBtn" class="px-4 py-2 rounded-xl bg-amber-500 text-white hidden" type="button">–û—Ç–º–µ–Ω–∞</button></div></form></section>
    <section id="tab-stats" class="hidden fade-in"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 mb-4"><div class="grid grid-cols-1 md:grid-cols-6 gap-3"><div><label class="block text-xs font-medium mb-1">–õ–∏–≥–∞</label><select id="filterLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–ü–∞—Ç—á</label><select id="filterPatch" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–ö–æ–º–∞–Ω–¥–∞</label><select id="filterTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–°—Ç–æ—Ä–æ–Ω–∞</label><select id="filterSide" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–í—Å–µ</option><option value="blue">–°–∏–Ω—è—è</option><option value="red">–ö—Ä–∞—Å–Ω–∞—è</option></select></div><div><label class="block text-xs font-medium mb-1">–†–æ–ª—å</label><select id="filterRole" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–í—Å–µ —Ä–æ–ª–∏</option><option value="exp">EXP</option><option value="jungle">Jungle</option><option value="mid">Mid</option><option value="roam">Roam</option><option value="gold">Gold</option></select></div><div><label class="block text-xs font-medium mb-1">–ü–æ–∏—Å–∫ –≥–µ—Ä–æ—è</label><input id="searchHero" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" class="w-full px-3 py-2 rounded-xl bg-slate-100" /></div></div></div><div class="bg-white rounded-2xl shadow ring-1 ring-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-100 text-slate-600"><tr><th class="px-4 py-2 text-left sortable" data-sort="hero"><span>–ì–µ—Ä–æ–π</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable sorted" data-sort="presence"><span>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</span><span class="sort-icon">‚ñº</span></th><th class="px-4 py-2 text-right sortable" data-sort="picks"><span>–ò–≥—Ä</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="winrate"><span>–í–∏–Ω—Ä–µ–π—Ç</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="wins"><span>–ü–æ–±–µ–¥—ã</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="losses"><span>–ü–æ—Ä–∞–∂–µ–Ω–∏—è</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="bans"><span>–ë–∞–Ω—ã</span><span class="sort-icon"></span></th></tr></thead><tbody id="statsBody" class="divide-y divide-slate-100"></tbody></table></div><div class="p-3 text-xs text-slate-500">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–µ—Ä–æ—è –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.</div></div></section>
    <section id="tab-matches" class="hidden fade-in"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"><div><label class="block text-xs font-medium mb-1">–§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–∞–Ω–¥–µ</label><select id="filterMatchesTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–§–∏–ª—å—Ç—Ä –ø–æ –ª–∏–≥–µ</label><select id="filterMatchesLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–§–∏–ª—å—Ç—Ä –ø–æ –≥–µ—Ä–æ—é</label><select id="filterMatchesHero" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–¢–∏–ø —É—á–∞—Å—Ç–∏—è</label><select id="filterMatchesType" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="presence">–ü–∏–∫–∏ –∏ –ë–∞–Ω—ã</option><option value="pick">–¢–æ–ª—å–∫–æ –ø–∏–∫–∏</option></select></div></div><div id="matchesList" class="grid gap-3"></div></div></section>
  </div>
  <div id="heroModal" class="fixed inset-0 bg-black/40 z-50 hidden"><div class="min-h-full w-full flex items-center justify-center p-4"><div class="bg-white w-full max-w-4xl rounded-2xl shadow-xl ring-1 ring-slate-200 overflow-hidden"><div class="flex items-center justify-between px-5 py-3 border-b"><div><h3 id="modalHeroName" class="text-lg font-semibold"></h3><p id="modalHeroSubtitle" class="text-xs text-slate-500"></p></div><button id="closeModal" class="p-2 rounded-lg hover:bg-slate-100">‚úï</button></div><div class="p-5 space-y-6 max-h-[75vh] overflow-y-auto scroll-thin"><div class="grid grid-cols-1 md:grid-cols-3 gap-3"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-1">–û–±—â–µ–µ</div><div id="modalSummary" class="text-sm"></div></div><div class="bg-slate-50 rounded-xl p-4 md:col-span-2"><div class="text-xs text-slate-500 mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è–º</div><div id="modalRoles" class="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–¢–æ–ø‚Äë10 —Å–∏–Ω–µ—Ä–≥–∏–π (—Å–æ—é–∑–Ω–∏–∫–∏)</div><div id="modalSynergy" class="text-sm space-y-1"></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ú–∞—Ç—á–∞–ø—ã</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-3 text-sm"><div><div class="font-medium mb-1">–õ—É—á—à–µ –ø—Ä–æ—Ç–∏–≤</div><div id="modalBestVs" class="space-y-1"></div></div><div><div class="font-medium mb-1">–°–ª–æ–∂–Ω–æ –ø—Ä–æ—Ç–∏–≤</div><div id="modalWorstVs" class="space-y-1"></div></div></div></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ü–æ–∑–∏—Ü–∏–∏ –≤ –¥—Ä–∞—Ñ—Ç–µ</div><div id="modalDraftPositions" class="text-sm grid grid-cols-2 lg:grid-cols-4 gap-2"></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏ (–ø–∏–∫–∏)</div><div id="modalTeams" class="text-sm space-y-1"></div></div></div></div></div></div>
  <template id="banRowTpl"><div class="flex items-center gap-2"><div class="w-10 text-xs text-slate-500">#<span class="ord"></span></div><div class="combo flex-1"><input class="banHero w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ì–µ—Ä–æ–π" /><div class="combo-list hidden"></div></div></div></template>
  <template id="pickRowTpl"><div class="flex items-center gap-2"><div class="w-10 text-xs text-slate-500">#<span class="ord"></span></div><div class="combo flex-1"><input class="pickHero w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ì–µ—Ä–æ–π" /><div class="combo-list hidden"></div></div><select class="pickRole w-28 px-2 py-2 rounded-xl bg-slate-100 text-sm"><option value="">–†–æ–ª—å‚Ä¶</option><option value="exp">EXP</option><option value="jungle">Jungle</option><option value="mid">Mid</option><option value="roam">Roam</option><option value="gold">Gold</option></select></div></template>
  
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  document.addEventListener('DOMContentLoaded', async () => {

    const SUPABASE_URL = 'https://fsrhkwyyedkxmlooddjn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzcmhrd3l5ZWRreG1sb29kZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NzQ4NTUsImV4cCI6MjA3MjA1MDg1NX0.JlftKlupkTtFBIkXdWNL-DigdFRc9DVAP48VXmh3fgg';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let allMatches = [];
    let currentUser = null;
    let currentUserRole = 'user';
    let sortState = { key: 'presence', direction: 'desc' };
    let editingMatchId = null;
    
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const showLoginBtn = document.getElementById('show-login-btn');
    const showSignupBtn = document.getElementById('show-signup-btn');
    const userEmailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const inputTabBtn = document.getElementById('inputTabBtn');
    const themeToggle = document.getElementById('themeToggle');
    const imgBaseInput = document.getElementById('imgBaseInput');
    const adminTools = document.getElementById('admin-tools');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const banRowTpl = document.getElementById('banRowTpl'); 
    const pickRowTpl = document.getElementById('pickRowTpl');
    const blueBansEl = document.getElementById('blueBans'); 
    const redBansEl = document.getElementById('redBans');
    const bluePicksEl = document.getElementById('bluePicks'); 
    const redPicksEl = document.getElementById('redPicks');
    const matchesListEl = document.getElementById('matchesList');
    const filterLeague=document.getElementById('filterLeague'), filterPatch=document.getElementById('filterPatch'), filterTeam=document.getElementById('filterTeam'), filterSide=document.getElementById('filterSide'), filterRole=document.getElementById('filterRole'), searchHero=document.getElementById('searchHero'), statsBody=document.getElementById('statsBody');
    const heroModal=document.getElementById('heroModal');
    const filterMatchesTeam = document.getElementById('filterMatchesTeam');
    const filterMatchesLeague = document.getElementById('filterMatchesLeague');
    const filterMatchesHero = document.getElementById('filterMatchesHero');
    const filterMatchesType = document.getElementById('filterMatchesType');
    const saveMatchBtn = document.getElementById('saveMatchBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const matchForm = document.getElementById('matchForm');

    const HEROES = ["Aamon","Akai","Aldous","Alice","Alpha","Alucard","Angela","Argus","Arlott","Atlas","Aulus","Aurora","Badang","Balmond","Bane","Barats","Baxia","Beatrix","Belerick","Benedetta","Brody","Bruno","Carmilla","Cecilion","Chang'e","Chip","Chou","Cici","Claude","Clint","Cyclops","Diggie","Dyrroth","Edith","Esmeralda","Estes","Eudora","Fanny","Faramis","Floryn","Franco","Fredrinn","Freya","Gatotkaca","Gloo","Gord","Granger","Grock","Guinevere","Gusion","Hanabi","Hanzo","Harith","Harley","Hayabusa","Helcurt","Hilda","Hylos","Irithel","Ixia","Jawhead","Johnson","Joy","Julian","Kadita","Kagura","Kaja","Kalea","Karina","Karrie","Khaleed","Khufra","Kimmy","Lancelot","Lapu-Lapu","Layla","Leomord","Lesley","Ling","Lolita","Lukas","Lunox","Luo Yi","Lylia","Martis","Masha","Mathilda","Melissa","Minotaur","Minsitthar","Miya","Moskov","Nana","Natalia","Natan","Nolan","Novaria","Odette","Paquito","Pharsa","Phoveus","Popol and Kupa","Rafaela","Roger","Ruby","Saber","Selena","Silvanna","Sun","Suyou","Terizla","Thamuz","Tigreal","Uranus","Vale","Valentina","Valir","Vexana","Wanwan","X.Borg","Xavier","Yi Sun-shin","Yin","Yu Zhong","Yve","Zetian","Zhask","Zhuxin","Zilong"];
    const LS_IMG = 'mlbb_portraits_base_v1';
    const LS_FORM = 'mlbb_draft_form_v1';

    const showLoader = () => { if (!document.getElementById('loader')) { document.body.insertAdjacentHTML('beforeend', '<div id="loader" style="backdrop-filter: blur(4px);" class="fixed inset-0 bg-slate-50/70 flex items-center justify-center z-50"><p class="text-lg font-medium">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>'); } };
    const hideLoader = () => { document.getElementById('loader')?.remove(); };

    const fetchUserProfile = async (user) => {
      if (!user) return 'user';
      const { data, error } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (error) { console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error.message); return 'user'; }
      return data ? data.role : 'user';
    };

    const fetchMatches = async () => {
        const { data, error } = await supabase.from('matches').select('*').order('created_at', { ascending: false });
        if (error) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π:', error); return []; }
        return data.map(m => ({ id: m.id, date: m.date, league: m.league, patch: m.patch, winner: m.winner, blue: { team: m.blue_team, picks: m.blue_picks || [], bans: m.blue_bans || [] }, red: { team: m.red_team, picks: m.red_picks || [], bans: m.red_bans || [] } }));
    };

    const handleSessionChange = async (session, event) => {
        showLoader();
        currentUser = session?.user ?? null;
        currentUserRole = await fetchUserProfile(currentUser);

        if (currentUser && (currentUserRole === 'admin' || currentUserRole === 'viewer')) {
            if (allMatches.length === 0) {
                allMatches = await fetchMatches();
            }
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userEmailEl.textContent = currentUser.email;
            if (currentUserRole === 'admin') {
                inputTabBtn.classList.remove('hidden');
                adminTools.classList.remove('hidden');
                adminTools.classList.add('flex');
            } else {
                inputTabBtn.classList.add('hidden');
                adminTools.classList.add('hidden');
                adminTools.classList.remove('flex');
            }
        } else {
            allMatches = [];
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (currentUser && event === 'SIGNED_IN') {
                alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
                await supabase.auth.signOut();
            }
        }
        refreshUI();
        hideLoader();
    };
    
    (function initializeStaticElements() {
        const THEME_KEY = 'mlbb_theme';
        const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
        if (savedTheme === 'dark') document.body.classList.add('dark');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            localStorage.setItem(THEME_KEY, document.body.classList.contains('dark') ? 'dark' : 'light');
        });
        imgBaseInput.value = getImgBase();
        imgBaseInput.addEventListener('change', () => setImgBase(imgBaseInput.value.trim() || './portraits/'));
        const initialDraft = readFormDraft();
        if (initialDraft) { applyFormDraft(initialDraft);
        } else { buildRows(blueBansEl, banRowTpl, 5); buildRows(redBansEl, banRowTpl, 5); buildRows(bluePicksEl, pickRowTpl, 5); buildRows(redPicksEl, pickRowTpl, 5); }
        showLoginBtn.addEventListener('click', () => {
            loginForm.classList.remove('hidden'); signupForm.classList.add('hidden');
            showLoginBtn.classList.add('border-slate-900', 'font-semibold'); showLoginBtn.classList.remove('text-slate-500');
            showSignupBtn.classList.remove('border-slate-900', 'font-semibold'); showSignupBtn.classList.add('text-slate-500');
        });
        showSignupBtn.addEventListener('click', () => {
            signupForm.classList.remove('hidden'); loginForm.classList.add('hidden');
            showSignupBtn.classList.add('border-slate-900', 'font-semibold'); showSignupBtn.classList.remove('text-slate-500');
            showLoginBtn.classList.remove('border-slate-900', 'font-semibold'); showLoginBtn.classList.add('text-slate-500');
        });
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) { alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            } else { alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∞ –∑–∞—Ç–µ–º –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.'); signupForm.reset(); showLoginBtn.click(); }
        });
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message); }
        });
        logoutBtn.addEventListener('click', async () => { await supabase.auth.signOut(); });
        document.getElementById('closeModal').onclick = () => heroModal.classList.add('hidden');
        heroModal.addEventListener('click', e => { if (e.target === heroModal) heroModal.classList.add('hidden'); });
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortState.key === key) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.key = key;
                    sortState.direction = 'desc';
                }
                renderStats();
            });
        });
        filterMatchesTeam.addEventListener('input', renderFilteredMatches);
        filterMatchesLeague.addEventListener('input', renderFilteredMatches);
        filterMatchesHero.addEventListener('input', renderFilteredMatches);
        filterMatchesType.addEventListener('input', renderFilteredMatches);
        [filterLeague,filterPatch,filterTeam,filterSide,filterRole,searchHero].forEach(el=> el.addEventListener('input', renderStats));
        cancelEditBtn.addEventListener('click', cancelEditMatch);
        exportBtn.addEventListener('click', exportMatches);
        importInput.addEventListener('change', importMatches);
        deleteAllBtn.addEventListener('click', deleteAllMatches);
    })();

    supabase.auth.onAuthStateChange((event, session) => { handleSessionChange(session, event); });
    
    function getImgBase(){ return localStorage.getItem(LS_IMG) || './portraits/'; }
    function setImgBase(v){ localStorage.setItem(LS_IMG, v); }
    function heroSlug(name){ return name.replace(/\./g,'_').replace(/'/g,'').replace(/\s+/g,'_').toLowerCase(); }
    function heroImg(name){ return getImgBase() + heroSlug(name) + '.png'; }
    function getCanonicalHero(name){ if(!name) return ''; const n=name.trim().toLowerCase(); return HEROES.find(h=>h.toLowerCase()===n) || ''; }
    function normalizeHero(name){ return getCanonicalHero(name) || ''; }
    function pct(n,d){ return d? (100*n/d):0; }
    function fmtPct(v){ return isFinite(v)? v.toFixed(1)+'%':'‚Äî'; }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    async function deleteMatch(id) { if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç—á?')) return; showLoader(); const { error } = await supabase.from('matches').delete().eq('id', id); hideLoader(); if (error) { console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; } allMatches = allMatches.filter(m => m.id !== id); refreshUI(); alert('–ú–∞—Ç—á —É–¥–∞–ª–µ–Ω.'); }
    const tabs = { input: document.getElementById('tab-input'), stats: document.getElementById('tab-stats'), matches: document.getElementById('tab-matches') };
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => { btn.addEventListener('click', () => { if (btn.id === 'inputTabBtn' && currentUserRole !== 'admin') return; tabBtns.forEach(b => b.classList.remove('bg-slate-900', 'text-white')); btn.classList.add('bg-slate-900', 'text-white'); const key = btn.dataset.tab; Object.entries(tabs).forEach(([k, el]) => el.classList.toggle('hidden', k !== key)); if (key === 'stats') rebuildFiltersAndStats(allMatches); if (key === 'matches') renderFilteredMatches(); }); });
    function attachCombobox(wrapper, inputEl){ const list = wrapper.querySelector('.combo-list'); let active = -1; function produce(q){ const qq=(q||'').trim().toLowerCase(); let items = HEROES; if (qq){ const starts = HEROES.filter(h => h.toLowerCase().startsWith(qq)); items = starts.length ? starts : HEROES.filter(h => h.toLowerCase().includes(qq)); } return items.slice(0,100); } function render(q){ const items = produce(q); if(!items.length){ list.classList.add('hidden'); list.innerHTML=''; return; } list.innerHTML = items.map((h,i)=>`<div class="combo-item" data-idx="${i}" data-value="${h}"><img src="${heroImg(h)}" alt=""/><span>${h}</span></div>`).join(''); list.classList.remove('hidden'); active=-1; list.querySelectorAll('.combo-item').forEach(div=>{ div.addEventListener('click',()=>{ inputEl.value=div.dataset.value; list.classList.add('hidden'); saveDraftDebounced(); }); }); } function moveActive(delta){ const items=[...list.querySelectorAll('.combo-item')]; if(!items.length) return; active=(active+delta+items.length)%items.length; items.forEach((el,i)=> el.setAttribute('aria-selected', i===active?'true':'false')); items[active].scrollIntoView({block:'nearest'}); } inputEl.addEventListener('keydown',(e)=>{ if(list.classList.contains('hidden')) return; if(e.key==='ArrowDown'){e.preventDefault();moveActive(1);} if(e.key==='ArrowUp'){e.preventDefault();moveActive(-1);} if(e.key==='Enter'&&active>=0){e.preventDefault();const el=list.querySelectorAll('.combo-item')[active]; if(el){ inputEl.value=el.dataset.value; list.classList.add('hidden'); saveDraftDebounced(); }} if(e.key==='Escape'){ list.classList.add('hidden'); }}); inputEl.addEventListener('input', ()=> render(inputEl.value)); inputEl.addEventListener('focus', ()=> render(inputEl.value)); inputEl.addEventListener('blur', ()=> setTimeout(()=>list.classList.add('hidden'), 150)); }
    function buildRows(container, tpl, count, prefill=[]) { container.innerHTML=''; for(let i=1;i<=count;i++){ const node = tpl.content.cloneNode(true); node.querySelector('.ord').textContent = i; const input = node.querySelector('input'); attachCombobox(node.querySelector('.combo'), input); const item = prefill[i-1]; if (item && item.hero) { input.value = item.hero; const roleSel = node.querySelector('select.pickRole'); if (roleSel && item.role) roleSel.value = item.role; } container.appendChild(node); } }
    function readFormDraft(){ try { return JSON.parse(localStorage.getItem(LS_FORM)) || null; } catch { return null; } }
    function writeFormDraft(d){ localStorage.setItem(LS_FORM, JSON.stringify(d)); }
    function getFormData(){ const f=matchForm; function collectFrom(container){ return Array.from(container.querySelectorAll('.flex.items-center')).map((row,idx)=>{ const hero = normalizeHero(row.querySelector('input')?.value||''); if(!hero) return null; const obj = {hero, order: idx+1}; const roleSel=row.querySelector('select.pickRole'); if(roleSel) obj.role = roleSel.value||''; return obj; }).filter(Boolean); } return { league: f.league.value.trim(), patch: f.patch.value.trim(), date: f.date.value || null, winner: (f.winner.value||''), blue_team: f.blueTeam.value.trim(), red_team: f.redTeam.value.trim(), blue_bans: collectFrom(blueBansEl, 'bans'), blue_picks: collectFrom(bluePicksEl, 'picks'), red_bans: collectFrom(redBansEl, 'bans'), red_picks: collectFrom(redPicksEl, 'picks')}; }
    function applyFormDraft(d){ if(!d) return; const f=matchForm; f.league.value=d.league||''; f.patch.value=d.patch||''; f.date.value=d.date||''; f.blueTeam.value=d.blueTeam||''; f.redTeam.value=d.redTeam||''; if(d.winner){ const wEls=f.querySelectorAll('input[name=winner]'); wEls.forEach(el=> el.checked = (el.value===d.winner)); } else { f.querySelectorAll('input[name=winner]').forEach(el=> el.checked=false); } buildRows(blueBansEl, banRowTpl, 5, d.blue?.bans||[]); buildRows(redBansEl,  banRowTpl, 5, d.red?.bans||[]); buildRows(bluePicksEl, pickRowTpl, 5, d.blue?.picks||[]); buildRows(redPicksEl,  pickRowTpl, 5, d.red?.picks||[]); }
    const saveDraftDebounced = debounce(()=> writeFormDraft(getFormData()), 250);
    document.addEventListener('input', (e)=>{ const form = document.getElementById('matchForm'); if (form && form.contains(e.target)) saveDraftDebounced(); });
    document.addEventListener('change', (e)=>{ const form = document.getElementById('matchForm'); if (form && form.contains(e.target)) saveDraftDebounced(); });
    document.getElementById('resetForm').addEventListener('click', () => { const keep = readFormDraft() || {}; keep.blue = {bans:[], picks:[]}; keep.red = {bans:[], picks:[]}; keep.winner=''; writeFormDraft(keep); applyFormDraft(keep); if(editingMatchId) cancelEditMatch(); });
    function startEditMatch(matchId) { const match = allMatches.find(m => m.id === matchId); if (!match) return; editingMatchId = matchId; matchForm.league.value = match.league; matchForm.patch.value = match.patch; matchForm.date.value = match.date; matchForm.blueTeam.value = match.blue.team; matchForm.redTeam.value = match.red.team; const winnerRadio = matchForm.querySelector(`input[name="winner"][value="${match.winner}"]`); if (winnerRadio) winnerRadio.checked = true; else {matchForm.querySelectorAll('input[name=winner]').forEach(el => el.checked = false)} buildRows(blueBansEl, banRowTpl, 5, match.blue.bans); buildRows(redBansEl, banRowTpl, 5, match.red.bans); buildRows(bluePicksEl, pickRowTpl, 5, match.blue.picks); buildRows(redPicksEl, pickRowTpl, 5, match.red.picks); saveMatchBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç—á'; cancelEditBtn.classList.remove('hidden'); document.querySelector('[data-tab="input"]').click(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function cancelEditMatch() { editingMatchId = null; document.getElementById('resetForm').click(); saveMatchBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á'; cancelEditBtn.classList.add('hidden'); }
    matchForm.addEventListener('submit', async (e) => { e.preventDefault(); if (currentUserRole !== 'admin') { alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–∞—Ç—á–∏.'); return; } const matchDataForDB = getFormData(); if (!matchDataForDB.blue_team || !matchDataForDB.red_team) return alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥.'); if (!matchDataForDB.league || !matchDataForDB.patch) return alert('–õ–∏–≥–∞ –∏ –ø–∞—Ç—á –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.'); if (!matchDataForDB.winner) return alert('–£–∫–∞–∂–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.'); showLoader(); if (editingMatchId) { const { data, error } = await supabase.from('matches').update(matchDataForDB).eq('id', editingMatchId).select().single(); hideLoader(); if (error) { console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ç—á–∞:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; } alert('–ú–∞—Ç—á —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!'); const updatedMatch = { id: data.id, date: data.date, league: data.league, patch: data.patch, winner: data.winner, blue: { team: data.blue_team, picks: data.blue_picks, bans: data.blue_bans }, red: { team: data.red_team, picks: data.red_picks, bans: data.red_bans } }; allMatches = allMatches.map(m => m.id === editingMatchId ? updatedMatch : m); cancelEditMatch(); refreshUI(); document.querySelector('[data-tab="matches"]').click(); } else { const { data, error } = await supabase.from('matches').insert([matchDataForDB]).select().single(); hideLoader(); if (error) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç—á–∞:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; } alert('–ú–∞—Ç—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω!'); const newMatch = { id: data.id, date: data.date, league: data.league, patch: data.patch, winner: data.winner, blue: { team: data.blue_team, picks: data.blue_picks, bans: data.blue_bans }, red: { team: data.red_team, picks: data.red_picks, bans: data.red_bans } }; allMatches.unshift(newMatch); const keep = { ...readFormDraft(), blue:{bans:[],picks:[]}, red:{bans:[],picks:[]}, winner:'' }; writeFormDraft(keep); applyFormDraft(keep); refreshUI(); } });
    async function exportMatches() { showLoader(); const { data, error } = await supabase.from('matches').select('*').order('created_at'); hideLoader(); if (error) { return alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message); } const matchesToExport = data.map(m => ({ id: m.id, date: m.date, league: m.league, patch: m.patch, winner: m.winner, blue: { team: m.blue_team, picks: m.blue_picks || [], bans: m.blue_bans || [] }, red: { team: m.red_team, picks: m.red_picks || [], bans: m.red_bans || [] } })); const jsonData = JSON.stringify({ matches: matchesToExport }, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mlbb_draft_data_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); }
    async function importMatches(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const data = JSON.parse(e.target.result); if (!data.matches || !Array.isArray(data.matches)) { throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å—Å–∏–≤ "matches".'); } if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${data.matches.length} –º–∞—Ç—á–µ–π?`)) { return; } showLoader(); const matchesToInsert = data.matches.map(m => ({ date: m.date, league: m.league, patch: m.patch, winner: m.winner, blue_team: m.blue.team, red_team: m.red.team, blue_picks: m.blue.picks, blue_bans: m.blue.bans, red_picks: m.red.picks, red_bans: m.red.bans })); const { error } = await supabase.from('matches').insert(matchesToInsert); hideLoader(); if (error) { throw new Error(error.message); } alert(`–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${matchesToInsert.length} –º–∞—Ç—á–µ–π! –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`); allMatches = await fetchMatches(); refreshUI(); } catch (err) { hideLoader(); alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message); } finally { importInput.value = ''; } }; reader.readAsText(file); }
    async function deleteAllMatches() { const confirmation = prompt('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –º–∞—Ç—á–µ–π, –≤–≤–µ–¥–∏—Ç–µ "—É–¥–∞–ª–∏—Ç—å –≤—Å–µ" –≤ –ø–æ–ª–µ –Ω–∏–∂–µ:'); if (confirmation !== '—É–¥–∞–ª–∏—Ç—å –≤—Å–µ') { alert('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.'); return; } showLoader(); const { error } = await supabase.from('matches').delete().neq('id', '00000000-0000-0000-0000-000000000000'); hideLoader(); if (error) { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message); return; } alert('–í—Å–µ –º–∞—Ç—á–∏ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.'); allMatches = []; refreshUI(); }
    function heroChip(name){ return `<span class='inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100'><img src='${heroImg(name)}' class='inline-preview'/>${name}</span>`; }
    function heroChipBan(name){ return `<span class='inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-rose-100 dark:bg-rose-900/50 text-slate-700 dark:text-slate-300 line-through'><img src='${heroImg(name)}' class='inline-preview opacity-60'/>${name}</span>`; }
    function matchCardHTML(m){ const isAdmin = currentUserRole === 'admin'; const adminButtonsHTML = isAdmin ? `<div class="flex items-center gap-2"><button data-action='edit' data-id='${m.id}' class='px-3 py-1.5 text-sm rounded-xl bg-sky-600 text-white'>–†–µ–¥–∞–∫—Ç.</button><button data-action='del' data-id='${m.id}' class='px-3 py-1.5 text-sm rounded-xl bg-rose-600 text-white'>–£–¥–∞–ª–∏—Ç—å</button></div>` : ''; return `<div class='rounded-2xl ring-1 ring-slate-200 bg-white p-4'><div class='flex items-center justify-between gap-2'><div><div class='text-xs text-slate-500'>${m.league} ‚Ä¢ –ü–∞—Ç—á ${m.patch} ‚Ä¢ ${m.date||'‚Äî'}</div><div class='font-medium mt-1'>${m.blue.team} <span class='text-xs ${m.winner==='blue'?'text-emerald-600':'text-slate-400'}'>${m.winner==='blue'?'(W)':''}</span> ‚Äî ${m.red.team} <span class='text-xs ${m.winner==='red'?'text-emerald-600':'text-slate-400'}'>${m.winner==='red'?'(W)':''}</span></div></div>${adminButtonsHTML}</div><div class='mt-3 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 text-sm'><div class='space-y-2'><div class='text-xs text-slate-500'>–°–∏–Ω—è—è –∫–æ–º–∞–Ω–¥–∞</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.blue.bans.map(x=>heroChipBan(x.hero)).join('')}</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.blue.picks.map(x=>heroChip(x.hero)).join('')}</div></div><div class='space-y-2'><div class='text-xs text-slate-500'>–ö—Ä–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.red.bans.map(x=>heroChipBan(x.hero)).join('')}</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.red.picks.map(x=>heroChip(x.hero)).join('')}</div></div></div></div>`; }
    function refreshMatchesList(matches) { if (!matches || !matches.length) { matchesListEl.innerHTML='<div class="text-sm text-slate-500 text-center py-4">–ú–∞—Ç—á–µ–π –ø–æ —ç—Ç–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>'; return; } matchesListEl.innerHTML = matches.map(matchCardHTML).join(''); matchesListEl.querySelectorAll('[data-action=del]')?.forEach(b => { b.onclick = () => deleteMatch(b.dataset.id); }); matchesListEl.querySelectorAll('[data-action=edit]')?.forEach(b => { b.onclick = () => startEditMatch(b.dataset.id); }); }
    function renderFilteredMatches() { const selectedTeam = filterMatchesTeam.value; const selectedLeague = filterMatchesLeague.value; const selectedHero = filterMatchesHero.value; const selectedType = filterMatchesType.value; let filtered = allMatches; if (selectedTeam) { filtered = filtered.filter(m => m.blue.team === selectedTeam || m.red.team === selectedTeam); } if (selectedLeague) { filtered = filtered.filter(m => m.league === selectedLeague); } if (selectedHero) { if (selectedType === 'pick') { filtered = filtered.filter(m => m.blue.picks.some(p => p.hero === selectedHero) || m.red.picks.some(p => p.hero === selectedHero)); } else { filtered = filtered.filter(m => m.blue.picks.some(p => p.hero === selectedHero) || m.red.picks.some(p => p.hero === selectedHero) || m.blue.bans.some(b => b.hero === selectedHero) || m.red.bans.some(b => b.hero === selectedHero)); } } refreshMatchesList(filtered); }
    function collectFilters(matches){ const teams=new Set(); matches.forEach(m=>{ if(m.blue?.team)teams.add(m.blue.team); if(m.red?.team)teams.add(m.red.team); }); const leagues=new Set(matches.map(m=>m.league).filter(Boolean)); const patches=new Set(matches.map(m=>m.patch).filter(Boolean)); return { leagues:['–í—Å–µ',...leagues].sort(), patches:['–í—Å–µ',...patches].sort(), teams:['–í—Å–µ',...teams].sort() }; }
    function setOptions(sel,arr){ const cur=sel.value; sel.innerHTML=arr.map(v=>`<option value='${v==='–í—Å–µ'?'':v}'>${v}</option>`).join(''); if(Array.from(sel.options).some(o=>o.value===cur)) sel.value = cur; }
    function applyFilters(matches, {league,patch,team,side}){ let filteredMatches = [...matches]; if (league) { filteredMatches = filteredMatches.filter(m => m.league === league); } if (patch) { filteredMatches = filteredMatches.filter(m => m.patch === patch); } if (team) { filteredMatches = filteredMatches.filter(m => m.blue.team === team || m.red.team === team); } if (side && team) { if (side === 'blue') { filteredMatches = filteredMatches.filter(m => m.blue.team === team); } if (side === 'red') { filteredMatches = filteredMatches.filter(m => m.red.team === team); } } return filteredMatches; }
    function aggregate(matches, filters) { const map=new Map(); function ens(h){ if(!map.has(h)) map.set(h,{hero:h,picks:0,wins:0,losses:0,bans:0,presence:0,roles:{}}); return map.get(h); } matches.forEach(m => { const processPick = (pick, isWin) => { const s = ens(pick.hero); s.picks++; s.presence++; if (isWin) s.wins++; else s.losses++; if (pick.role) { if (!s.roles[pick.role]) s.roles[pick.role] = { picks: 0, wins: 0 }; s.roles[pick.role].picks++; if (isWin) s.roles[pick.role].wins++; } }; const processBan = (ban) => { const s = ens(ban.hero); s.bans++; s.presence++; }; const shouldProcessBlue = (!filters.side || filters.side === 'blue') && (!filters.team || m.blue.team === filters.team); const shouldProcessRed = (!filters.side || filters.side === 'red') && (!filters.team || m.red.team === filters.team); if (shouldProcessBlue) { m.blue.picks.forEach(p => processPick(p, m.winner === 'blue')); m.blue.bans.forEach(b => processBan(b)); } if (shouldProcessRed) { m.red.picks.forEach(p => processPick(p, m.winner === 'red')); m.red.bans.forEach(b => processBan(b)); } }); return Array.from(map.values()); }
    function updateSortIcons() { document.querySelectorAll('th.sortable').forEach(th => { const icon = th.querySelector('.sort-icon'); if (th.dataset.sort === sortState.key) { th.classList.add('sorted'); icon.innerHTML = sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº'; } else { th.classList.remove('sorted'); icon.innerHTML = ''; } }); }
    function renderStats(){ const filters= {league:filterLeague.value||'', patch:filterPatch.value||'', team:filterTeam.value||'', side:filterSide.value||''}; const selectedRole = filterRole.value; const matches=applyFilters(allMatches, filters); let statsData = aggregate(matches, filters); if (selectedRole) { statsData = statsData.filter(heroStats => heroStats.roles[selectedRole]).map(heroStats => { const roleStats = heroStats.roles[selectedRole]; return { ...heroStats, picks: roleStats.picks, wins: roleStats.wins, losses: roleStats.picks - roleStats.wins, }; }); } let rows = statsData.map(r => ({ ...r, winrate: r.picks > 0 ? (r.wins / r.picks) : -1 })); rows.sort((a, b) => { const key = sortState.key; let valA = a[key]; let valB = b[key]; if (key === 'hero') { return sortState.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); } return sortState.direction === 'asc' ? valA - valB : valB - valA; }); statsBody.innerHTML = rows.map(r=>{ const wr = r.picks ? fmtPct(pct(r.wins, r.picks)) : '‚Äî'; return `<tr class='hover:bg-slate-50 cursor-pointer' data-hero='${r.hero}'><td class='px-4 py-2'><div class='flex items-center gap-2'><img src='${heroImg(r.hero)}' class='inline-preview'/>${r.hero}</div></td><td class='px-4 py-2 text-right font-medium'>${r.presence}</td><td class='px-4 py-2 text-right'>${r.picks}</td><td class='px-4 py-2 text-right'>${wr}</td><td class='px-4 py-2 text-right text-emerald-600'>${r.wins}</td><td class='px-4 py-2 text-right text-rose-600'>${r.losses}</td><td class='px-4 py-2 text-right'>${r.bans}</td></tr>`; }).join(''); statsBody.querySelectorAll('tr[data-hero]')?.forEach(tr=> tr.addEventListener('click', ()=> openHeroModal(tr.dataset.hero, matches, filters))); updateSortIcons(); }
    function rebuildFiltersAndStats(matches){ const f=collectFilters(matches); const allHeroesSorted = ['–í—Å–µ', ...HEROES.sort()]; setOptions(filterLeague,f.leagues); setOptions(filterPatch,f.patches); setOptions(filterTeam,f.teams); setOptions(filterMatchesTeam, f.teams); setOptions(filterMatchesLeague, f.leagues); setOptions(filterMatchesHero, allHeroesSorted); renderStats(); renderFilteredMatches(); }
    function topN(map,n,{best=true,minGames=5}={}){ const arr=[...map.entries()].map(([name,o])=>({name, games:o.games, wins:o.wins, wr:o.games?o.wins*100/o.games:0})).filter(x=>x.games>=minGames).sort((a,b)=> best? (b.wr-a.wr||b.games-a.games):(a.wr-b.wr||b.games-a.games)); return arr.slice(0,n); }
    function calcTeamStatsForHero(hero, matches) { const teamStats = new Map(); function processTeam(team, isWin) { if (!teamStats.has(team)) { teamStats.set(team, { games: 0, wins: 0 }); } const stats = teamStats.get(team); stats.games++; if (isWin) { stats.wins++; } } matches.forEach(m => { if (m.blue.picks.some(p => p.hero === hero)) { processTeam(m.blue.team, m.winner === 'blue'); } if (m.red.picks.some(p => p.hero === hero)) { processTeam(m.red.team, m.winner === 'red'); } }); return Array.from(teamStats.entries()).map(([team, stats]) => ({ name: team, games: stats.games, wins: stats.wins, wr: pct(stats.wins, stats.games) })).sort((a, b) => b.games - a.games || b.wr - a.wr); }
    function calcHeroDetails(hero, matches, filters = {}){ const d={hero, picks:0,wins:0,losses:0,bans:0, roles:new Map(), synergy:new Map(), vs:new Map(), draft:{pick:new Map(),ban:new Map()}}; const targetTeam = filters.team || null; function inc(map,key,win){ if(!map.has(key)) map.set(key,{games:0,wins:0}); const o=map.get(key); o.games++; if(win) o.wins++; } matches.forEach(m => { const winBlue = m.winner === 'blue'; const bluePicksHero = m.blue.picks.some(p => p.hero === hero); const redPicksHero = m.red.picks.some(p => p.hero === hero); if (bluePicksHero && (!targetTeam || m.blue.team === targetTeam)) { d.picks++; if (winBlue) d.wins++; else d.losses++; const pick = m.blue.picks.find(p => p.hero === hero); if (pick.role) { const rs = d.roles.get(pick.role) || {games:0,wins:0}; rs.games++; if (winBlue) rs.wins++; d.roles.set(pick.role, rs); } d.draft.pick.set(`B${pick.order}`,(d.draft.pick.get(`B${pick.order}`)||0)+1); } if (redPicksHero && (!targetTeam || m.red.team === targetTeam)) { d.picks++; if (!winBlue) d.wins++; else d.losses++; const pick = m.red.picks.find(p => p.hero === hero); if (pick.role) { const rs = d.roles.get(pick.role) || {games:0,wins:0}; rs.games++; if (!winBlue) rs.wins++; d.roles.set(pick.role, rs); } d.draft.pick.set(`R${pick.order}`,(d.draft.pick.get(`R${pick.order}`)||0)+1); } if (!targetTeam || m.blue.team === targetTeam) { m.blue.bans.forEach(b => { if(b.hero === hero){ d.bans++; d.draft.ban.set(`B${b.order}`,(d.draft.ban.get(`B${b.order}`)||0)+1);} }); } if (!targetTeam || m.red.team === targetTeam) { m.red.bans.forEach(b => { if(b.hero === hero){ d.bans++; d.draft.ban.set(`R${b.order}`,(d.draft.ban.get(`R${b.order}`)||0)+1);} }); } if (bluePicksHero && (!targetTeam || m.blue.team === targetTeam)) { m.blue.picks.filter(x => x.hero !== hero).forEach(a => inc(d.synergy, a.hero, winBlue)); m.red.picks.forEach(e => inc(d.vs, e.hero, winBlue)); } if (redPicksHero && (!targetTeam || m.red.team === targetTeam)) { m.red.picks.filter(x => x.hero !== hero).forEach(a => inc(d.synergy, a.hero, !winBlue)); m.blue.picks.forEach(e => inc(d.vs, e.hero, !winBlue)); } }); return d; }
    function renderKV(items){ if(!items.length) return '<div class="text-slate-500 text-xs">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>'; return items.map(x=>`<div class='flex items-center justify-between gap-2'><div class='flex items-center gap-2 min-w-0'><img src='${heroImg(x.name)}' class='inline-preview'/><div class='truncate'>${x.name}</div></div><div class='text-right text-slate-600 whitespace-nowrap'>${x.games} –∏–≥—Ä ‚Ä¢ ${x.wins}W ‚Ä¢ ${fmtPct(x.wr)}</div></div>`).join(''); }
    function renderDraft(map,title){ const order=['B1','B2','B3','B4','B5','R1','R2','R3','R4','R5']; return `<div><div class='font-medium mb-1'>${title}</div><div class='grid grid-cols-5 gap-1 text-sm'>${order.map(k=>`<div class='px-2 py-1 rounded-lg bg-white ring-1 ring-slate-200 text-center'><div class='text-[10px] text-slate-500'>${k}</div><div>${map.get(k)||0}</div></div>`).join('')}</div></div>`; }
    function openHeroModal(hero, matches, filters){ const d=calcHeroDetails(hero, matches, filters); const wr = d.picks? fmtPct(pct(d.wins,d.picks)):'‚Äî'; document.getElementById('modalHeroName').innerHTML = `<div class='flex items-center gap-2'><img src='${heroImg(hero)}' class='inline-preview'/> <span>${hero}</span></div>`; document.getElementById('modalHeroSubtitle').textContent = `–ò–≥—Ä—ã: ${d.picks} ‚Ä¢ –ü–æ–±–µ–¥—ã: ${d.wins} ‚Ä¢ –ü–æ—Ä–∞–∂–µ–Ω–∏—è: ${d.losses} ‚Ä¢ –í–∏–Ω—Ä–µ–π—Ç: ${wr} ‚Ä¢ –ë–∞–Ω—ã: ${d.bans}`; document.getElementById('modalSummary').innerHTML = `<div class='space-y-1'><div class='flex items-center justify-between'><span>–ò–≥—Ä</span><span class='font-medium'>${d.picks}</span></div><div class='flex items-center justify-between'><span>–ü–æ–±–µ–¥—ã</span><span class='font-medium'>${d.wins}</span></div><div class='flex items-center justify-between'><span>–ü–æ—Ä–∞–∂–µ–Ω–∏—è</span><span class='font-medium'>${d.losses}</span></div><div class='flex items-center justify-between'><span>–í–∏–Ω—Ä–µ–π—Ç</span><span class='font-medium'>${wr}</span></div><div class='flex items-center justify-between'><span>–ë–∞–Ω—ã</span><span class='font-medium'>${d.bans}</span></div><div class='flex items-center justify-between'><span>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</span><span class='font-medium'>${d.picks + d.bans}</span></div></div>`; const rolesOrder=['exp','jungle','mid','roam','gold']; const labels={exp:'EXP',jungle:'Jungle',mid:'Mid',roam:'Roam',gold:'Gold'}; document.getElementById('modalRoles').innerHTML = rolesOrder.map(r=>{ const rs=d.roles.get(r)||{games:0,wins:0}; const wr= rs.games? fmtPct(pct(rs.wins,rs.games)):'‚Äî'; return `<div class='rounded-lg bg-white ring-1 ring-slate-200 p-3'><div class='text-xs text-slate-500'>${labels[r]}</div><div class='mt-1 text-sm'>${rs.games} –∏–≥—Ä ‚Ä¢ ${rs.wins}W/${rs.games-rs.wins}L ‚Ä¢ ${wr}</div></div>`; }).join(''); document.getElementById('modalSynergy').innerHTML = renderKV(topN(d.synergy,10,{best:true})); document.getElementById('modalBestVs').innerHTML = renderKV(topN(d.vs,5,{best:true})); document.getElementById('modalWorstVs').innerHTML = renderKV(topN(d.vs,5,{best:false})); document.getElementById('modalDraftPositions').innerHTML = `${renderDraft(d.draft.pick,'–ü–∏–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É')}${renderDraft(d.draft.ban,'–ë–∞–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É')}`; const teamStats = calcTeamStatsForHero(hero, matches); const modalTeamsEl = document.getElementById('modalTeams'); if (teamStats.length > 0) { modalTeamsEl.innerHTML = teamStats.map(team => `<div class='flex items-center justify-between gap-2'><div class='truncate'>${team.name}</div><div class='text-right text-slate-600 whitespace-nowrap'>${team.games} –∏–≥—Ä ‚Ä¢ ${team.wins}W ‚Ä¢ ${fmtPct(team.wr)}</div></div>`).join(''); } else { modalTeamsEl.innerHTML = '<div class="text-slate-500 text-xs">–≠—Ç–æ–≥–æ –≥–µ—Ä–æ—è –Ω–µ –ø–∏–∫–∞–ª–∏ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–∞—Ö.</div>'; } heroModal.classList.remove('hidden'); }
    function refreshUI() { if (currentUser && (currentUserRole === 'admin' || currentUserRole === 'viewer')) { rebuildFiltersAndStats(allMatches); } }
  });
  </script>
</body>
</html>