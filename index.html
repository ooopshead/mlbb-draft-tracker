<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLBB Draft Tracker (Online)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- –ö–ª–∏–µ–Ω—Ç Supabase –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ –≤–Ω–∏–∑—É —Ñ–∞–π–ª–∞ -->
  <style>
    .fade-in { animation: fadeIn .2s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: none; } }
    .modal-open { overflow: hidden; } .scroll-thin { scrollbar-width: thin; }
    .inline-preview { width: 22px; height: 22px; border-radius: 6px; object-fit: cover; }
    .combo { position: relative; } .combo-list { position: absolute; z-index: 50; left: 0; right: 0; top: calc(100% + 6px); max-height: 360px; overflow-y: auto; background: white; border-radius: 14px; box-shadow: 0 12px 28px rgba(2,6,23,.18); border: 1px solid rgb(226 232 240); padding: 6px; }
    .combo-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-radius: 10px; font-size: 14px; }
    .combo-item:hover, .combo-item[aria-selected="true"] { background: rgb(248 250 252); } .combo-item img { width: 22px; height: 22px; border-radius: 6px; }
    body.dark { background-color: #0b1220; color: #e5e7eb; } .dark .bg-white { background-color: #111827 !important; }
    .dark .bg-slate-50 { background-color: #0f172a !important; } .dark .bg-slate-100 { background-color: #0b1220 !important; }
    .dark .text-slate-900 { color: #e5e7eb !important; } .dark .text-slate-600 { color: #94a3b8 !important; }
    .dark .text-slate-500 { color: #94a3b8 !important; } .dark .ring-slate-200 { box-shadow: none; border-color: rgba(148,163,184,.25) !important; }
    .dark .hover\:bg-slate-100:hover { background-color: #0b1220 !important; } .dark .combo-list { background: #0f172a; border-color: rgba(148,163,184,.25); }
    .dark .combo-item:hover, .dark .combo-item[aria-selected="true"] { background: #111827; }
    .dark .bg-slate-200 { background-color: #1f2937 !important; color: #e5e7eb !important; border-color: rgba(148,163,184,.25) !important; }
    .dark .hover\:bg-slate-300:hover { background-color: #374151 !important; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <header class="flex items-center justify-between mb-6 flex-wrap gap-4">
      <h1 class="text-2xl font-bold tracking-tight">MLBB Draft Tracker</h1>
      <div class="flex items-center gap-4">
        <!-- AUTH SECTION -->
        <div id="authSection" class="text-sm">
          <form id="loginForm" class="flex items-center gap-2">
            <input id="loginEmail" type="email" class="w-48 px-3 py-2 rounded-xl bg-slate-100" placeholder="Email –¥–ª—è –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" required />
            <button type="submit" class="px-3 py-2 rounded-xl bg-slate-900 text-white">–í–æ–π—Ç–∏</button>
          </form>
          <div id="userInfo" class="hidden items-center gap-3">
            <span id="userEmail" class="text-slate-600"></span>
            <button id="logoutBtn" class="px-3 py-2 rounded-xl bg-slate-200">–í—ã–π—Ç–∏</button>
          </div>
        </div>
        <input id="imgBaseInput" class="hidden sm:block w-64 px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü–∞–ø–∫–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤: ./portraits/" />
        <button id="themeToggle" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300" title="–¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">üåô</button>
      </div>
    </header>

    <nav class="inline-flex rounded-2xl bg-white shadow ring-1 ring-slate-200 overflow-hidden mb-4">
      <button data-tab="stats" class="tab-btn px-4 py-2 text-sm font-medium bg-slate-900 text-white">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button data-tab="matches" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100">–ú–∞—Ç—á–∏</button>
      <button id="inputTabBtn" data-tab="input" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 hidden">–í–≤–æ–¥ –º–∞—Ç—á–∞</button>
    </nav>

    <!-- INPUT TAB (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <section id="tab-input" class="hidden fade-in">
      <form id="matchForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <label class="block text-sm font-medium mb-1">–õ–∏–≥–∞</label>
            <input name="league" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="MPL / MDL‚Ä¶" required />
          </div>
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <label class="block text-sm font-medium mb-1">–ü–∞—Ç—á</label>
            <input name="patch" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–Ω–∞–ø—Ä. 1.8.80" required />
          </div>
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <label class="block text-sm font-medium mb-1">–î–∞—Ç–∞</label>
            <input type="date" name="date" class="w-full px-3 py-2 rounded-xl bg-slate-100" />
          </div>
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <label class="block text-sm font-medium mb-1">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</label>
            <div class="flex items-center gap-4 mt-2">
              <label class="inline-flex items-center gap-2"><input type="radio" name="winner" value="blue"/> –°–∏–Ω—è—è</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="winner" value="red"/> –ö—Ä–∞—Å–Ω–∞—è</label>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <h2 class="font-semibold mb-2">–°–∏–Ω—è—è –∫–æ–º–∞–Ω–¥–∞</h2>
            <input name="blueTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-3" placeholder="Blue Team" required />
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div><div class="text-sm font-medium mb-1">–ë–∞–Ω—ã (5)</div><div id="blueBans" class="space-y-2"></div></div>
              <div><div class="text-sm font-medium mb-1">–ü–∏–∫–∏ (5)</div><div id="bluePicks" class="space-y-2"></div></div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <h2 class="font-semibold mb-2">–ö—Ä–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</h2>
            <input name="redTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-3" placeholder="Red Team" required />
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div><div class="text-sm font-medium mb-1">–ë–∞–Ω—ã (5)</div><div id="redBans" class="space-y-2"></div></div>
              <div><div class="text-sm font-medium mb-1">–ü–∏–∫–∏ (5)</div><div id="redPicks" class="space-y-2"></div></div>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á</button>
          <button id="resetForm" class="px-4 py-2 rounded-xl bg-slate-200" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
      </form>
    </section>

    <!-- STATS TAB (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <section id="tab-stats" class="fade-in">
      <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div><label class="block text-xs font-medium mb-1">–õ–∏–≥–∞</label><select id="filterLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div>
          <div><label class="block text-xs font-medium mb-1">–ü–∞—Ç—á</label><select id="filterPatch" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div>
          <div><label class="block text-xs font-medium mb-1">–ö–æ–º–∞–Ω–¥–∞</label><select id="filterTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div>
          <div><label class="block text-xs font-medium mb-1">–°—Ç–æ—Ä–æ–Ω–∞</label><select id="filterSide" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–í—Å–µ</option><option value="blue">–°–∏–Ω—è—è</option><option value="red">–ö—Ä–∞—Å–Ω–∞—è</option></select></div>
          <div><label class="block text-xs font-medium mb-1">–ü–æ–∏—Å–∫ –≥–µ—Ä–æ—è</label><input id="searchHero" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" class="w-full px-3 py-2 rounded-xl bg-slate-100" /></div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow ring-1 ring-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="px-4 py-2 text-left">–ì–µ—Ä–æ–π</th><th class="px-4 py-2 text-right">–ò–≥—Ä</th><th class="px-4 py-2 text-right">–ü–æ–±–µ–¥—ã</th><th class="px-4 py-2 text-right">–ü–æ—Ä–∞–∂–µ–Ω–∏—è</th><th class="px-4 py-2 text-right">–í–∏–Ω—Ä–µ–π—Ç</th><th class="px-4 py-2 text-right">–ë–∞–Ω—ã</th><th class="px-4 py-2 text-right">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</th>
              </tr>
            </thead>
            <tbody id="statsBody" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
        <div class="p-3 text-xs text-slate-500">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–µ—Ä–æ—è, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.</div>
      </div>
    </section>

    <!-- MATCHES TAB -->
    <section id="tab-matches" class="hidden fade-in">
      <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
        <h2 class="font-semibold mb-3">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–∞—Ç—á–∏</h2>
        <div id="matchesList" class="grid gap-3"></div>
      </div>
    </section>
  </div>

  <!-- HERO MODAL -->
  <div id="heroModal" class="fixed inset-0 bg-black/40 z-50 hidden"><div class="min-h-full w-full flex items-center justify-center p-4"><div class="bg-white w-full max-w-4xl rounded-2xl shadow-xl ring-1 ring-slate-200 overflow-hidden"><div class="flex items-center justify-between px-5 py-3 border-b"><div><h3 id="modalHeroName" class="text-lg font-semibold"></h3><p id="modalHeroSubtitle" class="text-xs text-slate-500"></p></div><button id="closeModal" class="p-2 rounded-lg hover:bg-slate-100">‚úï</button></div><div class="p-5 space-y-6 max-h-[75vh] overflow-y-auto scroll-thin"><div class="grid grid-cols-1 md:grid-cols-3 gap-3"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-1">–û–±—â–µ–µ</div><div id="modalSummary" class="text-sm"></div></div><div class="bg-slate-50 rounded-xl p-4 md:col-span-2"><div class="text-xs text-slate-500 mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è–º</div><div id="modalRoles" class="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–¢–æ–ø‚Äë10 —Å–∏–Ω–µ—Ä–≥–∏–π (—Å–æ—é–∑–Ω–∏–∫–∏)</div><div id="modalSynergy" class="text-sm space-y-1"></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ú–∞—Ç—á–∞–ø—ã</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-3 text-sm"><div><div class="font-medium mb-1">–õ—É—á—à–µ –ø—Ä–æ—Ç–∏–≤</div><div id="modalBestVs" class="space-y-1"></div></div><div><div class="font-medium mb-1">–°–ª–æ–∂–Ω–æ –ø—Ä–æ—Ç–∏–≤</div><div id="modalWorstVs" class="space-y-1"></div></div></div></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ü–æ–∑–∏—Ü–∏–∏ –≤ –¥—Ä–∞—Ñ—Ç–µ</div><div id="modalDraftPositions" class="text-sm grid grid-cols-2 lg:grid-cols-4 gap-2"></div></div></div></div></div></div>

  <!-- TEMPLATES -->
  <template id="banRowTpl"><div class="flex items-center gap-2"><div class="w-10 text-xs text-slate-500">#<span class="ord"></span></div><div class="combo flex-1"><input class="banHero w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ì–µ—Ä–æ–π" /><div class="combo-list hidden"></div></div></div></template>
  <template id="pickRowTpl"><div class="flex items-center gap-2"><div class="w-10 text-xs text-slate-500">#<span class="ord"></span></div><div class="combo flex-1"><input class="pickHero w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ì–µ—Ä–æ–π" /><div class="combo-list hidden"></div></div><select class="pickRole w-28 px-2 py-2 rounded-xl bg-slate-100 text-sm"><option value="">–†–æ–ª—å‚Ä¶</option><option value="exp">EXP</option><option value="jungle">Jungle</option><option value="mid">Mid</option><option value="roam">Roam</option><option value="gold">Gold</option></select></div></template>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // –í–ê–®–ò –ö–õ–Æ–ß–ò
  const SUPABASE_URL = 'https://fsrhkwyyedkxmlooddjn.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzcmhrd3l5ZWRreG1sb29kZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NzQ4NTUsImV4cCI6MjA3MjA1MDg1NX0.JlftKlupkTtFBIkXdWNL-DigdFRc9DVAP48VXmh3fgg';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ======
  const HEROES = ["Aamon","Akai","Aldous","Alice","Alpha","Alucard","Angela","Argus","Arlott","Atlas","Aulus","Aurora","Badang","Balmond","Bane","Barats","Baxia","Beatrix","Belerick","Benedetta","Brody","Bruno","Carmilla","Cecilion","Chang'e","Chip","Chou","Cici","Claude","Clint","Cyclops","Diggie","Dyrroth","Edith","Esmeralda","Estes","Eudora","Fanny","Faramis","Floryn","Franco","Fredrinn","Freya","Gatotkaca","Gloo","Gord","Granger","Grock","Guinevere","Gusion","Hanabi","Hanzo","Harith","Harley","Hayabusa","Helcurt","Hilda","Hylos","Irithel","Ixia","Jawhead","Johnson","Joy","Julian","Kadita","Kagura","Kaja","Kalea","Karina","Karrie","Khaleed","Khufra","Kimmy","Lancelot","Lapu-Lapu","Layla","Leomord","Lesley","Ling","Lolita","Lunox","Luo Yi","Lylia","Martis","Masha","Mathilda","Melissa","Minotaur","Minsitthar","Miya","Moskov","Nana","Natalia","Natan","Nolan","Novaria","Odette","Paquito","Pharsa","Phoveus","Popol and Kupa","Rafaela","Roger","Ruby","Saber","Selena","Silvanna","Sun","Suyou","Terizla","Thamuz","Tigreal","Uranus","Vale","Valentina","Valir","Vexana","Wanwan","X.Borg","Xavier","Yi Sun-shin","Yin","Yu Zhong","Yve","Zetian","Zhask","Zhuxin","Zilong"];
  const LS_IMG = 'mlbb_portraits_base_v1';
  const LS_FORM = 'mlbb_draft_form_v1';
  let allMatches = [];
  let currentUser = null;
  let isCurrentUserAdmin = false; // –§–ª–∞–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

  // ====== –£—Ç–∏–ª–∏—Ç—ã ======
  function getImgBase(){ return localStorage.getItem(LS_IMG) || './portraits/'; }
  function setImgBase(v){ localStorage.setItem(LS_IMG, v); }
  function heroSlug(name){ return name.replace(/\./g,'_').replace(/'/g,'').replace(/\s+/g,'_'); }
  function heroImg(name){ return getImgBase() + heroSlug(name) + '.png'; }
  function getCanonicalHero(name){ if(!name) return ''; const n=name.trim().toLowerCase(); return HEROES.find(h=>h.toLowerCase()===n) || ''; }
  function normalizeHero(name){ return getCanonicalHero(name) || ''; }
  function pct(n,d){ return d? (100*n/d):0; }
  function fmtPct(v){ return isFinite(v)? v.toFixed(1)+'%':'‚Äî'; }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // ====== –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase ======
  async function fetchMatches() {
    const { data, error } = await supabase.from('matches').select('*').order('created_at', { ascending: false });
    if (error) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç—á–∏.'); return []; }
    return data.map(m => ({ id: m.id, date: m.date, league: m.league, patch: m.patch, winner: m.winner, blue: { team: m.blue_team, picks: m.blue_picks || [], bans: m.blue_bans || [] }, red: { team: m.red_team, picks: m.red_picks || [], bans: m.red_bans || [] } }));
  }

  async function deleteMatch(id) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç—á?')) return;
    const { error } = await supabase.from('matches').delete().eq('id', id);
    if (error) { console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; }
    allMatches = allMatches.filter(m => m.id !== id);
    refreshUI();
    alert('–ú–∞—Ç—á —É–¥–∞–ª–µ–Ω.');
  }

  // ====== –õ–æ–≥–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π ======
  const loginForm = document.getElementById('loginForm');
  const userInfo = document.getElementById('userInfo');
  const userEmailEl = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const inputTabBtn = document.getElementById('inputTabBtn');

  async function fetchUserProfile() {
    isCurrentUserAdmin = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
    if (!currentUser) return;

    const { data, error } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', currentUser.id)
      .single();

    if (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error.message);
      return;
    }
    if (data && data.role === 'admin') {
      isCurrentUserAdmin = true;
    }
  }

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const { error } = await supabase.auth.signInWithOtp({ email });
    if (error) {
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
    } else {
        alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É! –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞.');
        loginForm.reset();
    }
  });

  logoutBtn.addEventListener('click', async () => { await supabase.auth.signOut(); });

  function updateUIForUser() {
    const isAdmin = isCurrentUserAdmin;
    if (isAdmin) {
        loginForm.classList.add('hidden');
        userInfo.classList.remove('hidden'); userInfo.classList.add('flex');
        userEmailEl.textContent = currentUser.email;
        inputTabBtn.classList.remove('hidden');
    } else {
        loginForm.classList.remove('hidden');
        userInfo.classList.add('hidden'); userInfo.classList.remove('flex');
        inputTabBtn.classList.add('hidden');
        const inputTab = document.getElementById('tab-input');
        if (!inputTab.classList.contains('hidden')) {
            document.querySelector('[data-tab="stats"]').click();
        }
    }
    refreshMatchesList(allMatches);
  }

  // ====== –õ–æ–≥–∏–∫–∞ UI (–¢–∞–±—ã, –§–æ—Ä–º–∞, –ö–æ–º–±–æ–±–æ–∫—Å) ======
  const tabs = { input: document.getElementById('tab-input'), stats: document.getElementById('tab-stats'), matches: document.getElementById('tab-matches') };
  const tabBtns = document.querySelectorAll('.tab-btn');
  tabBtns.forEach(btn => btn.addEventListener('click', () => {
      if (btn.id === 'inputTabBtn' && !isCurrentUserAdmin) return;
      tabBtns.forEach(b => b.classList.remove('bg-slate-900', 'text-white'));
      btn.classList.add('bg-slate-900', 'text-white');
      const key = btn.dataset.tab;
      Object.entries(tabs).forEach(([k, el]) => el.classList.toggle('hidden', k !== key));
      if (key === 'stats') rebuildFiltersAndStats(allMatches);
      if (key === 'matches') refreshMatchesList(allMatches);
  }));

  function attachCombobox(wrapper, inputEl){
    const list = wrapper.querySelector('.combo-list'); let active = -1;
    function produce(q){
      const qq=(q||'').trim().toLowerCase(); let items = HEROES;
      if (qq){ const starts = HEROES.filter(h => h.toLowerCase().startsWith(qq)); items = starts.length ? starts : HEROES.filter(h => h.toLowerCase().includes(qq)); }
      return items.slice(0,100);
    }
    function render(q){
      const items = produce(q);
      if(!items.length){ list.classList.add('hidden'); list.innerHTML=''; return; }
      list.innerHTML = items.map((h,i)=>`<div class="combo-item" data-idx="${i}" data-value="${h}"><img src="${heroImg(h)}" alt=""/><span>${h}</span></div>`).join('');
      list.classList.remove('hidden'); active=-1;
      list.querySelectorAll('.combo-item').forEach(div=>{ div.addEventListener('click',()=>{ inputEl.value=div.dataset.value; list.classList.add('hidden'); saveDraftDebounced(); }); });
    }
    function moveActive(delta){ const items=[...list.querySelectorAll('.combo-item')]; if(!items.length) return; active=(active+delta+items.length)%items.length; items.forEach((el,i)=> el.setAttribute('aria-selected', i===active?'true':'false')); items[active].scrollIntoView({block:'nearest'}); }
    inputEl.addEventListener('keydown',(e)=>{ if(list.classList.contains('hidden')) return; if(e.key==='ArrowDown'){e.preventDefault();moveActive(1);} if(e.key==='ArrowUp'){e.preventDefault();moveActive(-1);} if(e.key==='Enter'&&active>=0){e.preventDefault();const el=list.querySelectorAll('.combo-item')[active]; if(el){ inputEl.value=el.dataset.value; list.classList.add('hidden'); saveDraftDebounced(); }} if(e.key==='Escape'){ list.classList.add('hidden'); }});
    inputEl.addEventListener('input', ()=> render(inputEl.value));
    inputEl.addEventListener('focus', ()=> render(inputEl.value));
    inputEl.addEventListener('blur', ()=> setTimeout(()=>list.classList.add('hidden'), 150));
  }
  
  const banRowTpl = document.getElementById('banRowTpl'); const pickRowTpl = document.getElementById('pickRowTpl');
  const blueBansEl = document.getElementById('blueBans'); const redBansEl = document.getElementById('redBans');
  const bluePicksEl = document.getElementById('bluePicks'); const redPicksEl = document.getElementById('redPicks');

  function buildRows(container, tpl, count, prefill=[]) {
    container.innerHTML='';
    for(let i=1;i<=count;i++){
      const node = tpl.content.cloneNode(true); node.querySelector('.ord').textContent = i;
      const input = node.querySelector('input'); attachCombobox(node.querySelector('.combo'), input);
      const item = prefill[i-1];
      if (item && item.hero) {
        input.value = item.hero;
        const roleSel = node.querySelector('select.pickRole');
        if (roleSel && item.role) roleSel.value = item.role;
      }
      container.appendChild(node);
    }
  }

  function readFormDraft(){ try { return JSON.parse(localStorage.getItem(LS_FORM)) || null; } catch { return null; } }
  function writeFormDraft(d){ localStorage.setItem(LS_FORM, JSON.stringify(d)); }
  function getFormData(){
    const f=document.getElementById('matchForm');
    function collectFrom(container){ return Array.from(container.querySelectorAll('.flex.items-center')).map((row,idx)=>{ const hero = normalizeHero(row.querySelector('input')?.value||''); if(!hero) return null; const obj = {hero, order: idx+1}; const roleSel=row.querySelector('select.pickRole'); if(roleSel) obj.role = roleSel.value||''; return obj; }).filter(Boolean); }
    return { league: f.league.value || '', patch: f.patch.value || '', date: f.date.value || '', winner: (f.winner.value||''), blueTeam: f.blueTeam.value || '', redTeam: f.redTeam.value || '', blue: { bans: collectFrom(blueBansEl), picks: collectFrom(bluePicksEl) }, red:  { bans: collectFrom(redBansEl),  picks: collectFrom(redPicksEl) } };
  }
  function applyFormDraft(d){
    if(!d) return; const f=document.getElementById('matchForm');
    f.league.value=d.league||''; f.patch.value=d.patch||''; f.date.value=d.date||''; f.blueTeam.value=d.blueTeam||''; f.redTeam.value=d.redTeam||'';
    if(d.winner){ const wEls=f.querySelectorAll('input[name=winner]'); wEls.forEach(el=> el.checked = (el.value===d.winner)); } else { f.querySelectorAll('input[name=winner]').forEach(el=> el.checked=false); }
    buildRows(blueBansEl, banRowTpl, 5, d.blue?.bans||[]); buildRows(redBansEl,  banRowTpl, 5, d.red?.bans||[]);
    buildRows(bluePicksEl, pickRowTpl, 5, d.blue?.picks||[]); buildRows(redPicksEl,  pickRowTpl, 5, d.red?.picks||[]);
  }
  const saveDraftDebounced = debounce(()=> writeFormDraft(getFormData()), 250);
  document.addEventListener('input', (e)=>{ const form = document.getElementById('matchForm'); if (form && form.contains(e.target)) saveDraftDebounced(); });
  document.addEventListener('change', (e)=>{ const form = document.getElementById('matchForm'); if (form && form.contains(e.target)) saveDraftDebounced(); });

  document.getElementById('resetForm').addEventListener('click', () => {
    const keep = readFormDraft() || {};
    keep.blue = {bans:[], picks:[]}; keep.red = {bans:[], picks:[]}; keep.winner='';
    writeFormDraft(keep); applyFormDraft(keep);
  });
  
  document.getElementById('matchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!isCurrentUserAdmin) {
        alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–∞—Ç—á–∏.');
        return;
    }
    
    const f = e.currentTarget;
    function collect(container, type) { return Array.from(container.querySelectorAll('.flex.items-center')).map((row, idx) => { const hero = normalizeHero(row.querySelector('input')?.value || ''); if (!hero) return null; const obj = { hero, order: idx + 1 }; if (type === 'picks') { const roleSel = row.querySelector('select.pickRole'); obj.role = roleSel ? roleSel.value || '' : ''; } return obj; }).filter(Boolean); }
    
    const matchDataForDB = { date: f.date.value || null, league: f.league.value.trim(), patch: f.patch.value.trim(), winner: f.winner.value, blue_team: f.blueTeam.value.trim(), red_team: f.redTeam.value.trim(), blue_bans: collect(blueBansEl, 'bans'), blue_picks: collect(bluePicksEl, 'picks'), red_bans: collect(redBansEl, 'bans'), red_picks: collect(redPicksEl, 'picks') };
    
    if (!matchDataForDB.blue_team || !matchDataForDB.red_team) return alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥.');
    if (!matchDataForDB.league || !matchDataForDB.patch) return alert('–õ–∏–≥–∞ –∏ –ø–∞—Ç—á –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.');
    if (!matchDataForDB.winner) return alert('–£–∫–∞–∂–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.');

    const { data, error } = await supabase.from('matches').insert([matchDataForDB]).select().single();
    if (error) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç—á–∞:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; }
    alert('–ú–∞—Ç—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
    
    const newMatch = { id: data.id, date: data.date, league: data.league, patch: data.patch, winner: data.winner, blue: { team: data.blue_team, picks: data.blue_picks, bans: data.blue_bans }, red: { team: data.red_team, picks: data.red_picks, bans: data.red_bans } };
    allMatches.unshift(newMatch);
    
    refreshUI();
    
    const keep = { ...readFormDraft(), blue:{bans:[],picks:[]}, red:{bans:[],picks:[]}, winner:'' };
    writeFormDraft(keep); applyFormDraft(keep);
  });

  // ====== –ú–∞—Ç—á–∏ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ======
  const matchesListEl = document.getElementById('matchesList');
  const filterLeague=document.getElementById('filterLeague'), filterPatch=document.getElementById('filterPatch'), filterTeam=document.getElementById('filterTeam'), filterSide=document.getElementById('filterSide'), searchHero=document.getElementById('searchHero'), statsBody=document.getElementById('statsBody');
  const heroModal=document.getElementById('heroModal'); document.getElementById('closeModal').onclick=()=> heroModal.classList.add('hidden'); heroModal.addEventListener('click',e=>{ if(e.target===heroModal) heroModal.classList.add('hidden'); });

  function heroChip(name){ return `<span class='inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100'><img src='${heroImg(name)}' class='inline-preview'/>${name}</span>`; }
  function matchCardHTML(m){
    const isAdmin = isCurrentUserAdmin;
    const deleteButtonHTML = isAdmin ? `<button data-action='del' data-id='${m.id}' class='px-3 py-1.5 rounded-xl bg-rose-600 text-white'>–£–¥–∞–ª–∏—Ç—å</button>` : '';
    return `<div class='rounded-2xl ring-1 ring-slate-200 bg-white p-4'><div class='flex items-center justify-between gap-2'><div><div class='text-xs text-slate-500'>${m.league} ‚Ä¢ –ü–∞—Ç—á ${m.patch} ‚Ä¢ ${m.date||'‚Äî'}</div><div class='font-medium mt-1'>${m.blue.team} <span class='text-xs ${m.winner==='blue'?'text-emerald-600':'text-slate-400'}'>${m.winner==='blue'?'(W)':''}</span> ‚Äî ${m.red.team} <span class='text-xs ${m.winner==='red'?'text-emerald-600':'text-slate-400'}'>${m.winner==='red'?'(W)':''}</span></div></div>${deleteButtonHTML}</div><div class='mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm'><div><div class='text-xs text-slate-500 mb-1'>–°–∏–Ω—è—è ‚Äî –±–∞–Ω—ã / –ø–∏–∫–∏</div><div class='flex flex-wrap gap-1'>${m.blue.bans.map(x=>heroChip(x.hero)).join('')}</div><div class='mt-1 flex flex-wrap gap-1'>${m.blue.picks.map(x=>heroChip(x.hero)).join('')}</div></div><div><div class='text-xs text-slate-500 mb-1'>–ö—Ä–∞—Å–Ω–∞—è ‚Äî –±–∞–Ω—ã / –ø–∏–∫–∏</div><div class='flex flex-wrap gap-1'>${m.red.bans.map(x=>heroChip(x.hero)).join('')}</div><div class='mt-1 flex flex-wrap gap-1'>${m.red.picks.map(x=>heroChip(x.hero)).join('')}</div></div></div></div>`;
  }
  function refreshMatchesList(matches) {
    if (!matches || !matches.length) { matchesListEl.innerHTML='<div class="text-sm text-slate-500">–ü–æ–∫–∞ –Ω–µ—Ç –º–∞—Ç—á–µ–π.</div>'; return; }
    matchesListEl.innerHTML = matches.map(matchCardHTML).join('');
    matchesListEl.querySelectorAll('[data-action=del]')?.forEach(b => { b.onclick = () => deleteMatch(b.dataset.id); });
  }

  function collectFilters(matches){ const leagues=new Set(), patches=new Set(), teams=new Set(); matches.forEach(m=>{ if(m.league)leagues.add(m.league); if(m.patch)patches.add(m.patch); if(m.blue?.team)teams.add(m.blue.team); if(m.red?.team)teams.add(m.red.team); }); return { leagues:['–í—Å–µ',...leagues], patches:['–í—Å–µ',...patches], teams:['–í—Å–µ',...teams] }; }
  function setOptions(sel,arr){ const cur=sel.value; sel.innerHTML=arr.map(v=>`<option value='${v==='–í—Å–µ'?'':v}'>${v}</option>`).join(''); Array.from(sel.options).forEach(o=>{ if(o.value===cur) sel.value=cur; }); }
  function applyFilters(matches, {league,patch,team,side}){ return matches.filter(m=>{ if (league && league!=='–í—Å–µ' && m.league!==league) return false; if (patch && patch!=='–í—Å–µ' && m.patch!==patch) return false; if (team && team!=='–í—Å–µ' && !(m.blue.team===team || m.red.team===team)) return false; if (!side) return true; if (side==='blue' && team && team!=='–í—Å–µ') return m.blue.team===team; if (side==='red' && team && team!=='–í—Å–µ') return m.red.team===team; return true; }); }
  function aggregate(matches){ const map=new Map(); function ens(h){ if(!map.has(h)) map.set(h,{hero:h,picks:0,wins:0,losses:0,bans:0,presence:0}); return map.get(h); } matches.forEach(m=>{ const winSide=m.winner; m.blue.picks.forEach(p=>{ const h=p.hero; const s=ens(h); s.picks++; s.presence++; if(winSide==='blue') s.wins++; else s.losses++; }); m.red.picks.forEach(p=>{ const h=p.hero; const s=ens(h); s.picks++; s.presence++; if(winSide==='red') s.wins++; else s.losses++; }); m.blue.bans.forEach(b=>{ const s=ens(b.hero); s.bans++; s.presence++; }); m.red.bans.forEach(b=>{ const s=ens(b.hero); s.bans++; s.presence++; }); }); return Array.from(map.values()); }
  function renderStats(allMatchesData){
    const filters= {league:filterLeague.value||'', patch:filterPatch.value||'', team:filterTeam.value||'', side:filterSide.value||''};
    const matches=applyFilters(allMatchesData, filters);
    const rows = aggregate(matches).filter(r=> !searchHero.value || r.hero.toLowerCase().startsWith(searchHero.value.toLowerCase())).sort((a,b)=> (b.presence-a.presence)||(b.picks-a.picks));
    statsBody.innerHTML = rows.map(r=>{ const wr = r.picks ? fmtPct(pct(r.wins, r.picks)) : '‚Äî'; return `<tr class='hover:bg-slate-50 cursor-pointer' data-hero='${r.hero}'><td class='px-4 py-2'><div class='flex items-center gap-2'><img src='${heroImg(r.hero)}' class='inline-preview'/>${r.hero}</div></td><td class='px-4 py-2 text-right'>${r.picks}</td><td class='px-4 py-2 text-right'>${r.wins}</td><td class='px-4 py-2 text-right'>${r.losses}</td><td class='px-4 py-2 text-right'>${wr}</td><td class='px-4 py-2 text-right'>${r.bans}</td><td class='px-4 py-2 text-right'>${r.presence}</td></tr>`; }).join('');
    statsBody.querySelectorAll('tr[data-hero]')?.forEach(tr=> tr.addEventListener('click', ()=> openHeroModal(tr.dataset.hero, matches)));
  }
  [filterLeague,filterPatch,filterTeam,filterSide,searchHero].forEach(el=> el.addEventListener('input', () => renderStats(allMatches)));
  function rebuildFiltersAndStats(matches){ const f=collectFilters(matches); setOptions(filterLeague,f.leagues); setOptions(filterPatch,f.patches); setOptions(filterTeam,f.teams); renderStats(matches); }
  function topN(map,n,{best=true,minGames=2}={}){ const arr=[...map.entries()].map(([name,o])=>({name, games:o.games, wins:o.wins, wr:o.games?o.wins*100/o.games:0})).filter(x=>x.games>=minGames).sort((a,b)=> best? (b.wr-a.wr||b.games-a.games):(a.wr-b.wr||b.games-a.games)); return arr.slice(0,n); }
  function calcHeroDetails(hero, matches){
    const d={hero, picks:0,wins:0,losses:0,bans:0, roles:new Map(), synergy:new Map(), vs:new Map(), draft:{pick:new Map(),ban:new Map()}};
    function roleEns(r){ if(!d.roles.has(r)) d.roles.set(r,{games:0,wins:0,losses:0}); return d.roles.get(r); }
    function inc(map,key,win){ if(!map.has(key)) map.set(key,{games:0,wins:0}); const o=map.get(key); o.games++; if(win) o.wins++; }
    matches.forEach(m=>{ const winBlue=m.winner==='blue'; const blueHas=m.blue.picks.some(p=>p.hero===hero); const redHas=m.red.picks.some(p=>p.hero===hero); m.blue.picks.forEach(p=>{ if(p.hero===hero){ d.picks++; if(winBlue) d.wins++; else d.losses++; if(p.role){ const rs=roleEns(p.role); rs.games++; if(winBlue) rs.wins++; else rs.losses++; } d.draft.pick.set(`B${p.order}`,(d.draft.pick.get(`B${p.order}`)||0)+1);} }); m.red.picks.forEach(p=>{ if(p.hero===hero){ d.picks++; if(!winBlue) d.wins++; else d.losses++; if(p.role){ const rs=roleEns(p.role); rs.games++; if(!winBlue) rs.wins++; else rs.losses++; } d.draft.pick.set(`R${p.order}`,(d.draft.pick.get(`R${p.order}`)||0)+1);} }); m.blue.bans.forEach(b=>{ if(b.hero===hero){ d.bans++; d.draft.ban.set(`B${b.order}`,(d.draft.ban.get(`B${b.order}`)||0)+1);} }); m.red.bans.forEach(b=>{ if(b.hero===hero){ d.bans++; d.draft.ban.set(`R${b.order}`,(d.draft.ban.get(`R${b.order}`)||0)+1);} }); if(blueHas){ m.blue.picks.filter(x=>x.hero!==hero).forEach(a=>inc(d.synergy,a.hero,winBlue)); m.red.picks.forEach(e=>inc(d.vs,e.hero,winBlue)); } if(redHas){ m.red.picks.filter(x=>x.hero!==hero).forEach(a=>inc(d.synergy,a.hero,!winBlue)); m.blue.picks.forEach(e=>inc(d.vs,e.hero,!winBlue)); } });
    return d;
  }
  function renderKV(items){ if(!items.length) return '<div class="text-slate-500 text-xs">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>'; return items.map(x=>`<div class='flex items-center justify-between gap-2'><div class='flex items-center gap-2 min-w-0'><img src='${heroImg(x.name)}' class='inline-preview'/><div class='truncate'>${x.name}</div></div><div class='text-right text-slate-600 whitespace-nowrap'>${x.games} –∏–≥—Ä ‚Ä¢ ${x.wins}W ‚Ä¢ ${fmtPct(x.wr)}</div></div>`).join(''); }
  function renderDraft(map,title){ const order=['B1','B2','B3','B4','B5','R1','R2','R3','R4','R5']; return `<div><div class='font-medium mb-1'>${title}</div><div class='grid grid-cols-5 gap-1 text-sm'>${order.map(k=>`<div class='px-2 py-1 rounded-lg bg-white ring-1 ring-slate-200 text-center'><div class='text-[10px] text-slate-500'>${k}</div><div>${map.get(k)||0}</div></div>`).join('')}</div></div>`; }
  function openHeroModal(hero, matches){
    const d=calcHeroDetails(hero, matches); const wr = d.picks? fmtPct(pct(d.wins,d.picks)):'‚Äî';
    document.getElementById('modalHeroName').innerHTML = `<div class='flex items-center gap-2'><img src='${heroImg(hero)}' class='inline-preview'/> <span>${hero}</span></div>`;
    document.getElementById('modalHeroSubtitle').textContent = `–ò–≥—Ä—ã: ${d.picks} ‚Ä¢ –ü–æ–±–µ–¥—ã: ${d.wins} ‚Ä¢ –ü–æ—Ä–∞–∂–µ–Ω–∏—è: ${d.losses} ‚Ä¢ –í–∏–Ω—Ä–µ–π—Ç: ${wr} ‚Ä¢ –ë–∞–Ω—ã: ${d.bans}`;
    document.getElementById('modalSummary').innerHTML = `<div class='space-y-1'><div class='flex items-center justify-between'><span>–ò–≥—Ä</span><span class='font-medium'>${d.picks}</span></div><div class='flex items-center justify-between'><span>–ü–æ–±–µ–¥—ã</span><span class='font-medium'>${d.wins}</span></div><div class='flex items-center justify-between'><span>–ü–æ—Ä–∞–∂–µ–Ω–∏—è</span><span class='font-medium'>${d.losses}</span></div><div class='flex items-center justify-between'><span>–í–∏–Ω—Ä–µ–π—Ç</span><span class='font-medium'>${wr}</span></div><div class='flex items-center justify-between'><span>–ë–∞–Ω—ã</span><span class='font-medium'>${d.bans}</span></div><div class='flex items-center justify-between'><span>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</span><span class='font-medium'>${d.picks + d.bans}</span></div></div>`;
    const rolesOrder=['exp','jungle','mid','roam','gold']; const labels={exp:'EXP',jungle:'Jungle',mid:'Mid',roam:'Roam',gold:'Gold'};
    document.getElementById('modalRoles').innerHTML = rolesOrder.map(r=>{ const rs=d.roles.get(r)||{games:0,wins:0,losses:0}; const wr= rs.games? fmtPct(pct(rs.wins,rs.games)):'‚Äî'; return `<div class='rounded-lg bg-white ring-1 ring-slate-200 p-3'><div class='text-xs text-slate-500'>${labels[r]}</div><div class='mt-1 text-sm'>${rs.games} –∏–≥—Ä ‚Ä¢ ${rs.wins}W/${rs.losses}L ‚Ä¢ ${wr}</div></div>`; }).join('');
    document.getElementById('modalSynergy').innerHTML = renderKV(topN(d.synergy,10,{best:true}));
    document.getElementById('modalBestVs').innerHTML = renderKV(topN(d.vs,5,{best:true}));
    document.getElementById('modalWorstVs').innerHTML = renderKV(topN(d.vs,5,{best:false}));
    document.getElementById('modalDraftPositions').innerHTML = `${renderDraft(d.draft.pick,'–ü–∏–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É')}${renderDraft(d.draft.ban,'–ë–∞–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É')}`;
    heroModal.classList.remove('hidden');
  }

  // ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ======
  function refreshUI() {
      refreshMatchesList([...allMatches]);
      rebuildFiltersAndStats([...allMatches]);
  }
  
  async function initializeApp() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã
    (function(){ const THEME_KEY='mlbb_theme'; const savedTheme = localStorage.getItem(THEME_KEY) || 'light'; if (savedTheme==='dark') document.body.classList.add('dark'); document.getElementById('themeToggle').addEventListener('click',()=>{ document.body.classList.toggle('dark'); localStorage.setItem(THEME_KEY, document.body.classList.contains('dark')? 'dark':'light'); }); })();
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
    const imgBaseInput=document.getElementById('imgBaseInput'); imgBaseInput.value=getImgBase(); imgBaseInput.addEventListener('change',()=> setImgBase(imgBaseInput.value.trim()||'./portraits/'));
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    const initialDraft = readFormDraft(); if (initialDraft) { applyFormDraft(initialDraft); } else { buildRows(blueBansEl, banRowTpl, 5); buildRows(redBansEl, banRowTpl, 5); buildRows(bluePicksEl, pickRowTpl, 5); buildRows(redPicksEl, pickRowTpl, 5); }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    document.body.insertAdjacentHTML('beforeend', '<div id="loader" style="backdrop-filter: blur(4px);" class="fixed inset-0 bg-white/70 flex items-center justify-center z-50"><p class="text-lg font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>');
    
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤—Ö–æ–¥/–≤—ã—Ö–æ–¥/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞)
    supabase.auth.onAuthStateChange(async (_event, session) => {
        currentUser = session?.user ?? null;
        await fetchUserProfile(); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
        updateUIForUser();
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–µ–π
    allMatches = await fetchMatches();
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –∏ –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session?.user ?? null;
    await fetchUserProfile();
    updateUIForUser();

    document.getElementById('loader').remove();

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    refreshUI();
  }

  initializeApp();
  </script>
</body>
</html>