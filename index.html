<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLBB Draft Tracker (Role Filter v2.5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn .2s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: none; } }
    .modal-open { overflow: hidden; } .scroll-thin { scrollbar-width: thin; }
    .inline-preview { width: 22px; height: 22px; border-radius: 6px; object-fit: cover; }
    .combo { position: relative; } .combo-list { position: absolute; z-index: 50; left: 0; right: 0; top: calc(100% + 6px); max-height: 360px; overflow-y: auto; background: white; border-radius: 14px; box-shadow: 0 12px 28px rgba(2,6,23,.18); border: 1px solid rgb(226 232 240); padding: 6px; }
    .combo-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-radius: 10px; font-size: 14px; }
    .combo-item:hover, .combo-item[aria-selected="true"] { background: rgb(248 250 252); } .combo-item img { width: 22px; height: 22px; border-radius: 6px; }
    body.dark { background-color: #0b1220; color: #e5e7eb; } .dark .bg-white { background-color: #111827 !important; }
    .dark .bg-slate-50 { background-color: #0f172a !important; } .dark .bg-slate-100 { background-color: #0b1220 !important; }
    .dark .text-slate-900 { color: #e5e7eb !important; } .dark .text-slate-600 { color: #94a3b8 !important; } .dark .text-slate-500 { color: #94a3b8 !important; } .dark .ring-slate-200 { box-shadow: none; border-color: rgba(148,163,184,.25) !important; }
    .dark .hover\:bg-slate-100:hover { background-color: #0b1220 !important; } .dark .combo-list { background: #0f172a; border-color: rgba(148,163,184,.25); }
    .dark .combo-item:hover, .dark .combo-item[aria-selected="true"] { background: #111827; }
    .dark .bg-slate-200 { background-color: #1f2937 !important; color: #e5e7eb !important; border-color: rgba(148,163,184,.25) !important; }
    .dark .hover\:bg-slate-300:hover { background-color: #374151 !important; }
    .dark .bg-rose-100 { background-color: rgba(159, 18, 57, 0.25) !important; }
    .dark .hover\:bg-slate-50:hover { background-color: #1e293b !important; }
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: rgba(0,0,0,0.05); }
    .dark .sortable:hover { background-color: rgba(255,255,255,0.05); }
    .sort-icon { display: inline-block; width: 1em; height: 1em; opacity: 0.3; margin-left: 4px; }
    .sorted .sort-icon { opacity: 1; color: #0ea5e9; }
    .dark #draft-mode-toggle { background-color: #1e293b; }
    .dark .mode-btn.bg-white { background-color: #334155 !important; }
    
    /* Draft Helper Specifics */
    .draft-slot { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; position: relative; }
    .draft-slot:hover { border-color: #94a3b8; }
    .draft-slot.active-slot { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
    .draft-slot.filled { background-color: rgba(0,0,0,0.02); }
    .dark .draft-slot.filled { background-color: rgba(255,255,255,0.02); }
    .suggestion-card { transition: transform 0.1s; }
    .suggestion-card:hover { transform: translateX(4px); }
    .strength-bar-container { height: 8px; border-radius: 4px; background: #e2e8f0; overflow: hidden; display: flex; }
    .strength-bar-blue { background: #3b82f6; transition: width 0.5s ease-out; } 
    .strength-bar-red { background: #ef4444; flex: 1; transition: width 0.5s ease-out; }
    
    .stat-badge { font-size: 10px; padding: 1px 4px; border-radius: 4px; background: rgba(0,0,0,0.05); white-space: nowrap; }
    .dark .stat-badge { background: rgba(255,255,255,0.1); }
    .suggestion-reason { display: flex; flex-direction: column; gap: 2px; margin-top: 2px; }
    
    /* New Controls */
    .slot-remove-btn { position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; z-index: 10; opacity: 0; transition: opacity 0.2s; cursor: pointer; }
    .draft-slot:hover .slot-remove-btn { opacity: 1; }
    
    /* Pick Row Styles */
    .pick-row { display: flex; align-items: center; gap: 8px; padding: 4px; border-radius: 12px; border: 1px solid transparent; transition: all 0.2s; }
    .pick-row:hover { background-color: rgba(0,0,0,0.02); }
    .pick-row.active-slot { background-color: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
    .role-select { padding: 4px 8px; font-size: 12px; border-radius: 6px; border: 1px solid #cbd5e1; background-color: white; outline: none; cursor: pointer; }
    .dark .role-select { background-color: #1e293b; border-color: #475569; color: #e2e8f0; }

    /* Summary Styles */
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; margin-top: 8px; border-top: 1px solid #e2e8f0; padding-top: 8px; }
    .dark .summary-grid { border-top-color: #334155; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
    .val-pos { color: #10b981; font-weight: bold; }
    .val-neg { color: #f43f5e; font-weight: bold; }
    .val-neu { color: #94a3b8; }
    .factor-list { margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 2px; max-height: 160px; overflow-y: auto; scrollbar-width: thin; }
    .factor-item { display: flex; justify-content: space-between; font-size: 10px; padding-right: 4px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="auth-container" class="min-h-screen flex items-center justify-center hidden">
    <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg"><h1 class="text-2xl font-bold text-center mb-6">MLBB Draft Tracker</h1><div class="mb-4 flex justify-center border-b"><button id="show-login-btn" class="px-4 py-2 -mb-px border-b-2 border-slate-900 font-semibold">–í—Ö–æ–¥</button><button id="show-signup-btn" class="px-4 py-2 text-slate-500">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div><form id="loginForm"><div class="space-y-4"><input id="loginEmail" type="email" autocomplete="email" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="Email" required /><input id="loginPassword" type="password" autocomplete="current-password" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü–∞—Ä–æ–ª—å" required /><button type="submit" class="w-full px-3 py-3 rounded-xl bg-slate-900 text-white font-semibold">–í–æ–π—Ç–∏</button></div></form><form id="signupForm" class="hidden"><div class="space-y-4"><input id="signupEmail" type="email" autocomplete="email" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="Email" required /><input id="signupPassword" type="password" autocomplete="new-password" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" required /><button type="submit" class="w-full px-3 py-3 rounded-xl bg-slate-900 text-white font-semibold">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div><p class="text-xs text-slate-500 mt-4 text-center">–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å, –ø–æ–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –≤–∞–º –¥–æ—Å—Ç—É–ø.</p></form></div>
  </div>
  <div id="app-container" class="hidden max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <header class="flex items-center justify-between mb-4 flex-wrap gap-4"><div class="flex items-center gap-4"><h1 class="text-2xl font-bold tracking-tight">MLBB Draft Tracker <span class="text-xs font-normal text-slate-400 border border-slate-300 rounded px-1.5 py-0.5 ml-2">Role Filter v2.5</span></h1><div id="draft-mode-toggle" class="inline-flex rounded-lg bg-slate-200 p-1"><button data-mode="standard" class="mode-btn px-3 py-1 text-sm font-semibold rounded-md bg-white shadow">Standard</button><button data-mode="brave" class="mode-btn px-3 py-1 text-sm font-semibold rounded-md">Brave Draft (MCC)</button></div></div><div class="flex items-center gap-4 flex-wrap"><div id="admin-tools" class="hidden items-center gap-2"><button id="exportBtn" class="px-3 py-2 text-sm rounded-xl bg-slate-200">–≠–∫—Å–ø–æ—Ä—Ç JSON</button><label class="px-3 py-2 text-sm rounded-xl bg-slate-200 cursor-pointer">–ò–º–ø–æ—Ä—Ç JSON<input id="importInput" type="file" accept="application/json" class="hidden" /></label><button id="deleteAllBtn" class="px-3 py-2 text-sm rounded-xl bg-rose-600 text-white">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button></div><div id="userInfo" class="text-sm flex items-center gap-3"><span id="userEmail" class="text-slate-600"></span><button id="logoutBtn" class="px-3 py-2 rounded-xl bg-slate-200">–í—ã–π—Ç–∏</button></div><input id="imgBaseInput" class="hidden sm:block w-64 px-3 py-2 rounded-xl bg-slate-100" placeholder="–ü–∞–ø–∫–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤: ./portraits/" /><button id="themeToggle" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300" title="–¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">üåô</button></div></header>
    <nav class="inline-flex rounded-2xl bg-white shadow ring-1 ring-slate-200 overflow-hidden mb-4 overflow-x-auto">
      <button data-tab="stats" class="tab-btn px-4 py-2 text-sm font-medium bg-slate-900 text-white whitespace-nowrap">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button data-tab="matches" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 whitespace-nowrap">–ú–∞—Ç—á–∏</button>
      <button data-tab="matchups" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 whitespace-nowrap">–ú–∞—Ç—á–∞–ø—ã</button>
      <button data-tab="team-analysis" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 whitespace-nowrap">–ê–Ω–∞–ª–∏–∑ –ö–æ–º–∞–Ω–¥—ã</button>
      <button data-tab="draft-helper" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 whitespace-nowrap text-indigo-600 font-bold">Draft Helper (AI)</button>
      <button id="inputTabBtn" data-tab="input" class="tab-btn px-4 py-2 text-sm font-medium hover:bg-slate-100 hidden whitespace-nowrap">–í–≤–æ–¥ –º–∞—Ç—á–∞</button>
    </nav>
    
    <!-- –í–í–û–î –ú–ê–¢–ß–ê -->
    <section id="tab-input" class="hidden fade-in"><form id="matchForm" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-5 gap-4"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–õ–∏–≥–∞</label><input name="league" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="MPL / MDL‚Ä¶" required /></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–ü–∞—Ç—á</label><input name="patch" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–Ω–∞–ø—Ä. 1.8.80" required /></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–î–∞—Ç–∞</label><input type="date" name="date" class="w-full px-3 py-2 rounded-xl bg-slate-100" /></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–¢–∏–ø –∫–∞—Ä—Ç—ã</label><select name="terrain" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option><option value="—Å—Ç–µ–Ω—ã">–°—Ç–µ–Ω—ã</option><option value="–æ–±–ª–∞–∫–∞">–û–±–ª–∞–∫–∞</option><option value="—Ä–µ–∫–∞">–†–µ–∫–∞</option><option value="–∫—É—Å—Ç—ã">–ö—É—Å—Ç—ã</option></select></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</label><div class="flex items-center gap-4 mt-2"><label class="inline-flex items-center gap-2"><input type="radio" name="winner" value="blue"/> –°–∏–Ω—è—è</label><label class="inline-flex items-center gap-2"><input type="radio" name="winner" value="red"/> –ö—Ä–∞—Å–Ω–∞—è</label></div></div></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><label class="block text-sm font-medium mb-1">–†–µ–∂–∏–º –¥—Ä–∞—Ñ—Ç–∞</label><div class="flex items-center gap-4 mt-2"><label class="inline-flex items-center gap-2"><input type="radio" name="draft_mode" value="standard" checked/> Standard</label><label class="inline-flex items-center gap-2"><input type="radio" name="draft_mode" value="brave"/> Brave Draft</label></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><h2 class="font-semibold mb-2">–°–∏–Ω—è—è –∫–æ–º–∞–Ω–¥–∞</h2><input name="blueTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-3" placeholder="Blue Team" required /><div class="grid grid-cols-1 lg:grid-cols-2 gap-3"><div><div class="text-sm font-medium mb-1">–ë–∞–Ω—ã (5)</div><div id="blueBans" class="space-y-2"></div></div><div><div class="text-sm font-medium mb-1">–ü–∏–∫–∏ (5)</div><div id="bluePicks" class="space-y-2"></div></div></div></div><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><h2 class="font-semibold mb-2">–ö—Ä–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</h2><input name="redTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-3" placeholder="Red Team" required /><div class="grid grid-cols-1 lg:grid-cols-2 gap-3"><div><div class="text-sm font-medium mb-1">–ë–∞–Ω—ã (5)</div><div id="redBans" class="space-y-2"></div></div><div><div class="text-sm font-medium mb-1">–ü–∏–∫–∏ (5)</div><div id="redPicks" class="space-y-2"></div></div></div></div></div><div class="flex items-center gap-3"><button id="saveMatchBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á</button><button id="resetForm" class="px-4 py-2 rounded-xl bg-slate-200" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button><button id="cancelEditBtn" class="px-4 py-2 rounded-xl bg-amber-500 text-white hidden" type="button">–û—Ç–º–µ–Ω–∞</button></div></form></section>
    
    <!-- DRAFT HELPER -->
    <section id="tab-draft-helper" class="hidden fade-in">
      <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
        
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –î–æ—Å–∫–∞ -->
        <div class="xl:col-span-8 space-y-4">
          <!-- –°–∏–ª–∞ –î—Ä–∞—Ñ—Ç–∞ –ë–∞—Ä -->
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
             <div class="flex justify-between items-center text-xs font-bold uppercase mb-1">
                <span class="text-blue-600">–®–∞–Ω—Å –°–∏–Ω–∏—Ö: <span id="dh-win-prob-blue">50%</span></span>
                <span class="text-slate-400">–°–∏–ª–∞ –¥—Ä–∞—Ñ—Ç–∞ (Win Prob)</span>
                <span class="text-red-600">–®–∞–Ω—Å –ö—Ä–∞—Å–Ω—ã—Ö: <span id="dh-win-prob-red">50%</span></span>
             </div>
             <div class="strength-bar-container mb-3">
                <div id="dh-strength-bar-fill" class="strength-bar-blue" style="width: 50%;"></div>
                <div class="strength-bar-red"></div>
             </div>
             <!-- Draft Summary Block -->
             <div id="dh-draft-summary">
                <div class="text-center text-slate-400 italic text-xs py-2">–ù–∞—á–Ω–∏—Ç–µ –≤—ã–±–æ—Ä –≥–µ—Ä–æ–µ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...</div>
             </div>
          </div>

          <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
              <div>
                <label class="block text-xs font-medium mb-1 text-slate-500 uppercase tracking-wide">–í–∞—à–∞ —Å—Ç–æ—Ä–æ–Ω–∞</label>
                <div class="flex bg-slate-100 rounded-xl p-1">
                  <button id="dh-side-blue" class="flex-1 py-1.5 text-sm font-medium rounded-lg bg-white shadow text-blue-700">–°–∏–Ω—è—è (FP)</button>
                  <button id="dh-side-red" class="flex-1 py-1.5 text-sm font-medium rounded-lg text-slate-500">–ö—Ä–∞—Å–Ω–∞—è</button>
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-slate-500 uppercase tracking-wide">–ü–∞—Ç—á</label>
                <select id="dh-filter-patch" class="w-full px-3 py-2 rounded-xl bg-slate-100 font-bold border-none outline-none focus:ring-2 focus:ring-indigo-500"></select>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-slate-500 uppercase tracking-wide">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</label>
                <select id="dh-enemy-team" class="w-full px-3 py-2 rounded-xl bg-slate-100 font-bold border-none outline-none focus:ring-2 focus:ring-indigo-500"></select>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-slate-500 uppercase tracking-wide">–§–∏–ª—å—Ç—Ä –†–æ–ª–∏</label>
                <select id="dh-filter-role" class="w-full px-3 py-2 rounded-xl bg-slate-100 font-bold border-none outline-none focus:ring-2 focus:ring-indigo-500">
                   <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                   <option value="exp">EXP Lane</option>
                   <option value="jungle">Jungle</option>
                   <option value="mid">Mid Lane</option>
                   <option value="roam">Roamer</option>
                   <option value="gold">Gold Lane</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-slate-500 uppercase tracking-wide">–î–µ–π—Å—Ç–≤–∏—è</label>
                <div class="flex gap-2">
                  <button id="dh-reset" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-xl text-sm font-medium">–°–±—Ä–æ—Å</button>
                  <div class="combo flex-1">
                     <input id="dh-picker-input" class="w-full px-3 py-2 rounded-xl bg-slate-900 text-white placeholder-slate-400" placeholder="–ü–æ–∏—Å–∫..." disabled />
                     <div class="combo-list hidden text-slate-900"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- –î–æ—Å–∫–∞ –î—Ä–∞—Ñ—Ç–∞ -->
          <div class="bg-white p-6 rounded-2xl shadow ring-1 ring-slate-200">
             <div class="grid grid-cols-2 gap-8">
                <!-- BLUE TEAM -->
                <div>
                   <h3 class="font-bold text-blue-600 mb-3 flex items-center gap-2">
                     <span class="w-2 h-2 rounded-full bg-blue-600"></span> –°–∏–Ω—è—è –∫–æ–º–∞–Ω–¥–∞
                   </h3>
                   <div class="space-y-4">
                      <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-1 ml-1">–ë–∞–Ω—ã</div>
                        <div class="grid grid-cols-5 gap-2" id="dh-blue-bans"></div>
                      </div>
                      <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-1 ml-1">–ü–∏–∫–∏</div>
                        <div class="space-y-2" id="dh-blue-picks"></div>
                      </div>
                   </div>
                </div>
                <!-- RED TEAM -->
                <div>
                   <h3 class="font-bold text-red-600 mb-3 flex items-center gap-2 justify-end">
                     –ö—Ä–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ <span class="w-2 h-2 rounded-full bg-red-600"></span>
                   </h3>
                   <div class="space-y-4">
                      <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-1 mr-1 text-right">–ë–∞–Ω—ã</div>
                        <div class="grid grid-cols-5 gap-2" id="dh-red-bans"></div>
                      </div>
                      <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-1 mr-1 text-right">–ü–∏–∫–∏</div>
                        <div class="space-y-2" id="dh-red-picks"></div>
                      </div>
                   </div>
                </div>
             </div>
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div class="xl:col-span-4 space-y-4">
          <div class="bg-slate-900 text-white p-4 rounded-2xl shadow-lg relative overflow-hidden">
             <div class="relative z-10">
               <h3 class="font-bold text-lg mb-1">–°–æ–≤–µ—Ç–Ω–∏–∫ –î—Ä–∞—Ñ—Ç–∞ (AI)</h3>
               <p id="dh-status-text" class="text-xs text-slate-400">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞...</p>
             </div>
             <div class="absolute right-0 top-0 opacity-10 text-9xl leading-none">?</div>
          </div>

          <!-- –ë–ª–æ–∫ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
          <div id="dh-preview-container" class="bg-white p-3 rounded-2xl shadow ring-1 ring-slate-200 hidden">
             <label class="block text-xs font-medium mb-1 text-slate-500 uppercase tracking-wide">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ—Ä–æ—è</label>
             <div class="combo w-full">
                <input id="dh-preview-input" class="w-full px-3 py-2 rounded-xl bg-slate-100 text-sm font-medium" placeholder="–ù–∞–π—Ç–∏ –∏ –æ—Ü–µ–Ω–∏—Ç—å..." />
                <div class="combo-list hidden text-slate-900"></div>
             </div>
             <div id="dh-preview-result" class="mt-2 space-y-2"></div>
          </div>

          <div id="dh-suggestions-container" class="space-y-3 hidden">
             <!-- –ë–ª–æ–∫: –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–∞–Ω—ã -->
             <div id="dh-suggest-bans" class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 hidden">
                <h4 class="text-xs font-bold text-rose-600 uppercase mb-3">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–∞–Ω—ã</h4>
                <div id="dh-list-bans" class="space-y-2"></div>
             </div>

             <!-- –ë–ª–æ–∫: –í—Ä–∞–≥ —á–∞—Å—Ç–æ –±–µ—Ä–µ—Ç -->
             <div id="dh-enemy-comfort" class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 hidden">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">–ö–æ–º—Ñ–æ—Ä—Ç –≤—Ä–∞–≥–∞ / –û–∂–∏–¥–∞–µ–º—ã–π –ø–∏–∫</h4>
                <div id="dh-list-enemy-comfort" class="space-y-2"></div>
             </div>

             <!-- –ë–ª–æ–∫: –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∏–∫–∏ -->
             <div id="dh-suggest-picks" class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 hidden">
                <h4 class="text-xs font-bold text-emerald-600 uppercase mb-3">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∏–∫–∏</h4>
                <div id="dh-list-picks" class="space-y-2"></div>
             </div>

             <!-- –ë–ª–æ–∫: –û–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–ø–∏–∫–∏ -->
             <div id="dh-enemy-counters" class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 hidden">
                <h4 class="text-xs font-bold text-amber-600 uppercase mb-3">–û—Å—Ç–æ—Ä–æ–∂–Ω–æ! –ö–æ–Ω—Ç—Ä–ø–∏–∫–∏:</h4>
                <div id="dh-list-counters" class="space-y-2"></div>
             </div>
          </div>
          
          <div id="dh-empty-state" class="text-center py-10 text-slate-400 text-sm">
             –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Å–ª–æ—Ç –Ω–∞ –¥–æ—Å–∫–µ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º —Å–∏–Ω–µ—Ä–≥–∏–∏, –∫–æ–Ω—Ç—Ä–ø–∏–∫–æ–≤ –∏ –º–µ—Ç—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–∞—Ç—á–∞.
          </div>
        </div>
      </div>
    </section>

    <!-- –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <section id="tab-stats" class="hidden fade-in"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 mb-4"><div class="grid grid-cols-1 md:grid-cols-7 gap-3"><div><label class="block text-xs font-medium mb-1">–õ–∏–≥–∞</label><select id="filterLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–ü–∞—Ç—á</label><select id="filterPatch" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–ö–æ–º–∞–Ω–¥–∞</label><select id="filterTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–°—Ç–æ—Ä–æ–Ω–∞</label><select id="filterSide" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–í—Å–µ</option><option value="blue">–°–∏–Ω—è—è</option><option value="red">–ö—Ä–∞—Å–Ω–∞—è</option></select></div><div><label class="block text-xs font-medium mb-1">–†–æ–ª—å</label><select id="filterRole" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–í—Å–µ —Ä–æ–ª–∏</option><option value="exp">EXP</option><option value="jungle">Jungle</option><option value="mid">Mid</option><option value="roam">Roam</option><option value="gold">Gold</option></select></div><div><label class="block text-xs font-medium mb-1">–ö–∞—Ä—Ç–∞</label><select id="filterTerrain" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="">–í—Å–µ –∫–∞—Ä—Ç—ã</option><option value="—Å—Ç–µ–Ω—ã">–°—Ç–µ–Ω—ã</option><option value="–æ–±–ª–∞–∫–∞">–û–±–ª–∞–∫–∞</option><option value="—Ä–µ–∫–∞">–†–µ–∫–∞</option><option value="–∫—É—Å—Ç—ã">–ö—É—Å—Ç—ã</option></select></div><div><label class="block text-xs font-medium mb-1">–ü–æ–∏—Å–∫ –≥–µ—Ä–æ—è</label><input id="searchHero" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" class="w-full px-3 py-2 rounded-xl bg-slate-100" /></div></div></div><div class="bg-white rounded-2xl shadow ring-1 ring-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-100 text-slate-600"><tr><th class="px-4 py-2 text-left sortable" data-sort="hero"><span>–ì–µ—Ä–æ–π</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable sorted" data-sort="presence"><span>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</span><span class="sort-icon">‚ñº</span></th><th class="px-4 py-2 text-right sortable" data-sort="picks"><span>–ò–≥—Ä</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="winrate"><span>–í–∏–Ω—Ä–µ–π—Ç</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="wins"><span>–ü–æ–±–µ–¥—ã</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="losses"><span>–ü–æ—Ä–∞–∂–µ–Ω–∏—è</span><span class="sort-icon"></span></th><th class="px-4 py-2 text-right sortable" data-sort="bans"><span>–ë–∞–Ω—ã</span><span class="sort-icon"></span></th></tr></thead><tbody id="statsBody" class="divide-y divide-slate-100"></tbody></table></div><div class="p-3 text-xs text-slate-500">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–µ—Ä–æ—è –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.</div></div></section>
    
    <!-- –°–ü–ò–°–û–ö –ú–ê–¢–ß–ï–ô -->
    <section id="tab-matches" class="hidden fade-in"><div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"><div><label class="block text-xs font-medium mb-1">–§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–∞–Ω–¥–µ</label><select id="filterMatchesTeam" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–§–∏–ª—å—Ç—Ä –ø–æ –ª–∏–≥–µ</label><select id="filterMatchesLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–§–∏–ª—å—Ç—Ä –ø–æ –≥–µ—Ä–æ—é</label><select id="filterMatchesHero" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select></div><div><label class="block text-xs font-medium mb-1">–¢–∏–ø —É—á–∞—Å—Ç–∏—è</label><select id="filterMatchesType" class="w-full px-3 py-2 rounded-xl bg-slate-100"><option value="presence">–ü–∏–∫–∏ –∏ –ë–∞–Ω—ã</option><option value="pick">–¢–æ–ª—å–∫–æ –ø–∏–∫–∏</option></select></div></div><div id="matchesList" class="grid gap-3"></div></div></section>
    
    <!-- –ú–ê–¢–ß–ê–ü–´ –ò –°–ò–ù–ï–†–ì–ò–Ø -->
    <section id="tab-matchups" class="hidden fade-in">
      <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="md:col-span-1">
            <label class="block text-xs font-medium mb-1">–ì–µ—Ä–æ–π –ê</label>
            <div class="combo flex-1"><input id="matchupHeroA" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è" /><div class="combo-list hidden"></div></div>
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs font-medium mb-1">–ì–µ—Ä–æ–π –ë</label>
            <div class="combo flex-1"><input id="matchupHeroB" class="w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è" /><div class="combo-list hidden"></div></div>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">–õ–∏–≥–∞</label>
            <select id="filterMatchupLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">–ü–∞—Ç—á</label>
            <select id="filterMatchupPatch" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select>
          </div>
        </div>
        <hr class="border-slate-200 dark:border-slate-700"/>
        <div id="matchupResultsContainer" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-slate-50 rounded-xl p-4">
              <h3 class="font-semibold mb-2">–°–∏–Ω–µ—Ä–≥–∏—è (–≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ)</h3>
              <div id="matchupSynergyResult" class="text-sm space-y-1"></div>
            </div>
            <div class="bg-slate-50 rounded-xl p-4">
              <h3 class="font-semibold mb-2">–ü—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è–Ω–∏–µ (–¥—Ä—É–≥ –ø—Ä–æ—Ç–∏–≤ –¥—Ä—É–≥–∞)</h3>
              <div id="matchupCounterResult" class="text-sm space-y-1"></div>
              <hr class="border-slate-200 dark:border-slate-600 my-3"/>
              <div class="space-y-3">
                <div>
                  <h4 id="matchupBestTeammatesForA_title" class="text-xs font-medium text-slate-500 mb-2"></h4>
                  <div id="matchupBestTeammatesForA" class="text-sm space-y-1"></div>
                </div>
                <div>
                  <h4 id="matchupBestTeammatesForB_title" class="text-xs font-medium text-slate-500 mb-2"></h4>
                  <div id="matchupBestTeammatesForB" class="text-sm space-y-1"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-sm">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏</h3>
              <div>
                <label class="text-xs font-medium mr-2">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                <select id="matchupMatchFilter" class="px-2 py-1 text-sm rounded-xl bg-slate-100">
                  <option value="all">–í—Å–µ –º–∞—Ç—á–∏</option>
                  <option value="synergy">–¢–æ–ª—å–∫–æ —Å–æ—é–∑–Ω–∏–∫–∏</option>
                  <option value="counter">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏</option>
                </select>
              </div>
            </div>
            <div id="matchupMatchesList" class="grid gap-3"></div>
          </div>
        </div>
        <div id="matchupPlaceholder" class="text-center py-8 text-slate-500">
          –í—ã–±–µ—Ä–∏—Ç–µ –¥–≤—É—Ö –≥–µ—Ä–æ–µ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.
        </div>
      </div>
    </section>

    <!-- –ê–ù–ê–õ–ò–ó –ö–û–ú–ê–ù–î–´ -->
    <section id="tab-team-analysis" class="hidden fade-in">
      <div class="space-y-4">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium mb-1">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</label>
              <select id="analysisTeamSelect" class="w-full px-3 py-2 rounded-xl bg-slate-100 font-bold"></select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">–õ–∏–≥–∞</label>
              <select id="analysisLeague" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">–ü–∞—Ç—á</label>
              <select id="analysisPatch" class="w-full px-3 py-2 rounded-xl bg-slate-100"></select>
            </div>
          </div>
        </div>

        <div id="teamAnalysisContent" class="hidden space-y-4">
          <!-- –û–±—â–∞—è —Å–≤–æ–¥–∫–∞ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200 flex flex-col justify-center items-center">
              <div class="text-sm text-slate-500">–í—Å–µ–≥–æ –∏–≥—Ä</div>
              <div id="ta-total-games" class="text-3xl font-bold">0</div>
              <div id="ta-winrate" class="text-sm font-medium mt-1">0% WR</div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <div class="text-xs text-slate-500 mb-2">–°—Ç–æ—Ä–æ–Ω—ã</div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-blue-600 font-bold">–°–∏–Ω—è—è</span>
                <span id="ta-blue-wr"></span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-2 mb-3">
                <div id="ta-blue-bar" class="bg-blue-500 h-2 rounded-full" style="width: 50%"></div>
              </div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-red-600 font-bold">–ö—Ä–∞—Å–Ω–∞—è</span>
                <span id="ta-red-wr"></span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-2">
                <div id="ta-red-bar" class="bg-red-500 h-2 rounded-full" style="width: 50%"></div>
              </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <div class="text-xs text-slate-500 mb-2">First Pick (FP) –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
              <div class="text-center mb-2">
                <div id="ta-fp-games" class="font-medium text-sm"></div>
                <div id="ta-fp-wr" class="text-xl font-bold text-emerald-600"></div>
              </div>
              <div class="border-t border-slate-100 pt-2">
                <div class="text-[10px] text-slate-400 uppercase tracking-wide mb-1">–¢–æ–ø FP –ì–µ—Ä–æ–∏</div>
                <div id="ta-fp-top-heroes" class="space-y-1"></div>
              </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <div class="text-xs text-slate-500 mb-2">–°—Ç–∏–ª—å –¥—Ä–∞—Ñ—Ç–∞</div>
              <div class="space-y-2 text-sm">
                 <div class="flex justify-between"><span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –§—É–ª–ª –ü–∞—Ç–∏:</span> <span id="ta-style-trio" class="font-medium"></span></div>
                 <div class="flex justify-between"><span>–§–ª–µ–∫—Å –ø–∏–∫–∏:</span> <span id="ta-style-flex" class="font-medium"></span></div>
              </div>
            </div>
          </div>

          <!-- –ü–∏–∫–∏ –∏ –§–∞–∑—ã -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <h3 class="font-bold text-lg mb-3">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ü–∏–∫–∞ (–¢–æ–ø-7)</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                  <thead class="text-xs text-slate-500 bg-slate-50 uppercase">
                    <tr>
                      <th class="px-2 py-2">–ì–µ—Ä–æ–π</th>
                      <th class="px-2 py-2 text-center">–ü–∏–∫–æ–≤</th>
                      <th class="px-2 py-2 text-center">WR</th>
                      <th class="px-2 py-2 text-center text-[10px]">–§–∞–∑–∞ 1 (1-3)</th>
                      <th class="px-2 py-2 text-center text-[10px]">–§–∞–∑–∞ 2 (4-5)</th>
                    </tr>
                  </thead>
                  <tbody id="ta-top-picks-body"></tbody>
                </table>
              </div>
            </div>
            
            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <h3 class="font-bold text-lg mb-3">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –†–æ–ª–µ–π (–°—Ç–∞–¥–∏—è 1)</h3>
              <p class="text-xs text-slate-500 mb-4">–ö–∞–∫–∏–µ —Ä–æ–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–±–∏—Ä–∞–µ—Ç –≤ –ø–µ—Ä–≤–æ–π —Ç—Ä–æ–π–∫–µ –ø–∏–∫–æ–≤?</p>
              <div id="ta-role-priority" class="space-y-3"></div>
            </div>
          </div>

          <!-- –ë–∞–Ω—ã –∏ –û—Ç–≤–µ—Ç—ã -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
             <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <h3 class="font-bold text-lg mb-3">–¢–æ–ø –ë–∞–Ω—ã (–ü—Ä–æ—Ç–∏–≤ –Ω–∏—Ö / –ò–º–∏)</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-xs font-semibold text-center mb-2 text-rose-600">–û–Ω–∏ –±–∞–Ω—è—Ç (Respect Ban)</div>
                  <div id="ta-bans-by-them" class="space-y-1"></div>
                </div>
                <div>
                  <div class="text-xs font-semibold text-center mb-2 text-slate-600">–ü—Ä–æ—Ç–∏–≤ –Ω–∏—Ö –±–∞–Ω—è—Ç</div>
                  <div id="ta-bans-against-them" class="space-y-1"></div>
                </div>
              </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
              <h3 class="font-bold text-lg mb-3">–ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –≤–æ–∫—Ä—É–≥ –≥–µ—Ä–æ—è</h3>
              <p class="text-xs text-slate-500 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ –∫–æ–º–∞–Ω–¥–∞ –∏–≥—Ä–∞–µ—Ç, –∫–æ–≥–¥–∞ –æ–Ω –≤ –±–∞–Ω–µ –∏–ª–∏ —É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.</p>
              <div class="flex gap-2 mb-2">
                <div class="combo flex-1"><input id="ta-condition-ban" class="w-full px-3 py-2 rounded-xl bg-slate-100 text-sm" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è..." /><div class="combo-list hidden"></div></div>
              </div>
              <div id="ta-condition-results" class="text-sm space-y-2 mt-4 min-h-[100px]">
                <span class="text-slate-400 text-xs">–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞...</span>
              </div>
            </div>
          </div>

          <!-- –°–≤—è–∑–∫–∏ -->
          <div class="bg-white p-4 rounded-2xl shadow ring-1 ring-slate-200">
            <h3 class="font-bold text-lg mb-3">–õ—É—á—à–∏–µ –°–≤—è–∑–∫–∏</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 class="font-semibold text-sm mb-2 text-indigo-600">–î—É–æ (2 –≥–µ—Ä–æ—è)</h4>
                <div id="ta-duos" class="space-y-1"></div>
              </div>
              <div>
                <h4 class="font-semibold text-sm mb-2 text-indigo-600">–¢—Ä–∏–æ (3 –≥–µ—Ä–æ—è)</h4>
                <div id="ta-trios" class="space-y-1"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="teamAnalysisPlaceholder" class="text-center py-12 text-slate-500">
          –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
        </div>
      </div>
    </section>

  </div>
  <div id="heroModal" class="fixed inset-0 bg-black/40 z-50 hidden"><div class="min-h-full w-full flex items-center justify-center p-4"><div class="bg-white w-full max-w-4xl rounded-2xl shadow-xl ring-1 ring-slate-200 overflow-hidden"><div class="flex items-center justify-between px-5 py-3 border-b"><div><h3 id="modalHeroName" class="text-lg font-semibold"></h3><p id="modalHeroSubtitle" class="text-xs text-slate-500"></p></div><button id="closeModal" class="p-2 rounded-lg hover:bg-slate-100">‚úï</button></div><div class="p-5 space-y-6 max-h-[75vh] overflow-y-auto scroll-thin"><div class="grid grid-cols-1 md:grid-cols-3 gap-3"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-1">–û–±—â–µ–µ</div><div id="modalSummary" class="text-sm"></div></div><div class="bg-slate-50 rounded-xl p-4 md:col-span-2"><div class="text-xs text-slate-500 mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è–º</div><div id="modalRoles" class="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–¢–æ–ø‚Äë10 —Å–∏–Ω–µ—Ä–≥–∏–π (—Å–æ—é–∑–Ω–∏–∫–∏)</div><div id="modalSynergy" class="text-sm space-y-1"></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ú–∞—Ç—á–∞–ø—ã</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-3 text-sm"><div><div class="font-medium mb-1">–õ—É—á—à–µ –ø—Ä–æ—Ç–∏–≤</div><div id="modalBestVs" class="space-y-1"></div></div><div><div class="font-medium mb-1">–°–ª–æ–∂–Ω–æ –ø—Ä–æ—Ç–∏–≤</div><div id="modalWorstVs" class="space-y-1"></div></div></div></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ü–æ–∑–∏—Ü–∏–∏ –≤ –¥—Ä–∞—Ñ—Ç–µ</div><div id="modalDraftPositions" class="text-sm grid grid-cols-2 lg:grid-cols-4 gap-2"></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏ (–ø–∏–∫–∏)</div><div id="modalTeams" class="text-sm space-y-1"></div></div><div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500 mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–∞–º</div><div id="modalTerrains" class="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2"></div></div></div></div></div></div>
  <template id="banRowTpl"><div class="flex items-center gap-2"><div class="w-10 text-xs text-slate-500">#<span class="ord"></span></div><div class="combo flex-1"><input class="banHero w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ì–µ—Ä–æ–π" /><div class="combo-list hidden"></div></div></div></template>
  <template id="pickRowTpl"><div class="flex items-center gap-2"><div class="w-10 text-xs text-slate-500">#<span class="ord"></span></div><div class="combo flex-1"><input class="pickHero w-full px-3 py-2 rounded-xl bg-slate-100" placeholder="–ì–µ—Ä–æ–π" /><div class="combo-list hidden"></div></div><select class="pickRole w-28 px-2 py-2 rounded-xl bg-slate-100 text-sm"><option value="">–†–æ–ª—å‚Ä¶</option><option value="exp">EXP</option><option value="jungle">Jungle</option><option value="mid">Mid</option><option value="roam">Roam</option><option value="gold">Gold</option></select></div></template>
  
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/+esm';

  document.addEventListener('DOMContentLoaded', async () => {

    const SUPABASE_URL = 'https://fsrhkwyyedkxmlooddjn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzcmhrd3l5ZWRreG1sb29kZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NzQ4NTUsImV4cCI6MjA3MjA1MDg1NX0.JlftKlupkTtFBIkXdWNL-DigdFRc9DVAP48VXmh3fgg';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let allMatches = [];
    let standardMatches = [];
    let braveMatches = [];
    let currentMode = 'standard';
    let currentUser = null;
    let currentUserRole = 'user';
    let sortState = { key: 'presence', direction: 'desc' };
    let editingMatchId = null;
    
    // Draft Helper State
    let draftState = {
       mySide: 'blue', 
       enemyTeam: '',
       patch: '',
       roleFilter: '', // New Filter
       activeSlot: null,
       blue: { bans: Array(5).fill(''), picks: Array(5).fill(null) },
       red: { bans: Array(5).fill(''), picks: Array(5).fill(null) }
    };
    // Helper to get hero string safely
    const getHero = (val) => val ? (typeof val === 'string' ? val : val.hero) : '';
    const getRole = (val) => val ? (typeof val === 'object' ? val.role : null) : null;


    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const showLoginBtn = document.getElementById('show-login-btn');
    const showSignupBtn = document.getElementById('show-signup-btn');
    const userEmailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const inputTabBtn = document.getElementById('inputTabBtn');
    const themeToggle = document.getElementById('themeToggle');
    const imgBaseInput = document.getElementById('imgBaseInput');
    const adminTools = document.getElementById('admin-tools');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const banRowTpl = document.getElementById('banRowTpl'); 
    const pickRowTpl = document.getElementById('pickRowTpl');
    const blueBansEl = document.getElementById('blueBans'); 
    const redBansEl = document.getElementById('redBans');
    const bluePicksEl = document.getElementById('bluePicks'); 
    const redPicksEl = document.getElementById('redPicks');
    const matchesListEl = document.getElementById('matchesList');
    const filterLeague=document.getElementById('filterLeague'), filterPatch=document.getElementById('filterPatch'), filterTeam=document.getElementById('filterTeam'), filterSide=document.getElementById('filterSide'), filterRole=document.getElementById('filterRole'), filterTerrain=document.getElementById('filterTerrain'), searchHero=document.getElementById('searchHero'), statsBody=document.getElementById('statsBody');
    const heroModal=document.getElementById('heroModal');
    const filterMatchesTeam = document.getElementById('filterMatchesTeam');
    const filterMatchesLeague = document.getElementById('filterMatchesLeague');
    const filterMatchesHero = document.getElementById('filterMatchesHero');
    const filterMatchesType = document.getElementById('filterMatchesType');
    const saveMatchBtn = document.getElementById('saveMatchBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const matchForm = document.getElementById('matchForm');
    const draftModeToggle = document.getElementById('draft-mode-toggle');

    // Matchups Elements
    const matchupHeroAInput = document.getElementById('matchupHeroA');
    const matchupHeroBInput = document.getElementById('matchupHeroB');
    const filterMatchupLeague = document.getElementById('filterMatchupLeague');
    const filterMatchupPatch = document.getElementById('filterMatchupPatch');
    const matchupResultsContainer = document.getElementById('matchupResultsContainer');
    const matchupPlaceholder = document.getElementById('matchupPlaceholder');
    const matchupSynergyResultEl = document.getElementById('matchupSynergyResult');
    const matchupCounterResultEl = document.getElementById('matchupCounterResult');
    const matchupMatchesListEl = document.getElementById('matchupMatchesList');
    const matchupBestTeammatesForAEl = document.getElementById('matchupBestTeammatesForA');
    const matchupBestTeammatesForBEl = document.getElementById('matchupBestTeammatesForB');
    const matchupBestTeammatesForA_title = document.getElementById('matchupBestTeammatesForA_title');
    const matchupBestTeammatesForB_title = document.getElementById('matchupBestTeammatesForB_title');
    const matchupMatchFilter = document.getElementById('matchupMatchFilter');

    // Team Analysis Elements
    const tabTeamAnalysis = document.getElementById('tab-team-analysis');
    const analysisTeamSelect = document.getElementById('analysisTeamSelect');
    const analysisLeague = document.getElementById('analysisLeague');
    const analysisPatch = document.getElementById('analysisPatch');
    const teamAnalysisContent = document.getElementById('teamAnalysisContent');
    const teamAnalysisPlaceholder = document.getElementById('teamAnalysisPlaceholder');
    const taConditionBanInput = document.getElementById('ta-condition-ban');

    // Draft Helper Elements
    const dhSideBlue = document.getElementById('dh-side-blue');
    const dhSideRed = document.getElementById('dh-side-red');
    const dhFilterPatch = document.getElementById('dh-filter-patch');
    const dhEnemyTeam = document.getElementById('dh-enemy-team');
    const dhReset = document.getElementById('dh-reset');
    const dhPickerInput = document.getElementById('dh-picker-input');
    const dhBlueBans = document.getElementById('dh-blue-bans');
    const dhBluePicks = document.getElementById('dh-blue-picks');
    const dhRedBans = document.getElementById('dh-red-bans');
    const dhRedPicks = document.getElementById('dh-red-picks');
    const dhStatusText = document.getElementById('dh-status-text');
    const dhSuggestionsContainer = document.getElementById('dh-suggestions-container');
    const dhEmptyState = document.getElementById('dh-empty-state');
    const dhSuggestBans = document.getElementById('dh-suggest-bans');
    const dhEnemyComfort = document.getElementById('dh-enemy-comfort');
    const dhSuggestPicks = document.getElementById('dh-suggest-picks');
    const dhEnemyCounters = document.getElementById('dh-enemy-counters');
    const dhListBans = document.getElementById('dh-list-bans');
    const dhListEnemyComfort = document.getElementById('dh-list-enemy-comfort');
    const dhListPicks = document.getElementById('dh-list-picks');
    const dhListCounters = document.getElementById('dh-list-counters');
    const dhStrengthBarFill = document.getElementById('dh-strength-bar-fill');
    const dhWinProbBlue = document.getElementById('dh-win-prob-blue');
    const dhWinProbRed = document.getElementById('dh-win-prob-red');
    const dhDraftSummary = document.getElementById('dh-draft-summary');
    const dhFilterRole = document.getElementById('dh-filter-role');
    
    // New Elements for Preview
    const dhPreviewContainer = document.getElementById('dh-preview-container');
    const dhPreviewInput = document.getElementById('dh-preview-input');
    const dhPreviewResult = document.getElementById('dh-preview-result');

    const HEROES = ["Aamon","Akai","Aldous","Alice","Alpha","Alucard","Angela","Argus","Arlott","Atlas","Aulus","Aurora","Badang","Balmond","Bane","Barats","Baxia","Beatrix","Belerick","Benedetta","Brody","Bruno","Carmilla","Cecilion","Chang'e","Chip","Chou","Cici","Claude","Clint","Cyclops","Diggie","Dyrroth","Edith","Esmeralda","Estes","Eudora","Fanny","Faramis","Floryn","Franco","Fredrinn","Freya","Gatotkaca","Gloo","Gord","Granger","Grock","Guinevere","Gusion","Hanabi","Hanzo","Harith","Harley","Hayabusa","Helcurt","Hilda","Hylos","Irithel","Ixia","Jawhead","Johnson","Joy","Julian","Kadita","Kagura","Kaja","Kalea","Karina","Karrie","Khaleed","Khufra","Kimmy","Lancelot","Lapu-Lapu","Layla","Leomord","Lesley","Ling","Lolita","Lukas","Lunox","Luo Yi","Lylia","Martis","Masha","Mathilda","Melissa","Minotaur","Minsitthar","Miya","Moskov","Nana","Natalia","Natan","Nolan","Novaria","Obsidia","Odette","Paquito","Pharsa","Phoveus","Popol and Kupa","Rafaela","Roger","Ruby","Saber","Selena","Silvanna","Sora","Sun","Suyou","Terizla","Thamuz","Tigreal","Uranus","Vale","Valentina","Valir","Vexana","Wanwan","X.Borg","Xavier","Yi Sun-shin","Yin","Yu Zhong","Yve","Zetian","Zhask","Zhuxin","Zilong"];
    const LS_IMG = 'mlbb_portraits_base_v1';
    const LS_FORM = 'mlbb_draft_form_v1';

    const showLoader = () => { if (!document.getElementById('loader')) { document.body.insertAdjacentHTML('beforeend', '<div id="loader" style="backdrop-filter: blur(4px);" class="fixed inset-0 bg-slate-50/70 flex items-center justify-center z-50"><p class="text-lg font-medium">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>'); } };
    const hideLoader = () => { document.getElementById('loader')?.remove(); };

    const fetchUserProfile = async (user) => {
      if (!user) return 'user';
      const { data, error } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (error) { console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error.message); return 'user'; }
      return data ? data.role : 'user';
    };

    const fetchMatches = async () => {
        const { data, error } = await supabase.from('matches').select('*').order('created_at', { ascending: false });
        if (error) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π:', error); return []; }
        return data.map(m => ({ id: m.id, date: m.date, league: m.league, patch: m.patch, winner: m.winner, terrain: m.terrain, draft_mode: m.draft_mode || 'standard', blue: { team: m.blue_team, picks: m.blue_picks || [], bans: m.blue_bans || [] }, red: { team: m.red_team, picks: m.red_picks || [], bans: m.red_bans || [] } }));
    };

    const handleSessionChange = async (session, event) => {
        showLoader();
        currentUser = session?.user ?? null;
        currentUserRole = await fetchUserProfile(currentUser);

        if (currentUser && (currentUserRole === 'admin' || currentUserRole === 'viewer')) {
            if (allMatches.length === 0) {
                allMatches = await fetchMatches();
                standardMatches = allMatches.filter(m => m.draft_mode === 'standard');
                braveMatches = allMatches.filter(m => m.draft_mode === 'brave');
            }
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userEmailEl.textContent = currentUser.email;
            if (currentUserRole === 'admin') {
                inputTabBtn.classList.remove('hidden');
                adminTools.classList.remove('hidden');
                adminTools.classList.add('flex');
            } else {
                inputTabBtn.classList.add('hidden');
                adminTools.classList.add('hidden');
                adminTools.classList.remove('flex');
            }
        } else {
            allMatches = [];
            standardMatches = [];
            braveMatches = [];
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (currentUser && event === 'SIGNED_IN') {
                alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
                await supabase.auth.signOut();
            }
        }
        refreshUI();
        hideLoader();
    };
    
    function handleModeChange(newMode) {
        if (currentMode === newMode) return;
        currentMode = newMode;
        draftModeToggle.querySelectorAll('.mode-btn').forEach(btn => {
            if (btn.dataset.mode === newMode) {
                btn.classList.add('bg-white', 'dark:bg-slate-700', 'shadow');
            } else {
                btn.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow');
            }
        });
        refreshUI();
    }
    
    function getCurrentDataSet() {
        return currentMode === 'brave' ? braveMatches : standardMatches;
    }
    
    (function initializeStaticElements() {
        const THEME_KEY = 'mlbb_theme';
        const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
        if (savedTheme === 'dark') document.body.classList.add('dark');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            localStorage.setItem(THEME_KEY, document.body.classList.contains('dark') ? 'dark' : 'light');
        });
        imgBaseInput.value = getImgBase();
        imgBaseInput.addEventListener('change', () => setImgBase(imgBaseInput.value.trim() || './portraits/'));
        const initialDraft = readFormDraft();
        if (initialDraft) { applyFormDraft(initialDraft);
        } else { buildRows(blueBansEl, banRowTpl, 5); buildRows(redBansEl, banRowTpl, 5); buildRows(bluePicksEl, pickRowTpl, 5); buildRows(redPicksEl, pickRowTpl, 5); }
        showLoginBtn.addEventListener('click', () => {
            loginForm.classList.remove('hidden'); signupForm.classList.add('hidden');
            showLoginBtn.classList.add('border-slate-900', 'font-semibold'); showLoginBtn.classList.remove('text-slate-500');
            showSignupBtn.classList.remove('border-slate-900', 'font-semibold'); showSignupBtn.classList.add('text-slate-500');
        });
        showSignupBtn.addEventListener('click', () => {
            signupForm.classList.remove('hidden'); loginForm.classList.add('hidden');
            showSignupBtn.classList.add('border-slate-900', 'font-semibold'); showSignupBtn.classList.remove('text-slate-500');
            showLoginBtn.classList.remove('border-slate-900', 'font-semibold'); showLoginBtn.classList.add('text-slate-500');
        });
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) { alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            } else { alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∞ –∑–∞—Ç–µ–º –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.'); signupForm.reset(); showLoginBtn.click(); }
        });
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message); }
        });
        logoutBtn.addEventListener('click', async () => { await supabase.auth.signOut(); });
        document.getElementById('closeModal').onclick = () => heroModal.classList.add('hidden');
        heroModal.addEventListener('click', e => { if (e.target === heroModal) heroModal.classList.add('hidden'); });
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortState.key === key) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.key = key;
                    sortState.direction = 'desc';
                }
                renderStats();
            });
        });
        filterMatchesTeam.addEventListener('input', renderFilteredMatches);
        filterMatchesLeague.addEventListener('input', renderFilteredMatches);
        filterMatchesHero.addEventListener('input', renderFilteredMatches);
        filterMatchesType.addEventListener('input', renderFilteredMatches);
        [filterLeague,filterPatch,filterTeam,filterSide,filterRole,filterTerrain,searchHero].forEach(el=> el.addEventListener('input', renderStats));
        cancelEditBtn.addEventListener('click', cancelEditMatch);
        exportBtn.addEventListener('click', exportMatches);
        importInput.addEventListener('change', importMatches);
        deleteAllBtn.addEventListener('click', deleteAllMatches);
        draftModeToggle.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => handleModeChange(btn.dataset.mode));
        });
        
        // Matchups listeners
        attachCombobox(matchupHeroAInput.parentElement, matchupHeroAInput);
        attachCombobox(matchupHeroBInput.parentElement, matchupHeroBInput);
        const debouncedRenderMatchups = debounce(renderMatchups, 300);
        [matchupHeroAInput, matchupHeroBInput, filterMatchupLeague, filterMatchupPatch, matchupMatchFilter].forEach(el => {
            el.addEventListener('input', debouncedRenderMatchups);
            el.addEventListener('change', debouncedRenderMatchups);
        });

        // Team Analysis listeners
        [analysisTeamSelect, analysisLeague, analysisPatch].forEach(el => {
            el.addEventListener('change', renderTeamAnalysis);
        });
        attachCombobox(taConditionBanInput.parentElement, taConditionBanInput);
        taConditionBanInput.addEventListener('change', renderConditionalDraft);

        // Draft Helper Listeners
        dhSideBlue.addEventListener('click', () => {
            draftState.mySide = 'blue';
            dhSideBlue.classList.add('bg-white', 'shadow', 'text-blue-700'); dhSideBlue.classList.remove('text-slate-500');
            dhSideRed.classList.remove('bg-white', 'shadow', 'text-blue-700'); dhSideRed.classList.add('text-slate-500');
            updateDraftSuggestions();
        });
        dhSideRed.addEventListener('click', () => {
            draftState.mySide = 'red';
            dhSideRed.classList.add('bg-white', 'shadow', 'text-blue-700'); dhSideRed.classList.remove('text-slate-500');
            dhSideBlue.classList.remove('bg-white', 'shadow', 'text-blue-700'); dhSideBlue.classList.add('text-slate-500');
            updateDraftSuggestions();
        });
        dhEnemyTeam.addEventListener('change', (e) => {
            draftState.enemyTeam = e.target.value;
            updateDraftSuggestions();
            evaluateDraftStrength();
        });
        dhFilterPatch.addEventListener('change', (e) => {
            draftState.patch = e.target.value;
            updateDraftSuggestions();
            evaluateDraftStrength();
        });
        dhFilterRole.addEventListener('change', (e) => {
            draftState.roleFilter = e.target.value;
            updateDraftSuggestions();
        });
        dhReset.addEventListener('click', () => {
             draftState.blue.bans = Array(5).fill('');
             draftState.blue.picks = Array(5).fill(null);
             draftState.red.bans = Array(5).fill('');
             draftState.red.picks = Array(5).fill(null);
             draftState.activeSlot = null;
             renderDraftHelperBoard();
             dhEmptyState.classList.remove('hidden');
             dhSuggestionsContainer.classList.add('hidden');
             dhPickerInput.value = '';
             dhPickerInput.disabled = true;
             dhStatusText.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞...";
             dhPreviewContainer.classList.add('hidden');
             dhDraftSummary.innerHTML = '<div class="text-center text-slate-400 italic text-xs py-2">–ù–∞—á–Ω–∏—Ç–µ –≤—ã–±–æ—Ä –≥–µ—Ä–æ–µ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...</div>';
             evaluateDraftStrength();
        });
        attachCombobox(dhPickerInput.parentElement, dhPickerInput);
        dhPickerInput.addEventListener('change', (e) => {
             if (draftState.activeSlot && e.target.value) {
                 const {team, type, index} = draftState.activeSlot;
                 const val = e.target.value;
                 if (type === 'ban') {
                    draftState[team].bans[index] = val;
                 } else {
                    // Pick default: no role initially
                    draftState[team].picks[index] = { hero: val, role: null };
                 }
                 e.target.value = '';
                 renderDraftHelperBoard();
                 updateDraftSuggestions();
                 evaluateDraftStrength();
             }
        });
        
        // Preview listeners
        attachCombobox(dhPreviewInput.parentElement, dhPreviewInput);
        dhPreviewInput.addEventListener('change', (e) => {
            if (draftState.activeSlot && e.target.value) {
                showHeroPreview(e.target.value);
                e.target.value = '';
            }
        });

    })();

    supabase.auth.onAuthStateChange((event, session) => { handleSessionChange(session, event); });
    
    function getImgBase(){ return localStorage.getItem(LS_IMG) || './portraits/'; }
    function setImgBase(v){ localStorage.setItem(LS_IMG, v); }
    function heroSlug(name){ return name.replace(/\./g,'_').replace(/'/g,'').replace(/\s+/g,'_').toLowerCase(); }
    function heroImg(name){ return getImgBase() + heroSlug(name) + '.png'; }
    function getCanonicalHero(name){ if(!name) return ''; const n=name.trim().toLowerCase(); return HEROES.find(h=>h.toLowerCase()===n) || ''; }
    function normalizeHero(name){ return getCanonicalHero(name) || ''; }
    function pct(n,d){ return d? (100*n/d):0; }
    function fmtPct(v){ return isFinite(v)? v.toFixed(1)+'%':'‚Äî'; }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    async function deleteMatch(id) { if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç—á?')) return; showLoader(); const { error } = await supabase.from('matches').delete().eq('id', id); hideLoader(); if (error) { console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; } allMatches = allMatches.filter(m => m.id !== id); standardMatches = standardMatches.filter(m => m.id !== id); braveMatches = braveMatches.filter(m => m.id !== id); refreshUI(); alert('–ú–∞—Ç—á —É–¥–∞–ª–µ–Ω.'); }
    
    const tabs = { 
        input: document.getElementById('tab-input'), 
        stats: document.getElementById('tab-stats'), 
        matches: document.getElementById('tab-matches'), 
        matchups: document.getElementById('tab-matchups'),
        'team-analysis': document.getElementById('tab-team-analysis'),
        'draft-helper': document.getElementById('tab-draft-helper')
    };
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => { 
        btn.addEventListener('click', () => { 
            if (btn.id === 'inputTabBtn' && currentUserRole !== 'admin') return; 
            tabBtns.forEach(b => {
                 b.classList.remove('bg-slate-900', 'text-white');
                 if(b.dataset.tab === 'draft-helper') b.classList.add('text-indigo-600');
            }); 
            btn.classList.add('bg-slate-900', 'text-white');
            if (btn.dataset.tab === 'draft-helper') btn.classList.remove('text-indigo-600');

            const key = btn.dataset.tab; 
            Object.entries(tabs).forEach(([k, el]) => el.classList.toggle('hidden', k !== key)); 
            
            if (key === 'stats') rebuildFiltersAndStats(getCurrentDataSet()); 
            if (key === 'matches') renderFilteredMatches();
            if (key === 'matchups') renderMatchups();
            if (key === 'team-analysis') {
                 const f = collectFilters(getCurrentDataSet());
                 setOptions(analysisLeague, f.leagues);
                 setOptions(analysisPatch, f.patches);
                 analysisTeamSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É --</option>' + f.teams.filter(t=>t !== '–í—Å–µ').map(v=>`<option value='${v}'>${v}</option>`).join('');
                 renderTeamAnalysis();
            }
            if (key === 'draft-helper') {
                 const f = collectFilters(getCurrentDataSet());
                 dhEnemyTeam.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ --</option>' + f.teams.filter(t=>t !== '–í—Å–µ').map(v=>`<option value='${v}'>${v}</option>`).join('');
                 dhFilterPatch.innerHTML = '<option value="">-- –í—Å–µ –ø–∞—Ç—á–∏ --</option>' + f.patches.filter(t=>t !== '–í—Å–µ').map(v=>`<option value='${v}'>${v}</option>`).join('');
                 renderDraftHelperBoard();
            }
        }); 
    });

    function attachCombobox(wrapper, inputEl){ const list = wrapper.querySelector('.combo-list'); let active = -1; function produce(q){ const qq=(q||'').trim().toLowerCase(); let items = HEROES; if (qq){ const starts = HEROES.filter(h => h.toLowerCase().startsWith(qq)); items = starts.length ? starts : HEROES.filter(h => h.toLowerCase().includes(qq)); } return items.slice(0,100); } function render(q){ const items = produce(q); if(!items.length){ list.classList.add('hidden'); list.innerHTML=''; return; } list.innerHTML = items.map((h,i)=>`<div class="combo-item" data-idx="${i}" data-value="${h}"><img src="${heroImg(h)}" alt=""/><span>${h}</span></div>`).join(''); list.classList.remove('hidden'); active=-1; list.querySelectorAll('.combo-item').forEach(div=>{ div.addEventListener('click',()=>{ inputEl.value=div.dataset.value; list.classList.add('hidden'); saveDraftDebounced(); inputEl.dispatchEvent(new Event('change', { bubbles: true })); }); }); } function moveActive(delta){ const items=[...list.querySelectorAll('.combo-item')]; if(!items.length) return; active=(active+delta+items.length)%items.length; items.forEach((el,i)=> el.setAttribute('aria-selected', i===active?'true':'false')); items[active].scrollIntoView({block:'nearest'}); } inputEl.addEventListener('keydown',(e)=>{ if(list.classList.contains('hidden')) return; if(e.key==='ArrowDown'){e.preventDefault();moveActive(1);} if(e.key==='ArrowUp'){e.preventDefault();moveActive(-1);} if(e.key==='Enter'&&active>=0){e.preventDefault();const el=list.querySelectorAll('.combo-item')[active]; if(el){ inputEl.value=el.dataset.value; list.classList.add('hidden'); saveDraftDebounced(); inputEl.dispatchEvent(new Event('change', { bubbles: true })); }} if(e.key==='Escape'){ list.classList.add('hidden'); }}); inputEl.addEventListener('input', ()=> render(inputEl.value)); inputEl.addEventListener('blur', ()=> setTimeout(()=>list.classList.add('hidden'), 150)); }
    function buildRows(container, tpl, count, prefill=[]) { container.innerHTML=''; for(let i=1;i<=count;i++){ const node = tpl.content.cloneNode(true); node.querySelector('.ord').textContent = i; const input = node.querySelector('input'); attachCombobox(node.querySelector('.combo'), input); const item = prefill[i-1]; if (item && item.hero) { input.value = item.hero; const roleSel = node.querySelector('select.pickRole'); if (roleSel && item.role) roleSel.value = item.role; } container.appendChild(node); } }
    function readFormDraft(){ try { return JSON.parse(localStorage.getItem(LS_FORM)) || null; } catch { return null; } }
    function writeFormDraft(d){ localStorage.setItem(LS_FORM, JSON.stringify(d)); }
    function getFormData(){ const f=matchForm; function collectFrom(container){ return Array.from(container.querySelectorAll('.flex.items-center')).map((row,idx)=>{ const hero = normalizeHero(row.querySelector('input')?.value||''); if(!hero) return null; const obj = {hero, order: idx+1}; const roleSel=row.querySelector('select.pickRole'); if(roleSel) obj.role = roleSel.value||''; return obj; }).filter(Boolean); } return { league: f.league.value.trim(), patch: f.patch.value.trim(), date: f.date.value || null, terrain: f.terrain.value || null, draft_mode: f.draft_mode.value, winner: (f.winner.value||''), blue_team: f.blueTeam.value.trim(), red_team: f.redTeam.value.trim(), blue_bans: collectFrom(blueBansEl, 'bans'), blue_picks: collectFrom(bluePicksEl, 'picks'), red_bans: collectFrom(redBansEl, 'bans'), red_picks: collectFrom(redPicksEl, 'picks')}; }
    function applyFormDraft(d){ if(!d) return; const f=matchForm; f.league.value=d.league||''; f.patch.value=d.patch||''; f.date.value=d.date||''; f.terrain.value=d.terrain||''; f.blueTeam.value=d.blueTeam||''; f.redTeam.value=d.redTeam||''; if(d.winner){ const wEls=f.querySelectorAll('input[name=winner]'); wEls.forEach(el=> el.checked = (el.value===d.winner)); } else { f.querySelectorAll('input[name=winner]').forEach(el=> el.checked=false); } if(d.draft_mode){ const dmEls=f.querySelectorAll('input[name=draft_mode]'); dmEls.forEach(el=> el.checked = (el.value===d.draft_mode)); } buildRows(blueBansEl, banRowTpl, 5, d.blue?.bans||[]); buildRows(redBansEl,  banRowTpl, 5, d.red?.bans||[]); buildRows(bluePicksEl, pickRowTpl, 5, d.blue?.picks||[]); buildRows(redPicksEl,  pickRowTpl, 5, d.red?.picks||[]); }
    const saveDraftDebounced = debounce(()=> writeFormDraft(getFormData()), 250);
    document.addEventListener('input', (e)=>{ const form = document.getElementById('matchForm'); if (form && form.contains(e.target)) saveDraftDebounced(); });
    document.addEventListener('change', (e)=>{ const form = document.getElementById('matchForm'); if (form && form.contains(e.target)) saveDraftDebounced(); });
    document.getElementById('resetForm').addEventListener('click', () => { const keep = readFormDraft() || {}; keep.blue = {bans:[], picks:[]}; keep.red = {bans:[], picks:[]}; keep.winner=''; keep.terrain=''; keep.draft_mode = currentMode; writeFormDraft(keep); applyFormDraft(keep); if(editingMatchId) cancelEditMatch(); });
    function startEditMatch(matchId) { const match = allMatches.find(m => m.id === matchId); if (!match) return; editingMatchId = matchId; matchForm.league.value = match.league; matchForm.patch.value = match.patch; matchForm.date.value = match.date; matchForm.terrain.value = match.terrain; const draftModeRadio = matchForm.querySelector(`input[name="draft_mode"][value="${match.draft_mode || 'standard'}"]`); if (draftModeRadio) draftModeRadio.checked = true; matchForm.blueTeam.value = match.blue.team; matchForm.redTeam.value = match.red.team; const winnerRadio = matchForm.querySelector(`input[name="winner"][value="${match.winner}"]`); if (winnerRadio) winnerRadio.checked = true; else {matchForm.querySelectorAll('input[name=winner]').forEach(el => el.checked = false)} buildRows(blueBansEl, banRowTpl, 5, match.blue.bans); buildRows(redBansEl, banRowTpl, 5, match.red.bans); buildRows(bluePicksEl, pickRowTpl, 5, match.blue.picks); buildRows(redPicksEl, pickRowTpl, 5, match.red.picks); saveMatchBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç—á'; cancelEditBtn.classList.remove('hidden'); document.querySelector('[data-tab="input"]').click(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function cancelEditMatch() { editingMatchId = null; document.getElementById('resetForm').click(); saveMatchBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á'; cancelEditBtn.classList.add('hidden'); }
    matchForm.addEventListener('submit', async (e) => { e.preventDefault(); if (currentUserRole !== 'admin') { alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–∞—Ç—á–∏.'); return; } const matchDataForDB = getFormData(); if (!matchDataForDB.blue_team || !matchDataForDB.red_team) return alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥.'); if (!matchDataForDB.league || !matchDataForDB.patch) return alert('–õ–∏–≥–∞ –∏ –ø–∞—Ç—á –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.'); if (!matchDataForDB.winner) return alert('–£–∫–∞–∂–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.'); showLoader(); if (editingMatchId) { const { data, error } = await supabase.from('matches').update(matchDataForDB).eq('id', editingMatchId).select().single(); hideLoader(); if (error) { console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ç—á–∞:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; } alert('–ú–∞—Ç—á —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!'); const updatedMatch = { id: data.id, date: data.date, league: data.league, patch: data.patch, winner: data.winner, terrain: data.terrain, draft_mode: data.draft_mode, blue: { team: data.blue_team, picks: data.blue_picks, bans: data.blue_bans }, red: { team: data.red_team, picks: data.red_picks, bans: data.red_bans } }; allMatches = allMatches.map(m => m.id === editingMatchId ? updatedMatch : m); standardMatches = standardMatches.map(m => m.id === editingMatchId ? updatedMatch : m); braveMatches = braveMatches.map(m => m.id === editingMatchId ? updatedMatch : m); cancelEditMatch(); refreshUI(); document.querySelector('[data-tab="matches"]').click(); } else { const { data, error } = await supabase.from('matches').insert([matchDataForDB]).select().single(); hideLoader(); if (error) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç—á–∞:', error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç—á: ' + error.message); return; } alert('–ú–∞—Ç—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω!'); const newMatch = { id: data.id, date: data.date, league: data.league, patch: data.patch, winner: data.winner, terrain: data.terrain, draft_mode: data.draft_mode, blue: { team: data.blue_team, picks: data.blue_picks, bans: data.blue_bans }, red: { team: data.red_team, picks: data.red_picks, bans: data.red_bans } }; allMatches.unshift(newMatch); if (newMatch.draft_mode === 'brave') braveMatches.unshift(newMatch); else standardMatches.unshift(newMatch); const keep = { ...readFormDraft(), blue:{bans:[],picks:[]}, red:{bans:[],picks:[]}, winner:'', terrain:'' }; writeFormDraft(keep); applyFormDraft(keep); refreshUI(); } });
    async function exportMatches() { showLoader(); const dataToExport = getCurrentDataSet(); if (dataToExport.length === 0) { hideLoader(); return alert('–ù–µ—Ç –º–∞—Ç—á–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ.'); } const jsonData = JSON.stringify({ matches: dataToExport }, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mlbb_draft_${currentMode}_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); hideLoader(); }
    async function importMatches(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const data = JSON.parse(e.target.result); if (!data.matches || !Array.isArray(data.matches)) { throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å—Å–∏–≤ "matches".'); } if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${data.matches.length} –º–∞—Ç—á–µ–π?`)) { return; } showLoader(); const matchesToInsert = data.matches.map(m => ({ date: m.date, league: m.league, patch: m.patch, winner: m.winner, terrain: m.terrain, draft_mode: m.draft_mode || 'standard', blue_team: m.blue.team, red_team: m.red.team, blue_picks: m.blue.picks, blue_bans: m.blue.bans, red_picks: m.red.picks, red_bans: m.red.bans })); const { error } = await supabase.from('matches').insert(matchesToInsert); hideLoader(); if (error) { throw new Error(error.message); } alert(`–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${matchesToInsert.length} –º–∞—Ç—á–µ–π! –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`); allMatches = await fetchMatches(); standardMatches = allMatches.filter(m => m.draft_mode === 'standard'); braveMatches = allMatches.filter(m => m.draft_mode === 'brave'); refreshUI(); } catch (err) { hideLoader(); alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message); } finally { importInput.value = ''; } }; reader.readAsText(file); }
    async function deleteAllMatches() { const confirmation = prompt(`–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –í–°–ï –º–∞—Ç—á–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "${currentMode}". –ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, –≤–≤–µ–¥–∏—Ç–µ "—É–¥–∞–ª–∏—Ç—å –≤—Å–µ":`); if (confirmation !== '—É–¥–∞–ª–∏—Ç—å –≤—Å–µ') { alert('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.'); return; } showLoader(); const { error } = await supabase.from('matches').delete().eq('draft_mode', currentMode); hideLoader(); if (error) { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message); return; } alert(`–í—Å–µ –º–∞—Ç—á–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "${currentMode}" –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.`); if (currentMode === 'brave') braveMatches = []; else standardMatches = []; allMatches = [...standardMatches, ...braveMatches]; refreshUI(); }
    function heroChip(name){ return `<span class='inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100'><img src='${heroImg(name)}' class='inline-preview'/>${name}</span>`; }
    function heroChipBan(name){ return `<span class='inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-rose-100 dark:bg-rose-900/50 text-slate-700 dark:text-slate-300 line-through'><img src='${heroImg(name)}' class='inline-preview opacity-60'/>${name}</span>`; }
    function matchCardHTML(m){ const isAdmin = currentUserRole === 'admin'; const adminButtonsHTML = isAdmin ? `<div class="flex items-center gap-2"><button data-action='edit' data-id='${m.id}' class='px-3 py-1.5 text-sm rounded-xl bg-sky-600 text-white'>–†–µ–¥–∞–∫—Ç.</button><button data-action='del' data-id='${m.id}' class='px-3 py-1.5 text-sm rounded-xl bg-rose-600 text-white'>–£–¥–∞–ª–∏—Ç—å</button></div>` : ''; return `<div class='rounded-2xl ring-1 ring-slate-200 bg-white p-4'><div class='flex items-center justify-between gap-2'><div><div class='text-xs text-slate-500'>${m.league} ‚Ä¢ –ü–∞—Ç—á ${m.patch} ‚Ä¢ ${m.date||'‚Äî'}</div><div class='font-medium mt-1'>${m.blue.team} <span class='text-xs ${m.winner==='blue'?'text-emerald-600':'text-slate-400'}'>${m.winner==='blue'?'(W)':''}</span> ‚Äî ${m.red.team} <span class='text-xs ${m.winner==='red'?'text-emerald-600':'text-slate-400'}'>${m.winner==='red'?'(W)':''}</span></div></div>${adminButtonsHTML}</div><div class='mt-3 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 text-sm'><div class='space-y-2'><div class='text-xs text-slate-500'>–°–∏–Ω—è—è –∫–æ–º–∞–Ω–¥–∞</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.blue.bans.map(x=>heroChipBan(x.hero)).join('')}</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.blue.picks.map(x=>heroChip(x.hero)).join('')}</div></div><div class='space-y-2'><div class='text-xs text-slate-500'>–ö—Ä–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.red.bans.map(x=>heroChipBan(x.hero)).join('')}</div><div class='grid grid-cols-3 sm:grid-cols-5 gap-1'>${m.red.picks.map(x=>heroChip(x.hero)).join('')}</div></div></div></div>`; }
    function refreshMatchesList(matches, targetEl) { if (!targetEl) targetEl = matchesListEl; if (!matches || !matches.length) { targetEl.innerHTML='<div class="text-sm text-slate-500 text-center py-4">–ú–∞—Ç—á–µ–π –ø–æ —ç—Ç–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>'; return; } targetEl.innerHTML = matches.map(matchCardHTML).join(''); targetEl.querySelectorAll('[data-action=del]')?.forEach(b => { b.onclick = () => deleteMatch(b.dataset.id); }); targetEl.querySelectorAll('[data-action=edit]')?.forEach(b => { b.onclick = () => startEditMatch(b.dataset.id); }); }
    function renderFilteredMatches() { const selectedTeam = filterMatchesTeam.value; const selectedLeague = filterMatchesLeague.value; const selectedHero = filterMatchesHero.value; const selectedType = filterMatchesType.value; let filtered = getCurrentDataSet(); if (selectedTeam) { filtered = filtered.filter(m => m.blue.team === selectedTeam || m.red.team === selectedTeam); } if (selectedLeague) { filtered = filtered.filter(m => m.league === selectedLeague); } if (selectedHero) { if (selectedType === 'pick') { filtered = filtered.filter(m => m.blue.picks.some(p => p.hero === selectedHero) || m.red.picks.some(p => p.hero === selectedHero)); } else { filtered = filtered.filter(m => m.blue.picks.some(p => p.hero === selectedHero) || m.red.picks.some(p => p.hero === selectedHero) || m.blue.bans.some(b => b.hero === selectedHero) || m.red.bans.some(b => b.hero === selectedHero)); } } refreshMatchesList(filtered, matchesListEl); }
    function collectFilters(matches){ const teams=new Set(); matches.forEach(m=>{ if(m.blue?.team)teams.add(m.blue.team); if(m.red?.team)teams.add(m.red.team); }); const leagues=new Set(matches.map(m=>m.league).filter(Boolean)); const patches=new Set(matches.map(m=>m.patch).filter(Boolean)); return { leagues:['–í—Å–µ',...leagues].sort(), patches:['–í—Å–µ',...patches].sort(), teams:['–í—Å–µ',...teams].sort() }; }
    function setOptions(sel,arr){ const cur=sel.value; sel.innerHTML=arr.map(v=>`<option value='${v==='–í—Å–µ'?'':v}'>${v}</option>`).join(''); if(Array.from(sel.options).some(o=>o.value===cur)) sel.value = cur; }
    function applyFilters(matches, {league,patch,team,side,terrain}){ let filteredMatches = [...matches]; if (league) { filteredMatches = filteredMatches.filter(m => m.league === league); } if (patch) { filteredMatches = filteredMatches.filter(m => m.patch === patch); } if (terrain) { filteredMatches = filteredMatches.filter(m => m.terrain === terrain); } if (team) { filteredMatches = filteredMatches.filter(m => m.blue.team === team || m.red.team === team); } if (side && team) { if (side === 'blue') { filteredMatches = filteredMatches.filter(m => m.blue.team === team); } if (side === 'red') { filteredMatches = filteredMatches.filter(m => m.red.team === team); } } return filteredMatches; }
    function aggregate(matches, filters) { const map=new Map(); function ens(h){ if(!map.has(h)) map.set(h,{hero:h,picks:0,wins:0,losses:0,bans:0,presence:0,roles:{}}); return map.get(h); } matches.forEach(m => { const processPick = (pick, isWin) => { const s = ens(pick.hero); s.picks++; s.presence++; if (isWin) s.wins++; else s.losses++; if (pick.role) { if (!s.roles[pick.role]) s.roles[pick.role] = { picks: 0, wins: 0 }; s.roles[pick.role].picks++; if (isWin) s.roles[pick.role].wins++; } }; const processBan = (ban) => { const s = ens(ban.hero); s.bans++; s.presence++; }; const shouldProcessBlue = (!filters.side || filters.side === 'blue') && (!filters.team || m.blue.team === filters.team); const shouldProcessRed = (!filters.side || filters.side === 'red') && (!filters.team || m.red.team === filters.team); if (shouldProcessBlue) { m.blue.picks.forEach(p => processPick(p, m.winner === 'blue')); m.blue.bans.forEach(b => processBan(b)); } if (shouldProcessRed) { m.red.picks.forEach(p => processPick(p, m.winner === 'red')); m.red.bans.forEach(b => processBan(b)); } }); return Array.from(map.values()); }
    function updateSortIcons() { document.querySelectorAll('th.sortable').forEach(th => { const icon = th.querySelector('.sort-icon'); if (th.dataset.sort === sortState.key) { th.classList.add('sorted'); icon.innerHTML = sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº'; } else { th.classList.remove('sorted'); icon.innerHTML = ''; } }); }
    function renderStats(){ const filters= {league:filterLeague.value||'', patch:filterPatch.value||'', team:filterTeam.value||'', side:filterSide.value||'', terrain:filterTerrain.value||''}; const selectedRole = filterRole.value; const matches=applyFilters(getCurrentDataSet(), filters); let statsData = aggregate(matches, filters); if (selectedRole) { statsData = statsData.filter(heroStats => heroStats.roles[selectedRole]).map(heroStats => { const roleStats = heroStats.roles[selectedRole]; return { ...heroStats, picks: roleStats.picks, wins: roleStats.wins, losses: roleStats.picks - roleStats.wins, }; }); } let rows = statsData.map(r => ({ ...r, winrate: r.picks > 0 ? (r.wins / r.picks) : -1 })); rows.sort((a, b) => { const key = sortState.key; let valA = a[key]; let valB = b[key]; if (key === 'hero') { return sortState.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); } return sortState.direction === 'asc' ? valA - valB : valB - valA; }); statsBody.innerHTML = rows.map(r=>{ const wr = r.picks ? fmtPct(pct(r.wins, r.picks)) : '‚Äî'; return `<tr class='hover:bg-slate-50 cursor-pointer' data-hero='${r.hero}'><td class='px-4 py-2'><div class='flex items-center gap-2'><img src='${heroImg(r.hero)}' class='inline-preview'/>${r.hero}</div></td><td class='px-4 py-2 text-right font-medium'>${r.presence}</td><td class='px-4 py-2 text-right'>${r.picks}</td><td class='px-4 py-2 text-right'>${wr}</td><td class='px-4 py-2 text-right text-emerald-600'>${r.wins}</td><td class='px-4 py-2 text-right text-rose-600'>${r.losses}</td><td class='px-4 py-2 text-right'>${r.bans}</td></tr>`; }).join(''); statsBody.querySelectorAll('tr[data-hero]')?.forEach(tr=> tr.addEventListener('click', ()=> openHeroModal(tr.dataset.hero, matches, filters))); updateSortIcons(); }
    function rebuildFiltersAndStats(matches){ const f=collectFilters(matches); const allHeroesSorted = ['–í—Å–µ', ...HEROES.sort()]; setOptions(filterLeague,f.leagues); setOptions(filterPatch,f.patches); setOptions(filterTeam,f.teams); setOptions(filterMatchesTeam, f.teams); setOptions(filterMatchesLeague, f.leagues); setOptions(filterMatchesHero, allHeroesSorted); renderStats(); renderFilteredMatches(); }
    
    // --- START: Matchup Functions ---
    function rebuildMatchupFilters(matches) { const { leagues, patches } = collectFilters(matches); setOptions(filterMatchupLeague, leagues); setOptions(filterMatchupPatch, patches); }
    function calculateMatchupStats(heroA, heroB, filters) { let matches = applyFilters(getCurrentDataSet(), filters); const results = { synergy: { games: 0, wins: 0 }, counter: { games: 0, wins: 0 }, relevantMatches: [], teammatesForA: new Map(), teammatesForB: new Map() }; const inc = (map, key, win) => { if (!map.has(key)) map.set(key, { games: 0, wins: 0 }); const o = map.get(key); o.games++; if (win) o.wins++; }; matches.forEach(m => { const bluePicks = new Set(m.blue.picks.map(p => p.hero)); const redPicks = new Set(m.red.picks.map(p => p.hero)); const blueHasA = bluePicks.has(heroA), blueHasB = bluePicks.has(heroB); const redHasA = redPicks.has(heroA), redHasB = redPicks.has(heroB); if ((blueHasA && blueHasB) || (redHasA && redHasB)) { results.synergy.games++; const isWin = (blueHasA && m.winner === 'blue') || (redHasA && m.winner === 'red'); if (isWin) results.synergy.wins++; results.relevantMatches.push({ ...m, matchupType: 'synergy' }); } else if ((blueHasA && redHasB) || (redHasA && blueHasB)) { results.counter.games++; const isWinForA = (blueHasA && m.winner === 'blue') || (redHasA && m.winner === 'red'); if (isWinForA) results.counter.wins++; results.relevantMatches.push({ ...m, matchupType: 'counter' }); if (blueHasA) { m.blue.picks.forEach(p => { if(p.hero !== heroA) inc(results.teammatesForA, p.hero, m.winner === 'blue'); }); m.red.picks.forEach(p => { if(p.hero !== heroB) inc(results.teammatesForB, p.hero, m.winner === 'red'); }); } else { m.red.picks.forEach(p => { if(p.hero !== heroA) inc(results.teammatesForA, p.hero, m.winner === 'red'); }); m.blue.picks.forEach(p => { if(p.hero !== heroB) inc(results.teammatesForB, p.hero, m.winner === 'blue'); }); } } }); return results; }
    function renderMatchups() { rebuildMatchupFilters(getCurrentDataSet()); const heroA = normalizeHero(matchupHeroAInput.value); const heroB = normalizeHero(matchupHeroBInput.value); if (!heroA || !heroB || heroA === heroB) { matchupResultsContainer.classList.add('hidden'); matchupPlaceholder.classList.remove('hidden'); if (heroA && heroB && heroA === heroB) { matchupPlaceholder.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤.'; } else { matchupPlaceholder.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤—É—Ö –≥–µ—Ä–æ–µ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.'; } return; } const filters = { league: filterMatchupLeague.value || '', patch: filterMatchupPatch.value || '', }; const stats = calculateMatchupStats(heroA, heroB, filters); const synWR = fmtPct(pct(stats.synergy.wins, stats.synergy.games)); matchupSynergyResultEl.innerHTML = `<div class='flex justify-between'><span>–ò–≥—Ä –≤–º–µ—Å—Ç–µ:</span> <span class='font-medium'>${stats.synergy.games}</span></div><div class='flex justify-between'><span>–ü–æ–±–µ–¥:</span> <span class='font-medium text-emerald-600'>${stats.synergy.wins}</span></div><div class='flex justify-between'><span>–í–∏–Ω—Ä–µ–π—Ç:</span> <span class='font-medium'>${synWR}</span></div>`; const ctrWR = fmtPct(pct(stats.counter.wins, stats.counter.games)); matchupCounterResultEl.innerHTML = `<div class='flex justify-between'><span>–ò–≥—Ä –ø—Ä–æ—Ç–∏–≤:</span> <span class='font-medium'>${stats.counter.games}</span></div><div class='flex justify-between'><span>–ü–æ–±–µ–¥ –¥–ª—è ${heroA}:</span> <span class='font-medium text-emerald-600'>${stats.counter.wins}</span></div><div class='flex justify-between'><span>–í–∏–Ω—Ä–µ–π—Ç –¥–ª—è ${heroA}:</span> <span class='font-medium'>${ctrWR}</span></div>`; matchupBestTeammatesForA_title.textContent = `–¢–æ–ø-5 —Å–æ—é–∑–Ω–∏–∫–æ–≤ –¥–ª—è ${heroA} –ø—Ä–æ—Ç–∏–≤ ${heroB}`; matchupBestTeammatesForB_title.textContent = `–¢–æ–ø-5 —Å–æ—é–∑–Ω–∏–∫–æ–≤ –¥–ª—è ${heroB} –ø—Ä–æ—Ç–∏–≤ ${heroA}`; const bestForA = topN(stats.teammatesForA, 5, { best: true, minGames: 5 }); const bestForB = topN(stats.teammatesForB, 5, { best: true, minGames: 5 }); matchupBestTeammatesForAEl.innerHTML = renderKV(bestForA); matchupBestTeammatesForBEl.innerHTML = renderKV(bestForB); const matchFilterType = matchupMatchFilter.value; let matchesToShow = stats.relevantMatches; if (matchFilterType === 'synergy') { matchesToShow = stats.relevantMatches.filter(m => m.matchupType === 'synergy'); } else if (matchFilterType === 'counter') { matchesToShow = stats.relevantMatches.filter(m => m.matchupType === 'counter'); } refreshMatchesList(matchesToShow, matchupMatchesListEl); matchupPlaceholder.classList.add('hidden'); matchupResultsContainer.classList.remove('hidden'); }
    // --- END: Matchup Functions ---
    
    // --- START: Team Analysis Functions ---
    function renderTeamAnalysis() { const teamName = analysisTeamSelect.value; const league = analysisLeague.value; const patch = analysisPatch.value; if (!teamName) { teamAnalysisContent.classList.add('hidden'); teamAnalysisPlaceholder.classList.remove('hidden'); return; } teamAnalysisPlaceholder.classList.add('hidden'); teamAnalysisContent.classList.remove('hidden'); let matches = getCurrentDataSet().filter(m => m.blue.team === teamName || m.red.team === teamName); if (league) matches = matches.filter(m => m.league === league); if (patch) matches = matches.filter(m => m.patch === patch); const stats = { totalGames: matches.length, wins: 0, blue: { games: 0, wins: 0 }, red: { games: 0, wins: 0 }, fp: { games: 0, wins: 0 }, fpHeroes: new Map(), heroes: new Map(), bansByThem: new Map(), bansAgainstThem: new Map(), rolePriorityPhase1: { exp:0, jungle:0, mid:0, roam:0, gold:0, total:0 }, combinations: { duo: new Map(), trio: new Map() }, flexPicks: 0 }; matches.forEach(m => { const isBlue = m.blue.team === teamName; const mySide = isBlue ? m.blue : m.red; const enemySide = isBlue ? m.red : m.blue; const isWin = (isBlue && m.winner === 'blue') || (!isBlue && m.winner === 'red'); if (isWin) stats.wins++; if (isBlue) { stats.blue.games++; if(isWin) stats.blue.wins++; stats.fp.games++; if(isWin) stats.fp.wins++; const fpHero = mySide.picks[0]?.hero; if (fpHero) { if (!stats.fpHeroes.has(fpHero)) stats.fpHeroes.set(fpHero, {games:0, wins:0}); const fh = stats.fpHeroes.get(fpHero); fh.games++; if(isWin) fh.wins++; } } else { stats.red.games++; if(isWin) stats.red.wins++; } const myHeroes = []; mySide.picks.forEach((p, idx) => { myHeroes.push(p.hero); if (!stats.heroes.has(p.hero)) stats.heroes.set(p.hero, { picks: 0, wins: 0, phase1: 0, phase2: 0, roles: new Set() }); const h = stats.heroes.get(p.hero); h.picks++; if (isWin) h.wins++; if (p.role) h.roles.add(p.role); if (idx < 3) { h.phase1++; if (p.role) stats.rolePriorityPhase1[p.role]++; stats.rolePriorityPhase1.total++; } else { h.phase2++; } }); mySide.bans.forEach(b => { const k = b.hero; if(!stats.bansByThem.has(k)) stats.bansByThem.set(k, 0); stats.bansByThem.set(k, stats.bansByThem.get(k) + 1); }); enemySide.bans.forEach(b => { const k = b.hero; if(!stats.bansAgainstThem.has(k)) stats.bansAgainstThem.set(k, 0); stats.bansAgainstThem.set(k, stats.bansAgainstThem.get(k) + 1); }); const uniqueHeroes = [...new Set(myHeroes)].sort(); for(let i=0; i<uniqueHeroes.length; i++) { for(let j=i+1; j<uniqueHeroes.length; j++) { const key = [uniqueHeroes[i], uniqueHeroes[j]].join('+'); if(!stats.combinations.duo.has(key)) stats.combinations.duo.set(key, {games:0, wins:0, heroes:[uniqueHeroes[i], uniqueHeroes[j]]}); const c = stats.combinations.duo.get(key); c.games++; if(isWin) c.wins++; } } for(let i=0; i<uniqueHeroes.length; i++) { for(let j=i+1; j<uniqueHeroes.length; j++) { for(let k=j+1; k<uniqueHeroes.length; k++) { const key = [uniqueHeroes[i], uniqueHeroes[j], uniqueHeroes[k]].join('+'); if(!stats.combinations.trio.has(key)) stats.combinations.trio.set(key, {games:0, wins:0, heroes:[uniqueHeroes[i], uniqueHeroes[j], uniqueHeroes[k]]}); const c = stats.combinations.trio.get(key); c.games++; if(isWin) c.wins++; } } } }); let flexCount = 0; stats.heroes.forEach(h => { if(h.roles.size >= 2) flexCount++; }); document.getElementById('ta-total-games').textContent = stats.totalGames; document.getElementById('ta-winrate').textContent = fmtPct(pct(stats.wins, stats.totalGames)) + ' WR'; const blueWr = pct(stats.blue.wins, stats.blue.games); document.getElementById('ta-blue-wr').textContent = `${stats.blue.games} –∏–≥—Ä (${fmtPct(blueWr)})`; document.getElementById('ta-blue-bar').style.width = `${blueWr}%`; const redWr = pct(stats.red.wins, stats.red.games); document.getElementById('ta-red-wr').textContent = `${stats.red.games} –∏–≥—Ä (${fmtPct(redWr)})`; document.getElementById('ta-red-bar').style.width = `${redWr}%`; document.getElementById('ta-fp-games').textContent = `FP –≤ ${stats.fp.games} –∏–≥—Ä–∞—Ö`; document.getElementById('ta-fp-wr').textContent = fmtPct(pct(stats.fp.wins, stats.fp.games)); const sortedFpHeroes = Array.from(stats.fpHeroes.entries()).sort((a,b) => b[1].games - a[1].games).slice(0, 3); document.getElementById('ta-fp-top-heroes').innerHTML = sortedFpHeroes.map(([h, d]) => `<div class="flex justify-between items-center text-xs"><div class="flex items-center gap-1"><img src="${heroImg(h)}" class="w-4 h-4 rounded"> ${h}</div><span class="font-bold">${d.games} (${fmtPct(pct(d.wins, d.games))})</span></div>`).join('') || '<div class="text-xs text-slate-400 italic">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; document.getElementById('ta-style-flex').textContent = flexCount + " –≥–µ—Ä–æ–µ–≤"; const rp = stats.rolePriorityPhase1; const maxRole = Object.entries(rp).filter(k=>k[0]!=='total').sort((a,b)=>b[1]-a[1])[0]; document.getElementById('ta-style-trio').textContent = maxRole ? `${maxRole[0].toUpperCase()} (${fmtPct(pct(maxRole[1], rp.total))})` : '-'; const topPicks = Array.from(stats.heroes.entries()).map(([h, d]) => ({ hero: h, picks: d.picks, wins: d.wins, wr: pct(d.wins, d.picks), p1: d.phase1, p2: d.phase2 })).sort((a, b) => b.picks - a.picks).slice(0, 7); document.getElementById('ta-top-picks-body').innerHTML = topPicks.map(p => `<tr class="border-b border-slate-100"><td class="px-2 py-2 flex items-center gap-2"><img src="${heroImg(p.hero)}" class="w-6 h-6 rounded-md object-cover"><span>${p.hero}</span></td><td class="px-2 py-2 text-center font-bold">${p.picks}</td><td class="px-2 py-2 text-center text-${p.wr >= 50 ? 'emerald' : 'rose'}-600">${fmtPct(p.wr)}</td><td class="px-2 py-2 text-center bg-slate-50">${p.p1} <span class="text-xs text-slate-400">(${fmtPct(pct(p.p1, p.picks))})</span></td><td class="px-2 py-2 text-center">${p.p2}</td></tr>`).join(''); const rolesMap = { 'exp': 'EXP Lane', 'gold': 'Gold Lane', 'mid': 'Mid Lane', 'roam': 'Roamer', 'jungle': 'Jungler' }; const sortedRoles = Object.entries(rp).filter(x=>x[0]!=='total').sort((a,b)=>b[1]-a[1]); document.getElementById('ta-role-priority').innerHTML = sortedRoles.map(([r, count]) => { const perc = pct(count, rp.total); return `<div><div class="flex justify-between text-xs mb-1"><span>${rolesMap[r]}</span><span>${count} (${fmtPct(perc)})</span></div><div class="w-full bg-slate-100 rounded-full h-1.5"><div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${perc}%"></div></div></div>`; }).join(''); const renderBans = (map, elId) => { const sorted = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5); document.getElementById(elId).innerHTML = sorted.map(([h, c]) => `<div class="flex items-center justify-between text-xs p-2 bg-slate-50 rounded-lg"><div class="flex items-center gap-2"><img src="${heroImg(h)}" class="w-5 h-5 rounded"> ${h}</div><span class="font-bold">${c}</span></div>`).join(''); }; renderBans(stats.bansByThem, 'ta-bans-by-them'); renderBans(stats.bansAgainstThem, 'ta-bans-against-them'); const renderCombo = (map, elId) => { const sorted = Array.from(map.entries()).sort((a,b)=>b[1].games-a[1].games).slice(0,5); document.getElementById(elId).innerHTML = sorted.map(([k, d]) => `<div class="flex items-center justify-between text-xs p-2 border border-slate-100 rounded-lg"><div class="flex -space-x-2">${d.heroes.map(h=>`<img src="${heroImg(h)}" class="w-6 h-6 rounded-full border-2 border-white">`).join('')}</div><div class="text-right"><div class="font-bold">${d.games} –∏–≥—Ä</div><div class="text-[10px] text-slate-500">${fmtPct(pct(d.wins, d.games))} WR</div></div></div>`).join(''); }; renderCombo(stats.combinations.duo, 'ta-duos'); renderCombo(stats.combinations.trio, 'ta-trios'); renderConditionalDraft(); }
    function renderConditionalDraft() { const bannedHero = normalizeHero(taConditionBanInput.value); const teamName = analysisTeamSelect.value; const resultEl = document.getElementById('ta-condition-results'); if (!bannedHero || !teamName) { resultEl.innerHTML = '<span class="text-slate-400 text-xs">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è –≤ –±–∞–Ω–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ö —Ä–µ–∞–∫—Ü–∏—é.</span>'; return; } let matches = getCurrentDataSet().filter(m => m.blue.team === teamName || m.red.team === teamName); const matchesWithBan = matches.filter(m => { const allBans = [...m.blue.bans, ...m.red.bans].map(b => b.hero); return allBans.includes(bannedHero); }); const matchesVsHero = matches.filter(m => { const isBlue = m.blue.team === teamName; const enemyPicks = isBlue ? m.red.picks.map(p=>p.hero) : m.blue.picks.map(p=>p.hero); return enemyPicks.includes(bannedHero); }); const aggregatePicks = (matchSet) => { const counts = new Map(); matchSet.forEach(m => { const isBlue = m.blue.team === teamName; const isWin = (isBlue && m.winner === 'blue') || (!isBlue && m.winner === 'red'); const myPicks = isBlue ? m.blue.picks : m.red.picks; myPicks.forEach(p => { if (!counts.has(p.hero)) counts.set(p.hero, {games:0, wins:0}); const c = counts.get(p.hero); c.games++; if(isWin) c.wins++; }); }); return counts; }; const countsBan = aggregatePicks(matchesWithBan); const countsVs = aggregatePicks(matchesVsHero); const allKeys = new Set([...countsBan.keys(), ...countsVs.keys()]); const combinedStats = Array.from(allKeys).map(h => { const b = countsBan.get(h) || {games:0, wins:0}; const v = countsVs.get(h) || {games:0, wins:0}; return { hero: h, banGames: b.games, banWin: b.wins, vsGames: v.games, vsWin: v.wins, totalRelevance: b.games + v.games }; }).sort((a,b) => b.totalRelevance - a.totalRelevance).slice(0, 5); if (combinedStats.length === 0) { resultEl.innerHTML = `<span class="text-slate-500 text-xs">–ú–∞—Ç—á–µ–π —Å —É—á–∞—Å—Ç–∏–µ–º –∏–ª–∏ –±–∞–Ω–æ–º ${bannedHero} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</span>`; return; } resultEl.innerHTML = `<table class="w-full text-xs text-left"><thead><tr class="text-slate-500 border-b border-slate-200"><th class="py-1 font-normal">–ì–µ—Ä–æ–π</th><th class="py-1 font-normal text-center">–ö–æ–≥–¥–∞ ${bannedHero} –≤ –±–∞–Ω–µ</th><th class="py-1 font-normal text-center">–ü—Ä–æ—Ç–∏–≤ ${bannedHero} (–ø–∏–∫ –≤—Ä–∞–≥–∞)</th></tr></thead><tbody>${combinedStats.map(row => { const banWR = row.banGames ? fmtPct(pct(row.banWin, row.banGames)) : '-'; const vsWR = row.vsGames ? fmtPct(pct(row.vsWin, row.vsGames)) : '-'; const banClass = row.banGames > 0 ? 'text-slate-900 font-bold' : 'text-slate-300'; const vsClass = row.vsGames > 0 ? 'text-slate-900 font-bold' : 'text-slate-300'; return `<tr class="border-b border-slate-100 last:border-0"><td class="py-2 flex items-center gap-2 font-medium text-slate-800"><img src="${heroImg(row.hero)}" class="w-5 h-5 rounded"> ${row.hero}</td><td class="py-2 text-center bg-slate-50/50 ${banClass}">${row.banGames ? `${row.banGames} (${banWR})` : '0'}</td><td class="py-2 text-center bg-indigo-50/30 ${vsClass}">${row.vsGames ? `${row.vsGames} (${vsWR})` : '0'}</td></tr>`; }).join('')}</tbody></table>`; }
    // --- END: Team Analysis Functions ---

    // --- START: Draft Helper Logic ---
    const MIN_GAMES_THRESHOLD = 5; 
    
    function renderDraftHelperBoard() {
        const createBanSlot = (team, index, val) => {
            const isFilled = !!val;
            const isActive = draftState.activeSlot && draftState.activeSlot.team === team && draftState.activeSlot.type === 'ban' && draftState.activeSlot.index === index;
            return `
              <div class="draft-slot aspect-square rounded-xl flex items-center justify-center bg-slate-50 border-2 border-slate-100 overflow-hidden relative ${isActive ? 'active-slot ring-2 ring-sky-400' : ''} ${isFilled ? 'filled' : ''}"
                 onclick="window.selectDraftSlot('${team}', 'ban', ${index})">
                  ${isFilled ? 
                    `<img src="${heroImg(val)}" class="w-full h-full object-cover">
                     <span class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-[9px] text-center truncate px-1">${val}</span>
                     <div class="slot-remove-btn" onclick="window.clearDraftSlot('${team}', 'ban', ${index}, event)">‚úï</div>` 
                    : `<span class="text-slate-300 font-bold text-xs">${index + 1}</span>`}
              </div>`;
        };

        const createPickRow = (team, index, val) => {
            const isFilled = !!val;
            const heroName = getHero(val);
            const role = getRole(val) || '';
            const isActive = draftState.activeSlot && draftState.activeSlot.team === team && draftState.activeSlot.type === 'pick' && draftState.activeSlot.index === index;
            return `
              <div class="pick-row ${isActive ? 'active-slot' : ''}" onclick="window.selectDraftSlot('${team}', 'pick', ${index})">
                 <div class="relative w-12 h-12 shrink-0 rounded-lg bg-slate-100 border border-slate-200 overflow-hidden flex items-center justify-center">
                    ${isFilled ? `<img src="${heroImg(heroName)}" class="w-full h-full object-cover">` : `<span class="text-slate-300 font-bold text-xs">${index + 1}</span>`}
                 </div>
                 <div class="flex-1 min-w-0 flex flex-col justify-center h-full px-1">
                    <div class="font-bold text-sm truncate ${!isFilled ? 'text-slate-400' : ''}">${isFilled ? heroName : '–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è'}</div>
                 </div>
                 ${isFilled ? `
                   <select class="role-select" onclick="event.stopPropagation()" onchange="window.updateRole('${team}', ${index}, this.value)">
                      <option value="" ${role===''?'selected':''}>–†–æ–ª—å?</option>
                      <option value="exp" ${role==='exp'?'selected':''}>EXP</option>
                      <option value="jungle" ${role==='jungle'?'selected':''}>Jungle</option>
                      <option value="mid" ${role==='mid'?'selected':''}>Mid</option>
                      <option value="roam" ${role==='roam'?'selected':''}>Roam</option>
                      <option value="gold" ${role==='gold'?'selected':''}>Gold</option>
                   </select>
                   <div class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-rose-100 text-rose-500 cursor-pointer" onclick="window.clearDraftSlot('${team}', 'pick', ${index}, event)">‚úï</div>
                 ` : ''}
              </div>`;
        };

        dhBlueBans.innerHTML = draftState.blue.bans.map((h, i) => createBanSlot('blue', i, h)).join('');
        dhRedBans.innerHTML = draftState.red.bans.map((h, i) => createBanSlot('red', i, h)).join('');
        dhBluePicks.innerHTML = draftState.blue.picks.map((h, i) => createPickRow('blue', i, h)).join('');
        dhRedPicks.innerHTML = draftState.red.picks.map((h, i) => createPickRow('red', i, h)).join('');
        
        evaluateDraftStrength();
    }

    window.selectDraftSlot = (team, type, index) => {
        draftState.activeSlot = { team, type, index };
        renderDraftHelperBoard();
        dhPickerInput.disabled = false;
        dhPickerInput.value = '';
        dhPickerInput.focus();
        dhPreviewContainer.classList.remove('hidden');
        updateDraftSuggestions();
    };

    window.clearDraftSlot = (team, type, index, e) => {
        e.stopPropagation();
        if (type === 'ban') {
            draftState[team].bans[index] = '';
        } else {
            draftState[team].picks[index] = null;
        }
        renderDraftHelperBoard();
        updateDraftSuggestions();
        evaluateDraftStrength();
    }

    window.updateRole = (team, index, newRole) => {
        if (draftState[team].picks[index]) {
            draftState[team].picks[index].role = newRole;
            updateDraftSuggestions(); 
            evaluateDraftStrength();
        }
    }

    // --- Helper Functions for Anti-Noise Logic ---
    function getBayesianDeviation(wins, games, constant) {
        // Anti-Noise: If < 5 games, treat as zero deviation (no info)
        if (!games || games < 5) return 0;
        
        const smoothedWR = (wins + (constant * 0.5)) / (games + constant);
        return smoothedWR - 0.5;
    }

    function getSmoothedWR(wins, games, constant) {
        if (!games) games = 0;
        if (!wins) wins = 0;
        return (wins + (constant * 0.5)) / (games + constant);
    }

    function evaluateDraftStrength() {
        const matches = getFilteredMatchesForHelper();
        const globalStats = aggregate(matches, {});
        
        const C_META = 15;
        const C_PAIR = 5;     
        
        const W_META = 1800;    
        const W_SYNERGY = 1500; 
        const W_COUNTER = 1500; 
        const W_COMP = 2500;    
        
        const analyzeTeam = (picksArray, enemyPicksArray) => {
            let res = { score: 0, factors: [], meta: 0, synergy: 0, counter: 0, comp: 0 };
            let rolesFilled = new Set();
            let heroes = picksArray.map(getHero).filter(Boolean);
            let enemies = enemyPicksArray.map(getHero).filter(Boolean);
            
            if (heroes.length === 0) return res;

            // 1. Meta Score
            heroes.forEach(h => {
                const s = globalStats.find(x => x.hero === h);
                if (s) {
                    const dev = getBayesianDeviation(s.wins, s.picks, C_META);
                    // Only apply if > 0 deviation (already filtered < 5 games inside getBayesianDeviation)
                    if (dev !== 0) {
                        const points = Math.round(dev * W_META);
                        res.meta += points;
                        const smoothWR = getSmoothedWR(s.wins, s.picks, C_META);
                        if (dev > 0) res.factors.push({ text: `${h}: –°–∏–ª—å–Ω—ã–π –ø–∏–∫ (${fmtPct(smoothWR*100)})`, type: 'pos' });
                        else res.factors.push({ text: `${h}: –°–ª–∞–±—ã–π –≤–∏–Ω—Ä–µ–π—Ç`, type: 'neg' });
                    }
                }
            });
            res.score += res.meta;

            // 2. Synergy
            for (let i=0; i<heroes.length; i++) {
                for (let j=i+1; j<heroes.length; j++) {
                    const pair = calculateMatchupStats(heroes[i], heroes[j], {patch: draftState.patch}).synergy;
                    const dev = getBayesianDeviation(pair.wins, pair.games, C_PAIR);
                    
                    if (dev !== 0) {
                        const points = Math.round(dev * W_SYNERGY);
                        res.synergy += points;
                        if (dev > 0) res.factors.push({ text: `–°–≤—è–∑–∫–∞: ${heroes[i]}+${heroes[j]}`, type: 'pos' });
                        else res.factors.push({ text: `–ü–ª–æ—Ö–∞—è —Å–≤—è–∑–∫–∞: ${heroes[i]}+${heroes[j]}`, type: 'neg' });
                    }
                }
            }
            res.score += res.synergy;

            // 3. Counter
            heroes.forEach(my => {
                enemies.forEach(en => {
                    const pair = calculateMatchupStats(my, en, {patch: draftState.patch}).counter;
                    const dev = getBayesianDeviation(pair.wins, pair.games, C_PAIR);
                    
                    if (dev !== 0) {
                        const points = Math.round(dev * W_COUNTER);
                        res.counter += points;
                        if (dev > 0) res.factors.push({ text: `${my} –∫–æ–Ω—Ç—Ä–∏—Ç ${en}`, type: 'pos' });
                        else res.factors.push({ text: `${my} —Å–ª–∞–± –ø—Ä–æ—Ç–∏–≤ ${en}`, type: 'neg' });
                    }
                });
            });
            res.score += res.counter;

            // 4. Composition
            picksArray.forEach(p => {
                if (!p) return;
                let r = p.role;
                if (!r) {
                    const s = globalStats.find(x => x.hero === p.hero);
                    if (s && s.roles) {
                        let bestR = null, max = 0;
                        for(let k in s.roles) { if(s.roles[k].picks > max) { max = s.roles[k].picks; bestR = k; } }
                        r = bestR;
                    }
                }
                if (r) rolesFilled.add(r);
            });
            if (heroes.length >= 4) {
                if (!rolesFilled.has('jungle')) { res.comp -= 2500; res.factors.push({ text: '–ù–µ—Ç –õ–µ—Å–Ω–∏–∫–∞', type: 'neg' }); }
                else res.comp += 100;
                
                if (!rolesFilled.has('roam')) { res.comp -= 2000; res.factors.push({ text: '–ù–µ—Ç –†–æ—É–º–∞', type: 'neg' }); }
                else res.comp += 100;
            }
            res.score += res.comp;

            return res;
        };

        const blueAnalysis = analyzeTeam(draftState.blue.picks, draftState.red.picks);
        const redAnalysis = analyzeTeam(draftState.red.picks, draftState.blue.picks);

        let diff = blueAnalysis.score - redAnalysis.score;
        let probability = 50 + (Math.tanh(diff / 2200) * 45); 
        probability = Math.max(5, Math.min(95, probability));

        dhStrengthBarFill.style.width = `${probability}%`;
        dhWinProbBlue.textContent = fmtPct(probability);
        dhWinProbRed.textContent = fmtPct(100 - probability);

        generateDraftSummary(blueAnalysis, redAnalysis);
    }

    function generateDraftSummary(blue, red) {
        const fmtNum = (n) => (n > 0 ? `+${n}` : `${n}`);
        const getCls = (n) => (n > 0 ? 'val-pos' : (n < 0 ? 'val-neg' : 'val-neu'));

        const renderCol = (data, title, titleColor) => {
            // Sort by positive first, then negative. 
            const allFactors = [...data.factors].sort((a, b) => {
                if (a.type === 'pos' && b.type === 'neg') return -1;
                if (a.type === 'neg' && b.type === 'pos') return 1;
                return 0;
            });

            return `
            <div class="flex flex-col">
                <div class="font-bold text-[10px] uppercase ${titleColor} mb-1 border-b pb-1 border-slate-200 dark:border-slate-700">${title}</div>
                <div class="summary-grid">
                    <div class="summary-row"><span>–ú–µ—Ç–∞</span> <span class="${getCls(data.meta)}">${fmtNum(data.meta)}</span></div>
                    <div class="summary-row"><span>–°–∏–Ω–µ—Ä–≥–∏—è</span> <span class="${getCls(data.synergy)}">${fmtNum(data.synergy)}</span></div>
                    <div class="summary-row"><span>–ö–æ–Ω—Ç—Ä–ø–∏–∫–∏</span> <span class="${getCls(data.counter)}">${fmtNum(data.counter)}</span></div>
                    <div class="summary-row"><span>–°–æ—Å—Ç–∞–≤</span> <span class="${getCls(data.comp)}">${fmtNum(data.comp)}</span></div>
                </div>
                <div class="text-[10px] text-slate-400 mt-2 mb-1">–ê–Ω–∞–ª–∏–∑ (${allFactors.length}):</div>
                <div class="factor-list">
                    ${allFactors.map(f => `
                        <div class="factor-item">
                            <span class="truncate pr-1 ${f.type === 'pos' ? 'text-slate-700 dark:text-slate-300' : 'text-rose-500'}">${f.text}</span>
                            <span class="${f.type === 'pos' ? 'factor-pos' : 'factor-neg'}">${f.type === 'pos' ? '‚ñ≤' : '‚ñº'}</span>
                        </div>
                    `).join('')}
                    ${allFactors.length === 0 ? '<div class="text-slate-300">-</div>' : ''}
                </div>
            </div>
        `};

        dhDraftSummary.innerHTML = `
            <div class="grid grid-cols-2 gap-4 text-xs mt-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                ${renderCol(blue, '–°–∏–Ω–∏–µ', 'text-blue-600')}
                ${renderCol(red, '–ö—Ä–∞—Å–Ω—ã–µ', 'text-red-600')}
            </div>
        `;
    }

    // Existing helper functions below...
    function getFilteredMatchesForHelper() {
        let matches = getCurrentDataSet();
        if (draftState.patch) matches = matches.filter(m => m.patch === draftState.patch);
        return matches;
    }

    function calculateHeroScore(hero, context, targetSide) {
        const { globalStats, enemyTeamStats, allyPicks, enemyPicks, filledRoles } = context;
        let score = 0;
        let reasons = []; 
        
        const C_META = 15;
        const C_PAIR = 5;

        const W_META = 1800;
        const W_SYNERGY = 1400;
        const W_COUNTER = 1300;
        const W_DENIAL = 1000;
        
        const gStat = globalStats.find(s => s.hero === hero);
        if (!gStat) return { score: -9999, reasons: [], stats: null };

        // --- ANTI-NOISE FILTER FOR SUGGESTIONS ---
        // 1. Strict Game Count Filter
        if (gStat.picks < 5) return { score: -9999, reasons: [], stats: null };
        
        // 2. Confidence Multiplier
        let confidence = 1.0;
        if (gStat.picks < 15) confidence = 0.4; // Strong penalty for low sample size

        // 1. Role Penalty
        let dominantRole = null;
        if (gStat.roles) {
            let maxCount = 0;
            Object.entries(gStat.roles).forEach(([r, stats]) => {
                if (stats.picks > maxCount) { maxCount = stats.picks; dominantRole = r; }
            });
            if (dominantRole && filledRoles.has(dominantRole)) {
                score -= 3000; 
            }
        }

        // 2. Meta Score
        const devMeta = getBayesianDeviation(gStat.wins, gStat.picks, C_META);
        score += devMeta * W_META;
        
        const smoothWR = getSmoothedWR(gStat.wins, gStat.picks, C_META);
        const baseStatStr = `Global: ${gStat.picks} –∏–≥—Ä, ${fmtPct(smoothWR*100)} Est. WR`;

        // 3. Synergy
        if (allyPicks.length > 0) {
            allyPicks.forEach(ally => {
                const pairStat = calculateMatchupStats(hero, ally, {patch: draftState.patch}).synergy;
                const dev = getBayesianDeviation(pairStat.wins, pairStat.games, C_PAIR);
                score += dev * W_SYNERGY; 

                const pSmooth = getSmoothedWR(pairStat.wins, pairStat.games, C_PAIR);
                if (pSmooth > 0.53) reasons.push(`<span class="text-emerald-600">–°–∏–Ω–µ—Ä–≥–∏—è —Å ${ally}:</span> ${fmtPct(pSmooth*100)} WR`);
                else if (pSmooth < 0.47) reasons.unshift(`<span class="text-rose-500 font-bold">–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å ${ally}:</span> ${fmtPct(pSmooth*100)} WR`);
            });
        }

        // 4. Counter / Denial
        if (enemyPicks.length > 0) {
            enemyPicks.forEach(enemy => {
                // A. Counter
                const counterStat = calculateMatchupStats(hero, enemy, {patch: draftState.patch}).counter;
                const devCounter = getBayesianDeviation(counterStat.wins, counterStat.games, C_PAIR);
                score += devCounter * W_COUNTER; 

                const cSmooth = getSmoothedWR(counterStat.wins, counterStat.games, C_PAIR);
                if (cSmooth > 0.53) reasons.push(`<span class="text-blue-600">–ö–æ–Ω—Ç—Ä–∏—Ç ${enemy}:</span> ${fmtPct(cSmooth*100)} WR`);
                else if (cSmooth < 0.46) reasons.push(`<span class="text-rose-500">–°–ª–∞–± –ø—Ä–æ—Ç–∏–≤ ${enemy}:</span> ${fmtPct(cSmooth*100)} WR`);
                
                // B. Denial
                const synergyStat = calculateMatchupStats(hero, enemy, {patch: draftState.patch}).synergy;
                const devSynergy = getBayesianDeviation(synergyStat.wins, synergyStat.games, C_PAIR);
                
                if (devSynergy > 0.05) { 
                    score += devSynergy * W_DENIAL;
                    const sSmooth = getSmoothedWR(synergyStat.wins, synergyStat.games, C_PAIR);
                    reasons.push(`<span class="text-amber-600">Denial (–õ–æ–º–∞–µ–º –∫–æ–º–±–æ ${enemy}):</span> ${fmtPct(sSmooth*100)} WR`);
                }
            });
        }

        // 5. Enemy Comfort
        if (enemyTeamStats) {
            const eStat = enemyTeamStats.find(s => s.hero === hero);
            if (eStat) {
                const eDev = getBayesianDeviation(eStat.wins, eStat.picks, 5); 
                if (eDev > 0.05) {
                    score += 1000; 
                    reasons.push(`<span class="text-amber-600">–ú–µ–π–Ω –≤—Ä–∞–≥–∞ (Pick to Deny):</span> ${eStat.picks} –∏–≥—Ä`);
                }
            }
        }
        
        // Apply Confidence Penalty
        score *= confidence;

        return { score, reasons, globalStat: baseStatStr, rawWr: gStat.wins/gStat.picks, picks: gStat.picks };
    }

    function calculateBanScore(hero, context) {
        const { globalStats, enemyTeamStats, allyPicks, enemyPicks } = context;
        let score = 0;
        let reasons = [];
        const C_PAIR = 5;

        // 1. Enemy Comfort
        if (enemyTeamStats) {
            const eStat = enemyTeamStats.find(s => s.hero === hero);
            if (eStat) {
                const eDev = getBayesianDeviation(eStat.wins, eStat.picks, 5);
                if (eDev > 0) {
                    score += eDev * 3000; 
                    const sm = getSmoothedWR(eStat.wins, eStat.picks, 5);
                    if (sm > 0.5) reasons.push(`<span class="text-rose-600">–ú–µ–π–Ω –≤—Ä–∞–≥–∞:</span> ${eStat.picks} –∏–≥—Ä, ${fmtPct(sm*100)} WR`);
                }
            }
        }

        // 2. Enemy Synergy
        if (enemyPicks.length > 0) {
            enemyPicks.forEach(enemy => {
                const pairStat = calculateMatchupStats(enemy, hero, {patch: draftState.patch}).synergy;
                const dev = getBayesianDeviation(pairStat.wins, pairStat.games, C_PAIR);
                if (dev > 0.03) {
                    score += dev * 1500;
                    const sm = getSmoothedWR(pairStat.wins, pairStat.games, C_PAIR);
                    reasons.push(`<span class="text-amber-600">–ö–æ–º–±–æ –∫ ${enemy}:</span> ${fmtPct(sm*100)} WR`);
                }
            });
        }

        // 3. Protect Our Team
        if (allyPicks.length > 0) {
            allyPicks.forEach(ally => {
                const counterStat = calculateMatchupStats(hero, ally, {patch: draftState.patch}).counter; 
                const dev = getBayesianDeviation(counterStat.wins, counterStat.games, C_PAIR);
                if (dev > 0.03) { 
                     score += dev * 1200;
                     const sm = getSmoothedWR(counterStat.wins, counterStat.games, C_PAIR);
                     reasons.push(`<span class="text-indigo-600">–ö–æ–Ω—Ç—Ä–∏—Ç –Ω–∞—à–µ–≥–æ ${ally}:</span> ${fmtPct(sm*100)} WR`);
                }
            });
        }
        
        // 4. Meta Ban
        const gStat = globalStats.find(s => s.hero === hero);
        if (gStat && gStat.bans > 5) {
            score += Math.log(gStat.bans) * 50; 
            if (reasons.length === 0) reasons.push(`–ú–µ—Ç–∞ –±–∞–Ω: ${gStat.bans} –±–∞–Ω–æ–≤`);
        }

        return { score, reasons };
    }

    function showHeroPreview(heroName) {
        if (!draftState.activeSlot) return;
        const { team, type } = draftState.activeSlot;
        
        const matches = getFilteredMatchesForHelper();
        const globalStats = aggregate(matches, {});
        const allyPicks = (team === 'blue' ? draftState.blue.picks : draftState.red.picks).map(getHero).filter(Boolean);
        const enemyPicks = (team === 'blue' ? draftState.red.picks : draftState.blue.picks).map(getHero).filter(Boolean);
        const teamPicksObj = (team === 'blue' ? draftState.blue.picks : draftState.red.picks);
        const filledRoles = new Set(teamPicksObj.map(getRole).filter(Boolean));
        
        let enemyTeamStats = null;
        if (draftState.enemyTeam) {
             const enemyMatches = matches.filter(m => m.blue.team === draftState.enemyTeam || m.red.team === draftState.enemyTeam);
             enemyTeamStats = aggregate(enemyMatches, { team: draftState.enemyTeam });
        }

        let item = null;
        if (type === 'ban') {
            const analysis = calculateBanScore(heroName, { globalStats, enemyTeamStats, allyPicks, enemyPicks });
            item = { hero: heroName, details: analysis.reasons };
        } else {
            const analysis = calculateHeroScore(heroName, { globalStats, enemyTeamStats, allyPicks, enemyPicks, filledRoles }, team);
            item = { hero: heroName, details: analysis.reasons.length ? analysis.reasons : [analysis.globalStat || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'] };
        }

        renderCardList(dhPreviewResult, [item], type);
    }

    function updateDraftSuggestions() {
        if (!draftState.activeSlot) return;

        dhEmptyState.classList.add('hidden');
        dhSuggestionsContainer.classList.remove('hidden');
        
        dhPreviewResult.innerHTML = '';
        dhPreviewInput.value = '';

        const { team, type } = draftState.activeSlot;
        const mySide = draftState.mySide;
        const isMyTurn = team === mySide;
        const enemyTeamName = draftState.enemyTeam;
        
        dhSuggestBans.classList.add('hidden');
        dhEnemyComfort.classList.add('hidden');
        dhSuggestPicks.classList.add('hidden');
        dhEnemyCounters.classList.add('hidden');

        dhStatusText.textContent = isMyTurn ? 
             (type === 'ban' ? "–°–æ–≤–µ—Ç–Ω–∏–∫: –ö–æ–≥–æ –∑–∞–±–∞–Ω–∏—Ç—å?" : "–°–æ–≤–µ—Ç–Ω–∏–∫: –ö–æ–≥–æ –ø–∏–∫–Ω—É—Ç—å?") :
             (type === 'ban' ? "–í—Ä–∞–≥ –¥—É–º–∞–µ—Ç –Ω–∞–¥ –±–∞–Ω–æ–º..." : "–í—Ä–∞–≥ –≤—ã–±–∏—Ä–∞–µ—Ç –≥–µ—Ä–æ—è...");

        const usedHeroes = new Set([
            ...draftState.blue.bans, ...draftState.blue.picks.map(getHero),
            ...draftState.red.bans, ...draftState.red.picks.map(getHero)
        ].filter(Boolean));

        const matches = getFilteredMatchesForHelper();
        const globalStats = aggregate(matches, {});
        
        const allyPicks = (team === 'blue' ? draftState.blue.picks : draftState.red.picks).map(getHero).filter(Boolean);
        const enemyPicks = (team === 'blue' ? draftState.red.picks : draftState.blue.picks).map(getHero).filter(Boolean);
        
        const teamPicksObj = (team === 'blue' ? draftState.blue.picks : draftState.red.picks);
        const filledRoles = new Set(teamPicksObj.map(getRole).filter(Boolean));

        let enemyTeamStats = null;
        if (enemyTeamName) {
             const enemyMatches = matches.filter(m => m.blue.team === enemyTeamName || m.red.team === enemyTeamName);
             enemyTeamStats = aggregate(enemyMatches, { team: enemyTeamName });
        }

        if (type === 'ban') {
             dhSuggestBans.classList.remove('hidden');
             let banCandidates = globalStats
                .filter(s => !usedHeroes.has(s.hero))
                .map(s => {
                    const analysis = calculateBanScore(s.hero, {
                        globalStats, enemyTeamStats, allyPicks, enemyPicks
                    });
                    return { hero: s.hero, score: analysis.score, reasons: analysis.reasons };
                })
                .filter(x => x.score > 0)
                .sort((a,b) => b.score - a.score);
             renderCardList(dhListBans, banCandidates.slice(0, 6), 'ban');

        } else if (type === 'pick') {
             if (isMyTurn) {
                 dhSuggestPicks.classList.remove('hidden');
                 
                 let candidates = globalStats
                    .filter(s => !usedHeroes.has(s.hero)) 
                    .filter(s => s.picks >= 5) // HARD FILTER NOISE HERE
                    .map(c => {
                         const analysis = calculateHeroScore(c.hero, {
                             globalStats, enemyTeamStats, allyPicks, enemyPicks, filledRoles
                         }, team);
                         return { 
                             hero: c.hero, 
                             score: analysis.score, 
                             reasons: analysis.reasons, 
                             globalStat: analysis.globalStat,
                             roles: c.roles // Pass role data for filtering
                         };
                    });

                 // Apply Role Filter
                 if (draftState.roleFilter) {
                     candidates = candidates.filter(s => {
                         return s.roles && s.roles[draftState.roleFilter] && s.roles[draftState.roleFilter].picks > 0;
                     });
                 }

                 candidates.sort((a,b) => b.score - a.score);
                 const topPicks = candidates.slice(0, 10).map(c => ({
                     hero: c.hero,
                     details: c.reasons.length > 0 ? c.reasons : [c.globalStat]
                 }));
                 renderCardList(dhListPicks, topPicks, 'pick');
                 
                 // Show Counters Logic (Only if high confidence)
                 if (allyPicks.length > 0) {
                     dhEnemyCounters.classList.remove('hidden');
                     let threats = globalStats.filter(s => !usedHeroes.has(s.hero)).map(c => {
                         let threatScore = 0;
                         let reasons = [];
                         allyPicks.forEach(ally => {
                             const pair = calculateMatchupStats(c.hero, ally, {patch: draftState.patch}).counter;
                             const dev = getBayesianDeviation(pair.wins, pair.games, 7);
                             if(dev > 0.05) {
                                 threatScore += dev;
                                 const sm = getSmoothedWR(pair.wins, pair.games, 7);
                                 reasons.push(`–ö–æ–Ω—Ç—Ä–∏—Ç ${ally} (${fmtPct(sm*100)} WR)`);
                             }
                         });
                         return { hero: c.hero, threatScore, details: reasons, roles: c.roles };
                     }).filter(x => x.threatScore > 0).sort((a,b) => b.threatScore - a.threatScore);
                     
                     // Apply Role Filter to Counters too
                     if (draftState.roleFilter) {
                         threats = threats.filter(s => {
                             // Use aggregate stats logic to find if hero has played this role
                             // Since 'c.roles' might be missing here, re-fetch or assume valid if in globalStats
                             // But wait, 'threats' are generated from globalStats. Let's ensure 'c' has roles
                             // Actually, in the map above, 'c' is just the hero name from globalStats filter.
                             // Need to attach roles from globalStats
                             const stats = globalStats.find(g => g.hero === s.hero);
                             return stats && stats.roles && stats.roles[draftState.roleFilter] && stats.roles[draftState.roleFilter].picks > 0;
                         });
                     }

                     renderCardList(dhListCounters, threats.slice(0, 5), 'pick');
                 }

             } else {
                 dhEnemyComfort.classList.remove('hidden');
                 
                 let enemyLikelyPicks = globalStats
                    .filter(s => !usedHeroes.has(s.hero))
                    .map(c => {
                         const analysis = calculateHeroScore(c.hero, {
                             globalStats, 
                             enemyTeamStats, 
                             allyPicks: allyPicks, 
                             enemyPicks: enemyPicks, 
                             filledRoles: new Set() 
                         }, team);
                         
                         return {
                             hero: c.hero,
                             score: analysis.score,
                             reasons: analysis.reasons,
                             globalStat: analysis.globalStat
                         };
                    })
                    .sort((a,b) => b.score - a.score);

                 const topLikely = enemyLikelyPicks.slice(0, 8).map(c => ({
                     hero: c.hero,
                     details: c.reasons.length > 0 ? c.reasons : [c.globalStat]
                 }));
                 
                 dhListEnemyComfort.innerHTML = ''; 
                 dhEnemyComfort.querySelector('h4').textContent = "–í—Ä–∞–≥ –º–æ–∂–µ—Ç –≤–∑—è—Ç—å (–ü—Ä–æ–≥–Ω–æ–∑):";
                 renderCardList(dhListEnemyComfort, topLikely, 'pick');
             }
        }
    }

    function renderCardList(container, list, type) {
        if (list.length === 0) {
            container.innerHTML = '<div class="text-xs text-slate-400 italic">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        container.innerHTML = list.map(item => {
            const lines = item.details || item.reasons || [];
            return `
            <div class="suggestion-card flex items-start justify-between p-2 rounded-lg border border-slate-100 bg-slate-50 cursor-pointer hover:bg-white hover:shadow-sm" onclick="applyDraftSuggestion('${item.hero}')">
               <div class="flex items-start gap-2 overflow-hidden">
                  <img src="${heroImg(item.hero)}" class="w-9 h-9 rounded-md object-cover shrink-0">
                  <div class="min-w-0">
                     <div class="font-bold text-sm leading-tight truncate">${item.hero}</div>
                     <div class="suggestion-reason mt-1">
                        ${lines.map(line => `<div class="text-[10px] text-slate-600 leading-tight truncate bg-slate-100 rounded px-1 py-0.5 inline-block mb-0.5">${line}</div>`).join('')}
                     </div>
                  </div>
               </div>
               <div class="text-right shrink-0 ml-2">
                  ${type === 'ban' ? 
                    `<span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded">BAN</span>` : 
                    `<span class="text-[10px] font-bold text-emerald-500 bg-emerald-50 px-1.5 py-0.5 rounded">PICK</span>`
                  }
               </div>
            </div>
        `}).join('');
    }

    window.applyDraftSuggestion = (heroName) => {
        if (!draftState.activeSlot) return;
        const {team, type, index} = draftState.activeSlot;
        if (type === 'ban') {
            draftState[team].bans[index] = heroName;
        } else {
            draftState[team].picks[index] = { hero: heroName, role: null };
        }
        renderDraftHelperBoard();
        updateDraftSuggestions();
    };

    function topN(map,n,{best=true,minGames=5}={}){ const arr=[...map.entries()].map(([name,o])=>({name, games:o.games, wins:o.wins, wr:o.games?o.wins*100/o.games:0})).filter(x=>x.games>=minGames).sort((a,b)=> best? (b.wr-a.wr||b.games-a.games):(a.wr-b.wr||b.games-a.games)); return arr.slice(0,n); }
    function calcTeamStatsForHero(hero, matches) { const teamStats = new Map(); function processTeam(team, isWin) { if (!teamStats.has(team)) { teamStats.set(team, { games: 0, wins: 0 }); } const stats = teamStats.get(team); stats.games++; if (isWin) { stats.wins++; } } matches.forEach(m => { if (m.blue.picks.some(p => p.hero === hero)) { processTeam(m.blue.team, m.winner === 'blue'); } if (m.red.picks.some(p => p.hero === hero)) { processTeam(m.red.team, m.winner === 'red'); } }); return Array.from(teamStats.entries()).map(([team, stats]) => ({ name: team, games: stats.games, wins: stats.wins, wr: pct(stats.wins, stats.games) })).sort((a, b) => b.games - a.games || b.wr - a.wr); }
    function calcHeroDetails(hero, matches, filters = {}){ const d={hero, picks:0,wins:0,losses:0,bans:0, roles:new Map(), synergy:new Map(), vs:new Map(), draft:{pick:new Map(),ban:new Map()}, terrains:{}}; const targetTeam = filters.team || null; function inc(map,key,win){ if(!map.has(key)) map.set(key,{games:0,wins:0}); const o=map.get(key); o.games++; if(win) o.wins++; } matches.forEach(m => { const winBlue = m.winner === 'blue'; const bluePicksHero = m.blue.picks.some(p => p.hero === hero); const redPicksHero = m.red.picks.some(p => p.hero === hero); if (bluePicksHero && (!targetTeam || m.blue.team === targetTeam)) { d.picks++; if (winBlue) d.wins++; else d.losses++; const pick = m.blue.picks.find(p => p.hero === hero); if (pick.role) { const rs = d.roles.get(pick.role) || {games:0,wins:0}; rs.games++; if (winBlue) rs.wins++; d.roles.set(pick.role, rs); } d.draft.pick.set(`B${pick.order}`,(d.draft.pick.get(`B${pick.order}`)||0)+1); } if (redPicksHero && (!targetTeam || m.red.team === targetTeam)) { d.picks++; if (!winBlue) d.wins++; else d.losses++; const pick = m.red.picks.find(p => p.hero === hero); if (pick.role) { const rs = d.roles.get(pick.role) || {games:0,wins:0}; rs.games++; if (!winBlue) rs.wins++; d.roles.set(pick.role, rs); } d.draft.pick.set(`R${pick.order}`,(d.draft.pick.get(`R${pick.order}`)||0)+1); } if (!targetTeam || m.blue.team === targetTeam) { m.blue.bans.forEach(b => { if(b.hero === hero){ d.bans++; d.draft.ban.set(`B${b.order}`,(d.draft.ban.get(`B${b.order}`)||0)+1);} }); } if (!targetTeam || m.red.team === targetTeam) { m.red.bans.forEach(b => { if(b.hero === hero){ d.bans++; d.draft.ban.set(`R${b.order}`,(d.draft.ban.get(`R${b.order}`)||0)+1);} }); } if (bluePicksHero && (!targetTeam || m.blue.team === targetTeam)) { m.blue.picks.filter(x => x.hero !== hero).forEach(a => inc(d.synergy, a.hero, winBlue)); m.red.picks.forEach(e => inc(d.vs, e.hero, winBlue)); } if (redPicksHero && (!targetTeam || m.red.team === targetTeam)) { m.red.picks.filter(x => x.hero !== hero).forEach(a => inc(d.synergy, a.hero, !winBlue)); m.blue.picks.forEach(e => inc(d.vs, e.hero, !winBlue)); } if (m.terrain) { if (!d.terrains[m.terrain]) { d.terrains[m.terrain] = { picks: 0, wins: 0 }; } const terrainStats = d.terrains[m.terrain]; if (m.blue.picks.some(p => p.hero === hero) && (!targetTeam || m.blue.team === targetTeam)) { terrainStats.picks++; if (m.winner === 'blue') terrainStats.wins++; } if (m.red.picks.some(p => p.hero === hero) && (!targetTeam || m.red.team === targetTeam)) { terrainStats.picks++; if (m.winner === 'red') terrainStats.wins++; } } }); return d; }
    function renderKV(items){ if(!items || !items.length) return '<div class="text-slate-500 text-xs">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω. 5 –∏–≥—Ä)</div>'; return items.map(x=>`<div class='flex items-center justify-between gap-2'><div class='flex items-center gap-2 min-w-0'><img src='${heroImg(x.name)}' class='inline-preview'/><div class='truncate'>${x.name}</div></div><div class='text-right text-slate-600 whitespace-nowrap'>${x.games} –∏–≥—Ä ‚Ä¢ ${x.wins}W ‚Ä¢ ${fmtPct(x.wr)}</div></div>`).join(''); }
    function renderDraft(map,title){ const order=['B1','B2','B3','B4','B5','R1','R2','R3','R4','R5']; return `<div><div class='font-medium mb-1'>${title}</div><div class='grid grid-cols-5 gap-1 text-sm'>${order.map(k=>`<div class='px-2 py-1 rounded-lg bg-white ring-1 ring-slate-200 text-center'><div class='text-[10px] text-slate-500'>${k}</div><div>${map.get(k)||0}</div></div>`).join('')}</div></div>`; }
    function openHeroModal(hero, matches, filters){ const d=calcHeroDetails(hero, matches, filters); const wr = d.picks? fmtPct(pct(d.wins,d.picks)):'‚Äî'; document.getElementById('modalHeroName').innerHTML = `<div class='flex items-center gap-2'><img src='${heroImg(hero)}' class='inline-preview'/> <span>${hero}</span></div>`; document.getElementById('modalHeroSubtitle').textContent = `–ò–≥—Ä—ã: ${d.picks} ‚Ä¢ –ü–æ–±–µ–¥—ã: ${d.wins} ‚Ä¢ –ü–æ—Ä–∞–∂–µ–Ω–∏—è: ${d.losses} ‚Ä¢ –í–∏–Ω—Ä–µ–π—Ç: ${wr} ‚Ä¢ –ë–∞–Ω—ã: ${d.bans}`; document.getElementById('modalSummary').innerHTML = `<div class='space-y-1'><div class='flex items-center justify-between'><span>–ò–≥—Ä</span><span class='font-medium'>${d.picks}</span></div><div class='flex items-center justify-between'><span>–ü–æ–±–µ–¥—ã</span><span class='font-medium'>${d.wins}</span></div><div class='flex items-center justify-between'><span>–ü–æ—Ä–∞–∂–µ–Ω–∏—è</span><span class='font-medium'>${d.losses}</span></div><div class='flex items-center justify-between'><span>–í–∏–Ω—Ä–µ–π—Ç</span><span class='font-medium'>${wr}</span></div><div class='flex items-center justify-between'><span>–ë–∞–Ω—ã</span><span class='font-medium'>${d.bans}</span></div><div class='flex items-center justify-between'><span>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</span><span class='font-medium'>${d.picks + d.bans}</span></div></div>`; const rolesOrder=['exp','jungle','mid','roam','gold']; const labels={exp:'EXP',jungle:'Jungle',mid:'Mid',roam:'Roam',gold:'Gold'}; document.getElementById('modalRoles').innerHTML = rolesOrder.map(r=>{ const rs=d.roles.get(r)||{games:0,wins:0}; const wr= rs.games? fmtPct(pct(rs.wins,rs.games)):'‚Äî'; return `<div class='rounded-lg bg-white ring-1 ring-slate-200 p-3'><div class='text-xs text-slate-500'>${labels[r]}</div><div class='mt-1 text-sm'>${rs.games} –∏–≥—Ä ‚Ä¢ ${rs.wins}W/${rs.games-rs.wins}L ‚Ä¢ ${wr}</div></div>`; }).join(''); document.getElementById('modalSynergy').innerHTML = renderKV(topN(d.synergy,10,{best:true})); document.getElementById('modalBestVs').innerHTML = renderKV(topN(d.vs,5,{best:true})); document.getElementById('modalWorstVs').innerHTML = renderKV(topN(d.vs,5,{best:false})); document.getElementById('modalDraftPositions').innerHTML = `${renderDraft(d.draft.pick,'–ü–∏–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É')}${renderDraft(d.draft.ban,'–ë–∞–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É')}`; const teamStats = calcTeamStatsForHero(hero, matches); const modalTeamsEl = document.getElementById('modalTeams'); if (teamStats.length > 0) { modalTeamsEl.innerHTML = teamStats.map(team => `<div class='flex items-center justify-between gap-2'><div class='truncate'>${team.name}</div><div class='text-right text-slate-600 whitespace-nowrap'>${team.games} –∏–≥—Ä ‚Ä¢ ${team.wins}W ‚Ä¢ ${fmtPct(team.wr)}</div></div>`).join(''); } else { modalTeamsEl.innerHTML = '<div class="text-slate-500 text-xs">–≠—Ç–æ–≥–æ –≥–µ—Ä–æ—è –Ω–µ –ø–∏–∫–∞–ª–∏ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–∞—Ö.</div>'; } const modalTerrainsEl = document.getElementById('modalTerrains'); const terrainLabels = { '—Å—Ç–µ–Ω—ã': '–°—Ç–µ–Ω—ã', '–æ–±–ª–∞–∫–∞': '–û–±–ª–∞–∫–∞', '—Ä–µ–∫–∞': '–†–µ–∫–∞', '–∫—É—Å—Ç—ã': '–ö—É—Å—Ç—ã' }; let terrainsHTML = Object.entries(terrainLabels).map(([key, label]) => { const stats = d.terrains[key] || { picks: 0, wins: 0 }; const wr = stats.picks > 0 ? fmtPct(pct(stats.wins, stats.picks)) : '‚Äî'; return `<div class='rounded-lg bg-white ring-1 ring-slate-200 p-3'><div class='text-xs text-slate-500'>${label}</div><div class='mt-1 text-sm'>${stats.picks} –∏–≥—Ä ‚Ä¢ ${wr}</div></div>`; }).join(''); modalTerrainsEl.innerHTML = terrainsHTML || '<div class="text-slate-500 text-xs">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ä—Ç–∞–º.</div>'; heroModal.classList.remove('hidden'); }
    function refreshUI() { 
        if (currentUser && (currentUserRole === 'admin' || currentUserRole === 'viewer')) { 
            const currentTab = document.querySelector('.tab-btn.bg-slate-900').dataset.tab;
            rebuildFiltersAndStats(getCurrentDataSet()); 
            if (currentTab === 'matchups') renderMatchups();
            if (currentTab === 'team-analysis') renderTeamAnalysis();
            if (currentTab === 'draft-helper') {
                 const f = collectFilters(getCurrentDataSet());
                 dhEnemyTeam.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ --</option>' + f.teams.filter(t=>t !== '–í—Å–µ').map(v=>`<option value='${v}'>${v}</option>`).join('');
                 dhFilterPatch.innerHTML = '<option value="">-- –í—Å–µ –ø–∞—Ç—á–∏ --</option>' + f.patches.filter(t=>t !== '–í—Å–µ').map(v=>`<option value='${v}'>${v}</option>`).join('');
                 renderDraftHelperBoard();
            }
        } 
    }
  });
  </script>
</body>
</html>